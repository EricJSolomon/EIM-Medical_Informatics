USE [EricDB]
GO
/****** Object:  StoredProcedure [dbo].[sp_DARR]    Script Date: 9/30/2020 1:26:57 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- ========================================================================================================
-- Author:		Sheila Regan
-- Create date: 9/1/2016
-- Description:	Base data for DARR report in SSRS
-- ========================================================================================================
ALTER PROCEDURE [dbo].[sp_DARR] as

--Get Receipt Dates from Attribute
if object_id('tempdb..#c1') is not null drop table #c1 
select distinct q.dbname, thevalue, ra.referralid, q.description, thegroup , x.Product, x.NF_401, r.authorizationid, r.servicecode, x.planname
into #c1 
from stage.dbo.referralattribute ra join stage.dbo.qattribute q on q.attributeid = ra.attributeid and q.dbname = ra.dbname 
join stage.dbo.referral r on r.referralid = ra.referralid and r.dbname = ra.dbname 
join stage.dbo.enrollkeys ek on ek.enrollid = r.enrollid and ek.dbname = r.dbname and ek.segtype = 'int' and ek.effdate < ek.termdate
join stage.dbo.benefitplan bp on bp.planid = ek.planid and bp.dbname = ek.dbname 
join sheiladb.dbo.planx x on bp.planid = x.planid and bp.programid = x.programid and bp.dbname = x.dbname and x.SSRS = 'DARR'
where q.description in ('Auth Receipt Date') and year(ra.createdate) >= year(getdate())-2
delete from #c1 where thevalue = ''  or thevalue='MM/DD/YYY' or thevalue like '%.%' or thevalue like '%:%' or thevalue like '%,%' or sheiladb.dbo.fn_IsDate(thevalue)=0
update #c1 set thevalue = cast(thevalue as date)
if object_id('tempdb..#c2') is not null drop table #c2 select min(thevalue) thevalue, referralid, dbname, thegroup, Product, NF_401 
	into #c2 from #c1 group by referralid, dbname, thegroup, product, NF_401

--Valid Auth Receipt Dates for CMS auths
if object_id('tempdb..#ar1') is not null drop table #ar1
select distinct r.referralid, r.dbname,mp.planname, TheValue Auth_Receipt_date, TheGroup, servicecode, r.authorizationid
, cast(r.receiptdate as date) Receipt_Date, cast(r.referraldate as date) Referral_Date, cast(r.createdate as date) Create_Date
, mp.Product, mp.NF_401
into #ar1 from stage.dbo.referral r (nolock)
join stage.dbo.enrollkeys ek on ek.enrollid = r.enrollid and ek.segtype = 'int' and ek.effdate < ek.termdate and ek.dbname = r.dbname
join sheiladb.dbo.planx mp on mp.dbname = ek.dbname and mp.planid = ek.planid and mp.SSRS = 'DARR'
left join #c2 ra on ra.referralid = r.referralid and ra.dbname = r.dbname
where year(r.createdate) >= year(getdate())-2
update #ar1 set Receipt_Date = case when Receipt_Date in ('2078-12-31','1900-01-01') then null else Receipt_Date end
update #ar1 set Referral_Date = case when Referral_Date in ('2078-12-31','1900-01-01') then null else Referral_Date end

--Meets Report Baseline Date Range & Identifies Inclusion Date
if object_id('sheiladb.dbo.DARR_BaseDate') is not null drop table sheiladb.dbo.DARR_BaseDate 
select *, isnull(Auth_Receipt_date, isnull(Receipt_Date,isnull(Referral_Date,isnull(Create_Date,null)))) Anchor_Date
into sheiladb.dbo.DARR_BaseDate from #ar1 (nolock)

delete from sheiladb.dbo.DARR_BaseDate where servicecode in ('*100','200','360','401','4011'
,'1015','1016','1025','1026','1027','1028','1029','1030','1034','1035','1036','1037','1041','1042','1051','1052','1053','1054','1057','1058','1094','1096'
,'1117','1118','1119','1125','1126','1127','1128','1132','1133','1136','1144','1145','1192'
,'1209','1210','PN')
--delete from sheiladb.dbo.DARR_BaseDate where servicecode = '270' and dbname <> 'sc'
delete from sheiladb.dbo.DARR_BaseDate where servicecode in ('130') and planname in ('SC','UT')
delete from sheiladb.dbo.DARR_BaseDate where (authorizationid like 'IP%' or authorizationid like '%IP' or authorizationid like 'OP%' or authorizationid like '%OP' 
or authorizationid like 'AL%' or authorizationid like '%AL' or authorizationid like 'APL%' or authorizationid like '%APL' )

if object_id('tempdb..#x1') is not null drop table #x1 
select distinct b.referralid, b.dbname, ra.thegroup, description, thevalue 
into #x1 from stage.dbo.referralattribute ra join stage.dbo.qattribute q on q.attributeid = ra.attributeid and q.dbname = ra.dbname
join sheiladb.dbo.darr_basedate b on b.referralid = ra.referralid and b.dbname = ra.dbname
where description = 'Appeal Decision Date'
delete from #x1 where thevalue = ''  or thevalue='MM/DD/YYY' or thevalue like '%.%' or thevalue like '%:%' or thevalue like '%,%' or sheiladb.dbo.fn_IsDate(thevalue)=0
update #x1 set thevalue = cast(thevalue as date)

if object_id('sheiladb.dbo.DARR_CMSAuths2') is not null drop table sheiladb.dbo.DARR_CMSAuths2
select distinct r.createid,r.userid,r.servicecode,rtrim(ac.description) Auth_Template,r.authstatus,r.memid,r.enrollid,r.acuity
,case when ac.AuthType in ('Inpatient') then 'Inpatient' else 'Outpatient' end Authtype
,receiptdate = case 
	when r.dbname='IL' and r.createdate >= '2019-11-03' and r.createdate <= '2020-03-07' and r.createid <> 'ePortal' then dateadd(hh,-8,r.utcreceiptdate) 
	when r.dbname='IL' and r.createdate > '2019-10-04' and r.createid <> 'ePortal' then dateadd(hh,-7,r.utcreceiptdate) 
	else r.receiptdate end
,r.effdate,r.termdate,r.referralid,r.authorizationid,mp.dbname,r.self, r.Appeal 
, Appeal_Outcome = case when o1.dbname is not null then 'OVERTURNED' when o2.dbname is not null then 'PARTIAL OVERTURN' when o3.dbname is not null then 'UPHELD'
else r.appealoutcome end
, Appeal_Outcome_Attr_Overturn = case when o1.dbname is null and o2.dbname is null then 0 else 1 end
, case when x1.appeal_dec_date is not null then x1.appeal_dec_date else r.appealdate end as Appeal_date
,r.appealdate,x1.appeal_dec_date
,bp.description lob
, mp.planname, lobname = mp.product, mp.cmscontract cmscontractid, mp.CMSPlan_No
, rtrim(q1.lastname) +', '+rtrim(q1.firstname) Create_By, rtrim(q.lastname) +', '+rtrim(q.firstname) Assigned_To, cm.Assign_CM_Fullname
,r.referfrom,r.referto,r.createdate, r.referraldate,ek.carriermemid,m.headofhouse,bp.planid,bp.description BenefitPlan
, acty_grp = case when r.acuity = 'Elective' then 'Standard' when r.acuity = 'Urgent' then 'Expedited' else r.acuity end
, compliance_acuity = case when r.acuity in ('Elective','Urgent','Emergency') then 'Y' else 'N' end
, rpt = 'NA', ProcCat = 'XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX' 
, ShortCat = 'XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX'
, Retro_Type = case when rr.referralid is not null then 'Y' else ' ' end
, AImaging_Type = case when c.referralid is not null then 'Y' else ' ' end
, IP_Type = case when r.acuity = 'Emergency' then 'Y' else ' ' end
, PA_Type = case when r.acuity <> 'Emergency' and c.referralid is null then 'Y' when r.servicecode in ('400','402','403','4020') then 'Y' else ' ' end
, AImaging_Cat = case when c.ProcCat is not null then c.ProcCat end
, IP_Cat = case when ipc.ProcCat is not null then ipc.ProcCat end
, PA_Cat = case when pac.ProcCat is not null then pac.ProcCat end
, eviCore = case when ev.referralid is not null then 'Y' when r.authorizationid like 'EV%' and r.createdate > '2019-12-13' and r.dbname in ('MA','MI','IL','OH','WI') then 'Y'
		when r.authorizationid like 'A%' and r.authorizationid not like '%APL%' and r.createdate > '2019-12-13' and r.dbname in ('MA','MI','IL','OH','WI') then 'Y'
		else '' end
,'  'atrtyp
,case when pn.referralid is not null then 'Y' else ' ' end as Pend_Service, IPA = rtrim(ipa.ipa)
, Partial = 'N'
, Effective_Denial = 'N'
, Anchor_Date
into sheiladb.dbo.DARR_CMSAuths2 from stage.dbo.referral r 
join sheiladb.dbo.DARR_BaseDate dbd on dbd.referralid = r.referralid and dbd.dbname = r.dbname --date constraint
join stage.dbo.enrollkeys ek on ek.enrollid = r.enrollid and ek.dbname = r.dbname and ek.effdate < ek.termdate and ek.segtype = 'int'
join stage.dbo.benefitplan bp on bp.planid = ek.planid and bp.dbname = ek.dbname 
join stage.dbo.member m on m.memid = r.memid and m.dbname = r.dbname
join sheiladb.dbo.planx mp on mp.planid = ek.planid and mp.dbname = ek.dbname and mp.SSRS = 'DARR'
join stage.dbo.authcode ac on ac.codeid = r.servicecode and ac.dbname = r.dbname 
join stage.dbo.authservice aus on aus.referralid = r.referralid and aus.dbname = r.dbname
left join (select distinct referralid, dbname, cast(min(thevalue) as datetime) Appeal_Dec_Date from #x1 group by referralid, dbname) 
	x1 on x1.dbname = r.dbname and x1.referralid = r.referralid
left join (select distinct referralid, ra.dbname from stage.dbo.referralattribute ra 
	join stage.dbo.qattribute q on q.attributeid = ra.attributeid and ra.dbname = q.dbname where description = 'Appeal Outcome - Overturn') o1
	on o1.dbname = r.dbname and o1.referralid = r.referralid
left join (select distinct referralid, ra.dbname from stage.dbo.referralattribute ra 
	join stage.dbo.qattribute q on q.attributeid = ra.attributeid and ra.dbname = q.dbname where description = 'Appeal Outcome - Partial Overturn') o2 
	on o2.dbname = r.dbname and o2.referralid = r.referralid
left join (select distinct referralid, ra.dbname from stage.dbo.referralattribute ra 
	join stage.dbo.qattribute q on q.attributeid = ra.attributeid and ra.dbname = q.dbname where description = 'Appeal Outcome - Upheld') o3 
	on o2.dbname = r.dbname and o2.referralid = r.referralid
left join (select distinct referralid, ra.dbname from stage.dbo.referralattribute ra join stage.dbo.qattribute q on q.attributeid = ra.attributeid and q.dbname = ra.dbname 
			where thevalue = 'eviCore' and description = 'Auth Source') ev on ev.dbname = r.dbname and ev.referralid = r.referralid
left join (select distinct aus.referralid, aus.dbname from stage.dbo.authservice aus 
	join sheiladb.dbo.darr_basedate bd on bd.referralid = aus.referralid and (bd.dbname = aus.dbname or bd.dbname = 'ID' and aus.dbname = 'UN')
	where status = 'denied') 
	prt on prt.referralid = r.referralid and prt.dbname = r.dbname
left join (select distinct aus.referralid, aus.dbname, aus.status from stage.dbo.authservice aus 
	join sheiladb.dbo.darr_basedate bd on bd.referralid = aus.referralid and (bd.dbname = aus.dbname or bd.dbname = 'ID' and aus.dbname = 'UN')
	where status = 'pend') 
	pn on pn.referralid = r.referralid and pn.dbname = r.dbname
left join stage.dbo.quser q on q.userid=r.userid left join stage.dbo.quser q1 on q1.loginid=r.createid
left join Reports.dbo.MMP_Assigned_CM cm on cm.memid = r.memid collate database_default and cm.planname = mp.planname collate database_default and cm.CM_rn = '1' --Needs fix 
left join sheiladb.dbo.Auth_Code_v2 ipc on ipc.codeid = r.servicecode and (ipc.dbname = r.dbname or ipc.dbname = 'ID' and r.dbname = 'UN')
	and ipc.big_report = 'DARR' and ipc.rpt = 'IP' --IP Category
left join sheiladb.dbo.Auth_Code_v2 pac on pac.codeid = r.servicecode and (pac.dbname = r.dbname or pac.dbname = 'ID' and r.dbname = 'UN')
	and pac.big_report = 'DARR' and pac.rpt = 'PA' --PA Category
left join (select row_number()over (partition by referralid, dbname order by sequence asc) rw, * from --AI Category
				(select distinct r.referralid, r.authorizationid, r.dbname, ProcCat, aus.sequence from stage.dbo.referral r 
				join sheiladb.dbo.DARR_BaseDate bd on bd.referralid = r.referralid and (bd.dbname = r.dbname or bd.dbname = 'ID' and r.dbname = 'UN')
				join stage.dbo.authservice aus on r.referralid = aus.referralid and r.dbname = aus.dbname join stage.dbo.authcode ac on ac.codeid = r.servicecode and ac.dbname = r.dbname
				join sheiladb.dbo.authtat_ai_category c on c.codeid = aus.codeid collate database_default and ac.authtype in ('Ancillary','Outpatient') and r.servicecode = '210' and bd.planname <>'FL'
				union select distinct r.referralid, r.authorizationid, r.dbname, category, aus.sequence from stage.dbo.referral r 
				join sheiladb.dbo.DARR_BaseDate bd on bd.referralid = r.referralid and (bd.dbname = r.dbname or bd.dbname = 'ID' and r.dbname = 'UN')
				join stage.dbo.authservice aus on r.referralid = aus.referralid and r.dbname = aus.dbname join stage.dbo.authcode ac on ac.codeid = r.servicecode and ac.dbname = r.dbname
				join sheiladb.dbo.ai_serv_groups c on c.catid = aus.catid collate DATABASE_default 
					and c.subcatid = aus.subcatid collate DATABASE_default and c.svcgroupid = aus.svcgroupid collate DATABASE_default and aus.codeid = '' and r.servicecode = '210' and bd.planname <>'FL') x)
				c on c.referralid = r.referralid and (c.dbname = r.dbname or (r.dbname = 'UN' and c.dbname in ('MS','NY','ID'))) and c.rw = '1'
left join (select distinct referralid,ra.dbname from stage.dbo.referralattribute ra join stage.dbo.qattribute q on q.attributeid=ra.attributeid and q.dbname=ra.dbname and q.description = 'retro review')
		rr on rr.referralid = r.referralid and r.dbname = rr.dbname
left join (select distinct r.authorizationid, r.referralid, rtrim(p.fullname) IPA, dbname = 'MA' from [DC01Q56ILDSWV01].qnxt_plandata_mapd.dbo.referral r 
	join [DC01Q56ILDSWV01].qnxt_plandata_mapd.dbo.memberpcp pcp on r.enrollid = pcp.enrollid 	and r.effdate <= pcp.termdate and r.effdate >= pcp.effdate 
	join [DC01Q56ILDSWV01].qnxt_plandata_mapd.dbo.affiliation a on a.affiliationid = pcp.paytoaffilid
	join [DC01Q56ILDSWV01].qnxt_plandata_mapd.dbo.provider p on p.provid = a.affiliateid where pcptype = 'pcp' and p.fullname like '%concerto%') IPA
	on ipa.referralid = r.referralid collate database_default and ipa.dbname = r.dbname collate database_default 

delete from sheiladb.dbo.DARR_CMSAuths2 where
createid in ('concerto','MMPAuthLoadILAdmin','AuthLoad','AutoLoad','MMPAuthLoadCAAdmin','OHMMPAuthLoad','PRSpecialAuthLoad','OHMMPAuthLoad','PRAuthLoad','TANFAuthLoadILAdmin'
,'MMPAuthLoadCAAdmin','MMPAuthLoadILAdmin','SPDAuthLoadCAAdmin','WAAuthSplit','AuthSplit','ILAuthAuto','MMC\AUTOSYSPROS','WAAutoLoad','WIAutoLoad','AutoLoad','ILAuthAuto') 
or authstatus in ('closed','void') or userid in ('120172') --concerto assigned to

--Add Report
update sheiladb.dbo.DARR_CMSAuths2 
set rpt = case when Retro_Type = 'Y' then 'RR' when AImaging_Type = 'Y' and acuity = 'Emergency' then 'PA' 
when AImaging_Type = 'Y' then 'AI' when IP_Type = 'Y' then 'IP' when PA_Type = 'Y' then 'PA' else 'PA' end
update sheiladb.dbo.DARR_CMSAuths2 set rpt = 'RR' where receiptdate in ('2078-12-31','1900-01-01') and receiptdate > termdate and authstatus in ('APPROVED','DENIED')
update sheiladb.dbo.DARR_CMSAuths2 set atrtyp = 'RR' where rpt = 'RR' or (receiptdate in ('2078-12-31','1900-01-01') and receiptdate > termdate and authstatus in ('APPROVED','DENIED'))
update sheiladb.dbo.DARR_CMSAuths2 set rpt = 'EV' where eviCore = 'Y'
update sheiladb.dbo.DARR_CMSAuths2
set ProcCat = case
when rpt in ('RR','EV') and (PA_Cat is not null or AImaging_Cat is not null or IP_Cat is not null) then isnull(PA_Cat,isnull(AImaging_Cat,IP_Cat))
when rpt in ('RR','EV') then 'Other'
when rpt = 'AI' and AImaging_Cat is not null then rtrim(AImaging_Cat)
when rpt = 'IP' and IP_Cat is not null then rtrim(IP_Cat)
when rpt = 'PA' and PA_Cat is not null then rtrim(PA_Cat)
when PA_Cat is not null then PA_Cat
else 'Other' end

update sheiladb.dbo.DARR_CMSAuths2
set ShortCat = case when ProcCat = 'Other' then 'Other' else ShortCat end

update sheiladb.dbo.DARR_CMSAuths2
set ShortCat = a.ShortCat
from sheiladb.dbo.DARR_CMSAuths2 z
join sheiladb.dbo.ShortCat a on a.ProcCat = z.ProcCat

if object_id('sheiladb.dbo.DARR_Inclusion') is not null drop table sheiladb.dbo.DARR_Inclusion
select * into sheiladb.dbo.DARR_Inclusion from sheiladb.dbo.DARR_CMSAuths2

--additional exclusions
if object_id('tempdb..#DARR_Exclusions') is not null drop table #DARR_Exclusions
select distinct ra.referralid, o.dbname, xcld_typ = 'attr' 
into #DARR_Exclusions 
from stage.dbo.referralattribute ra join stage.dbo.qattribute q on q.attributeid = ra.attributeid and ra.dbname = q.dbname
join sheiladb.dbo.DARR_Inclusion o on (o.dbname = ra.dbname or o.dbname = 'ID' and ra.dbname = 'UN') and o.referralid = ra.referralid
where q.description in ('Medical Claims Review','Provider Appeal','Claim Workflow','A&D Appeal','CIRT SUCCESSFULL? Yes/No','Claims Workflow','Pharmacy Team')
union 
select distinct a.referralid, a.dbname, xcld_typ = 'coc' 
from sheiladb.dbo.DARR_Inclusion a 
join (select rm.referralid, rm.dbname from stage.dbo.referralmemo rm join stage.dbo.memo m on m.memoid = rm.memoid and m.dbname = rm.dbname
	join sheiladb.dbo.DARR_Inclusion a on a.referralid = rm.referralid and (a.dbname = rm.dbname or a.dbname = 'ID' and rm.dbname = 'UN')
			where m.description like '%coc%' and m.createdate between a.effdate and a.termdate and (source = 'MEMBER' or source = 'refr') ) 
			mo on mo.referralid = a.referralid and (a.dbname = mo.dbname or a.dbname = 'ID' and mo.dbname = 'UN')

-- Delete Exclusions
delete sheiladb.dbo.DARR_inclusion
from sheiladb.dbo.DARR_inclusion t1
join #DARR_Exclusions t2 on t1.referralid = t2.referralid and t1.dbname = t2.dbname

--determine lines status for Partial & appeals
if object_id ('tempdb..#DARR_lines1') is not null drop table #DARR_lines1
select distinct a.referralid, a.authorizationid, a.rpt, a.acuity, a.dbname, a.servicecode, a.Appeal_Outcome, a.appeal,a.appeal_date
, aus.sequence, aus.status, aus.catid, aus.codeid, aus.servcategory
, Del = case when a.servicecode in ('150','190','340','380','1188') and aus.catid <>'' and rpt not in ('RR','IP') then 1 
	when a.servicecode in ('1038','370') and aus.codeid <> '' and rpt not in ('RR','IP') then 1	else 0 end
into #DARR_Lines1
from sheiladb.dbo.DARR_inclusion a
join stage.dbo.authservice aus on a.referralid = aus.referralid and a.dbname = aus.dbname
update a set a.del = 1 
from #DARR_Lines1 a
join (select row_number() over (partition by referralid, dbname order by sequence) as RowNum, * from #DARR_Lines1 
		where servicecode in ('370','1038') and rpt not in ('RR','IP'))
x on a.dbname = x.dbname and a.referralid = x.referralid and a.sequence = x.sequence where x.RowNum <> 1
delete from #DARR_Lines1 where del=1

if object_id('sheiladb.dbo.DARR_Line_Status') is not null drop table sheiladb.dbo.DARR_Line_Status
select distinct x.referralid, x.authorizationid, x.rpt, x.acuity, x.dbname, x.servicecode, x.appeal_outcome, x.appeal, x.appeal_date
, Deny_Serv = case when d.referralid is not null then 1 else 0 end
, Appr_Serv = case when a.referralid is not null then 1 else 0 end
into sheiladb.dbo.DARR_Line_Status 
from #DARR_Lines1 x
left join (select distinct referralid, authorizationid, dbname from #DARR_Lines1 where status = 'DENIED') 
		d on d.dbname = x.dbname and x.referralid = d.referralid
left join (select distinct referralid, authorizationid, dbname from #DARR_Lines1 where status = 'APPROVED') 
		a on a.dbname = x.dbname and x.referralid = a.referralid  

if object_id('sheiladb.dbo.DARR_Appeal_Mod') is not null drop table sheiladb.dbo.DARR_Appeal_Mod
select distinct a.*, x.Deny_Serv, x.Appr_Serv, b.Appeal_ID
, case when a1.referralid is null then 0 else 1 end std_app_attr, case when a2.referralid is null then 0 else 1 end exp_app_attr
, case when d1.referralid is null then 0 else 1 end std_den_attr, case when d2.referralid is null then 0 else 1 end exp_den_attr
into sheiladb.dbo.DARR_Appeal_Mod from sheiladb.dbo.DARR_Inclusion a
left join sheiladb.dbo.DARR_Line_Status x on x.dbname = a.dbname and x.referralid = a.referralid
left join sheiladb.dbo.hcs_appeals b on a.dbname = b.dbname and a.referralid = b.referralid
left join (select distinct referralid, dbname from sheiladb.dbo.DARR_Date where thegroup = 'STANDARD APPROVAL' 
	union select distinct referralid, dbname from sheiladb.dbo.DARR_Time where thegroup = 'STANDARD APPROVAL') a1 --standard approval attr group
	on a1.dbname = a.dbname and a1.referralid = a.referralid
left join (select distinct referralid, dbname from sheiladb.dbo.DARR_Date where thegroup = 'EXPEDITED APPROVAL' 
	union select distinct referralid, dbname from sheiladb.dbo.DARR_Time where thegroup like 'EXPEDITED APPROVAL') a2 --expedited approval attr group
	on a2.dbname = a.dbname and a2.referralid = a.referralid
left join (select distinct referralid, dbname from sheiladb.dbo.DARR_Date where thegroup like 'STANDARD DENIAL' 
	union select distinct referralid, dbname from sheiladb.dbo.DARR_Time where thegroup like 'STANDARD DENIAL') d1 -- denial attr group
	on d1.dbname = a.dbname and d1.referralid = a.referralid
left join (select distinct referralid, dbname from sheiladb.dbo.DARR_Date where thegroup like 'EXPEDITED DENIAL' 
	union select distinct referralid, dbname from sheiladb.dbo.DARR_Time where thegroup like 'EXPEDITED DENIAL') d2 -- denial attr group
	on d2.dbname = a.dbname and d2.referralid = a.referralid

--Define effective denial & update inclusion
update sheiladb.dbo.DARR_inclusion 
set Effective_Denial = case 
when (std_den_attr=1 or exp_den_attr=1) and (a.appeal='Y' or a.Appeal_Outcome_Attr_Overturn=1) and a.authstatus='APPROVED' 
	and a.Appeal_Outcome = 'OVERTURNED' and Deny_Serv=0 and Appr_Serv=1 then 'Y'
when (std_den_attr=1 or exp_den_attr=1) and (a.appeal='Y' or a.Appeal_Outcome_Attr_Overturn=1) and a.authstatus='APPROVED' 
	and a.Appeal_Outcome in ('OTHER','PARTIAL OVERTURN') and Deny_Serv=1 and Appr_Serv=1 then 'Y'
else a.Effective_Denial end
from sheiladb.dbo.DARR_Inclusion a join sheiladb.dbo.DARR_Appeal_Mod b on a.dbname = b.dbname and a.referralid = b.referralid

--Define partial & update inclusion
update sheiladb.dbo.DARR_inclusion 
set Partial = case when a.authstatus='APPROVED' and b.Deny_Serv=1 and b.Appr_Serv=1 and a.Effective_Denial = 'N' then 'Y' else a.Partial end
from sheiladb.dbo.DARR_Inclusion a join sheiladb.dbo.DARR_Appeal_Mod b on a.dbname = b.dbname and a.referralid = b.referralid

if object_id('tempdb..#DARR_Denials') is not null drop table #DARR_Denials
select distinct o.servicecode, o.acuity,o.dbname, o.referralid, o.authorizationid,o.authstatus, o.Partial,o.Effective_Denial
,aus.sequence,aus.status, Denial_Reason=ar.description
,Med_Director=rtrim(e.firstname)+' '+rtrim(e.lastname),count(o.referralid) inst
,MD_Review = case when aus.meddirectorid = '' then 0 else 1 end
into #DARR_Denials
from sheiladb.dbo.DARR_Inclusion o join stage.dbo.authservice aus on aus.referralid = o.referralid and aus.dbname = o.dbname 
left join stage.dbo.authservicereason asr on asr.referralid = o.referralid 
	and (asr.dbname = o.dbname or (o.dbname in ('NY','ID','MS') and asr.dbname = 'UN')) and aus.status = 'denied' and asr.sequence = aus.sequence
left join stage.dbo.reasongroupdtl rgd on rgd.reasongroupdtlid = asr.reasongroupdtlid and (rgd.dbname = o.dbname or (o.dbname in ('NY','ID','MS') and rgd.dbname = 'UN'))
left join stage.dbo.authreason ar on ar.reasoncode = rgd.reasoncode and (ar.dbname = o.dbname or (o.dbname in ('NY','ID','MS') and ar.dbname = 'UN'))
left join stage.dbo.entity e on e.entid = aus.meddirectorid and (o.dbname = e.dbname or (o.dbname in ('NY','ID','MS') and e.dbname = 'UN')) and e.enttype = 'MEDDIR' 
group by o.dbname,o.referralid,o.authorizationid,o.authstatus,o.Partial,o.Effective_Denial,o.servicecode,o.acuity
,aus.sequence,aus.status,ar.description,e.firstname,e.lastname,aus.meddirectorid

if object_id('sheiladb.dbo.DARR_Denials') is not null drop table sheiladb.dbo.DARR_Denials
select distinct a.dbname, a.referralid, a.authorizationid, authstatus, a.Partial, a.Effective_Denial
,MD_Review = case when a.authstatus <> 'DENIED' and a.Partial ='N' and a.Effective_Denial = 'N' then 'NA' 
when b.referralid is not null then 'N'  --MD review missing from med nec line
when e.referralid is not null then 'NA'  --MD review missing from any denied line 
else 'Y' end
,Denial_Reason = case when a.authstatus <> 'DENIED' and a.Partial ='N' and a.Effective_Denial = 'N' then 'NA'
when c.Denial_Reason is not null then c.Denial_Reason --med nec
when d.Denial_Reason is not null then d.Denial_Reason --non med nec
else 'N' end
into sheiladb.dbo.DARR_Denials from #DARR_Denials a
left join (select distinct dbname,referralid from #DARR_Denials where md_review = 0 and status = 'denied' and Denial_Reason like '%Denied Medical Necessity Criteria Not Met%') 
		b on b.referralid = a.referralid and b.dbname = a.dbname --MD review missing from med nec denied line
left join (select referralid, dbname,Denial_Reason,Med_Director, rn = row_number() over(partition by referralid, dbname, Denial_Reason order by sequence) 
		from #DARR_Denials where Denial_Reason like '%Denied Medical Necessity Criteria Not Met%')
		c on a.referralid = c.referralid and a.dbname = c.dbname and c.rn = '1' --Med nec
left join (select referralid, dbname,Denial_Reason,Med_Director, rn = row_number() over(partition by referralid, dbname, Denial_Reason order by inst) 
		from #DARR_Denials where Denial_Reason not like '%Denied Medical Necessity Criteria Not Met%')
		d on a.referralid = d.referralid and a.dbname = d.dbname and d.rn = '1'-- non med nec
left join (select distinct dbname,referralid from #DARR_Denials where md_review = 0 and status = 'denied') 
		e on e.referralid = a.referralid and e.dbname = a.dbname --MD review missing from any denied line

-- Indicate Extension, NonPar
if object_id('sheiladb.dbo.DARR_Ext') is not null drop table sheiladb.dbo.DARR_Ext
select distinct o.*
, case when thegroup in ('STANDARD EXTENSION','EXPEDITED EXTENSION') then '1' else '0' end as Ext
, case when thegroup in ('EXPEDITED NON PAR PROV MORE INFO') then '1' else '0' end as Enp 
into sheiladb.dbo.DARR_Ext 
from stage.dbo.referralattribute ra join stage.dbo.qattribute q on q.attributeid = ra.attributeid and q.dbname = ra.dbname
join sheiladb.dbo.DARR_Inclusion o on o.dbname = ra.dbname and o.referralid = ra.referralid
where thegroup in ('STANDARD EXTENSION','EXPEDITED EXTENSION','EXPEDITED NON PAR PROV MORE INFO') 

--Configure attributes for real date and time
if object_id('tempdb..#att_date1') is not null drop table #att_date1
select distinct o.authorizationid, thevalue, o.referralid,o.dbname, description, thegroup into #att_date1
from sheiladb.dbo.DARR_Inclusion o left join (select ra.dbname, thevalue, description, thegroup, referralid from stage.dbo.referralattribute ra 
			join stage.dbo.qattribute q on  q.attributeid = ra.attributeid and ra.dbname = q.dbname
			where description in ('PROV Verbal/ Fax Req Date','MBR Verbal Notif Date','Decision Date','PROV Notif Date','Auth Receipt Date','PROV Written Notif Date'
			,'Delivery Receipt Date','MBR Written Notif Date','Additional info days','Mailed Expedited','Accepted as Expedited','Delivery Receipt Date','PROV Notif Date'
			,'ToC – Discharge Orders or Summary sent to PCP','TOC – Verified Facility notified Member of Discharge','ToC – Verified Discharge Plan sent to Receiving Provider'
			,'ToC - Approval, Preadmit Education faxed to Requested Prov','ToC – Approval, Preadmit Education & PHR sent to Mbr'
			,'ToC – Notification of Emergent Admission sent to PCP','MODIFIED SERVICE REQUEST','Modified Service','Extension') ) ra
			on (o.dbname = ra.dbname or o.dbname = 'ID' and ra.dbname = 'UN') and o.referralid = ra.referralid
delete from #att_date1 where thevalue = ''  or thevalue='MM/DD/YYY' or thevalue like '%.%' or thevalue like '%:%' or thevalue like '%,%' or sheiladb.dbo.fn_IsDate(thevalue)=0
if object_id ('tempdb..#att_time1') is not null drop table #att_time1
select distinct o.DBname, case when len(ltrim(rtrim(thevalue))) =3 then '0' + CAST(ltrim(rtrim(thevalue)) as varchar) else ltrim(rtrim(thevalue)) end TheValue,o.referralid,o.authorizationid, description, thegroup 
into #att_time1 
from stage.dbo.referralattribute ra 
join stage.dbo.qattribute q on q.attributeid = ra.attributeid and q.dbname = ra.dbname 
join sheiladb.dbo.DARR_Inclusion o on (o.dbname = ra.dbname or o.dbname = 'ID' and ra.dbname = 'UN') and o.referralid = ra.referralid
			where 
			(q.description in ('PROV Verbal/ Fax Req Time','MBR Written Notif Time'
			,'PROV Written Notif Time','Expedited Delivery Receipt Time','MBR Verbal Notif Time'
			,'Auth Receipt Time','Decision Time','PROV Notif Time','additional info time') or q.description like '%PROV Written Notif Time%')
			and thevalue>'' and len(rtrim(ltrim(thevalue)))=4 and thevalue not like '%:%' and thevalue not like '%.%' and thevalue not like '%/%' and thevalue not like '%,%'
			and ISNUMERIC(thevalue)=1 --verifies that the entry is set up like a real time value

if object_id ('tempdb..#att_time2') is not null drop table #att_time2 
select distinct DBname,ReferralID,authorizationid,TheValue
,Description = case when description like '%PROV Written Notif Time%' then 'PROV Written Notif Time' else Description end
,TheGroup 
into #att_time2 from #att_time1
where left(TheValue,2) between 0 and 23 and right(thevalue,2) between 0 and 59

--||------//------/* Final Date & Time Tables */------\\-------||--
if object_id ('tempdb..#DARR_Dates') is not null drop table #DARR_Dates
select distinct a.* , convert(date,thevalue) Date_Value, getdate() Run_Date into #DARR_Dates from #att_date1 a 
if object_id ('tempdb..#DARR_Times') is not null drop table #DARR_Times
select distinct a.* , cast(left(thevalue,2)+':'+right(thevalue,2) as time) Time_Value, getdate() Run_Date into #DARR_Times from #att_time2 a 
if object_id ('sheiladb.dbo.DARR_Date') is not null drop table sheiladb.dbo.DARR_Date --constrain to only single values
select distinct a.* into sheiladb.dbo.DARR_Date
from #DARR_Dates a
join (SELECT dbname,referralid,authorizationid,thegroup,Description FROM #att_date1 GROUP BY dbname,referralid,authorizationid,thegroup,Description HAVING count(thevalue) = 1) 
		b on b.referralid = a.referralid and b.Description = a.Description and b.thegroup = a.thegroup and b.dbname = a.dbname
if object_id ('sheiladb.dbo.DARR_Time') is not null drop table sheiladb.dbo.DARR_Time --constrain to only single values
select distinct a.* into sheiladb.dbo.DARR_Time
from #DARR_Times a join (SELECT dbname,referralid,authorizationid,thegroup,description FROM #att_time2 GROUP BY dbname,referralid,authorizationid,thegroup,description HAVING count(thevalue) = 1) 
		b on b.referralid = a.referralid and b.description = a.description and b.thegroup = a.thegroup and b.dbname = a.dbname

------/* Text Attributes ------/*------
if object_id ('sheiladb.dbo.DARR_Text_Range') is not null drop table sheiladb.dbo.DARR_Text_Range  --attribute values required for end report, not date or time
select distinct b.dbname, a.ReferralID,a.authorizationid, TheValue,  Description , TheGroup
into sheiladb.dbo.DARR_Text_Range from stage.dbo.referral a join sheiladb.dbo.DARR_Inclusion b on (b.dbname = a.dbname or b.dbname = 'ID' and a.dbname = 'UN') and a.referralid = b.referralid
join (select ra.dbname, thevalue, referralid, description, thegroup from stage.dbo.referralattribute ra join stage.dbo.qattribute q on  q.attributeid = ra.attributeid and q.dbname = ra.dbname
			where description in ('Tracking #','# of Extension Days','Mailed Expedited','Reopened','Retro Review','Appeal Id','HH Continued Services') and thevalue>'') 
			ra on ra.referralid = a.referralid and (ra.dbname = a.dbname or ra.dbname='UN' and a.dbname = 'ID')
------Create pivot to align attributes with individual authorizations and exclude attributes not assigned to appropriate group------

if OBJECT_ID('tempdb..#DatePivot') is not null drop table #Datepivot --Group Date Attributes by each authorization
SELECT distinct * into #DatePivot
FROM (SELECT distinct a.dbname+' - '+b.referralid Auth_Key, rtrim(description)+' - '+rtrim(thegroup) Attr_Key, Date_Value 
        from sheiladb.dbo.DARR_Date a join sheiladb.dbo.DARR_Inclusion b on a.dbname = b.dbname and a.referralid = b.referralid 
		where TheGroup not in ('no group','') or (description = 'extension' and thegroup = 'no group')) 
		as m PIVOT (min(date_value)
   FOR Attr_Key IN 
   ([Auth Receipt Date - EXPEDITED APPROVAL],
[Auth Receipt Date - EXPEDITED CRITERIA NOT MET],
[Auth Receipt Date - EXPEDITED DENIAL],
[Auth Receipt Date - EXPEDITED EXTENSION],
[Auth Receipt Date - STANDARD APPROVAL],
[Auth Receipt Date - STANDARD DENIAL],
[Auth Receipt Date - STANDARD EXTENSION],
[Decision Date - EXPEDITED APPROVAL],
[Decision Date - EXPEDITED CRITERIA NOT MET],
[Decision Date - EXPEDITED DENIAL],
[Decision Date - EXPEDITED EXTENSION],
[Decision Date - STANDARD APPROVAL],
[Decision Date - STANDARD DENIAL],
[Decision Date - STANDARD EXTENSION],
[Delivery Receipt Date - EXPEDITED APPROVAL],
[Delivery Receipt Date - EXPEDITED CRITERIA NOT MET],
[Delivery Receipt Date - EXPEDITED DENIAL],
[Delivery Receipt Date - EXPEDITED EXTENSION],
[Delivery Receipt Date - STANDARD APPROVAL],
[Delivery Receipt Date - STANDARD DENIAL],
[Delivery Receipt Date - STANDARD EXTENSION],
[Extension - No Group],
[MBR Verbal Notif Date - EXPEDITED APPROVAL],
[MBR Verbal Notif Date - EXPEDITED CRITERIA NOT MET],
[MBR Verbal Notif Date - EXPEDITED DENIAL],
[MBR Verbal Notif Date - EXPEDITED EXTENSION],
[MBR Verbal Notif Date - STANDARD APPROVAL],
[MBR Verbal Notif Date - STANDARD DENIAL],
[MBR Verbal Notif Date - STANDARD EXTENSION],
[MBR Written Notif Date - EXPEDITED APPROVAL],
[MBR Written Notif Date - EXPEDITED CRITERIA NOT MET],
[MBR Written Notif Date - EXPEDITED DENIAL],
[MBR Written Notif Date - EXPEDITED EXTENSION],
[MBR Written Notif Date - STANDARD APPROVAL],
[MBR Written Notif Date - STANDARD DENIAL],
[MBR Written Notif Date - STANDARD EXTENSION],
[PROV Notif Date - EXPEDITED APPROVAL],
[PROV Notif Date - EXPEDITED CRITERIA NOT MET],
[PROV Notif Date - EXPEDITED DENIAL],
[PROV Notif Date - EXPEDITED EXTENSION],
[PROV Notif Date - STANDARD APPROVAL],
[PROV Notif Date - STANDARD DENIAL],
[PROV Notif Date - STANDARD EXTENSION],
[PROV Written Notif Date - EXPEDITED CRITERIA NOT MET],
[PROV Written Notif Date - EXPEDITED DENIAL],
[PROV Written Notif Date - EXPEDITED EXTENSION],
[PROV Written Notif Date - STANDARD DENIAL],
[PROV Written Notif Date - STANDARD EXTENSION],
[PROV Verbal/ Fax Req Date - EXPEDITED NON PAR PROV MORE INFO]
)   
)AS pvt 

if OBJECT_ID('tempdb..#TimePivot') is not null drop table #timepivot --Group Time Attributes by each authorization
SELECT distinct * into #TimePivot
FROM ( SELECT distinct a.dbname+' - '+b.referralid Auth_Key, rtrim(description)+' - '+rtrim(thegroup) Attr_Key, Time_Value 
        from sheiladb.dbo.DARR_Time a join sheiladb.dbo.DARR_Inclusion b on a.dbname = b.dbname and a.referralid = b.referralid where TheGroup not in ('no group','') 
) as m PIVOT (min(time_value)
  FOR Attr_Key IN ([Auth Receipt Time - EXPEDITED APPROVAL],
[Auth Receipt Time - EXPEDITED CRITERIA NOT MET],
[Auth Receipt Time - EXPEDITED DENIAL],
[Auth Receipt Time - EXPEDITED EXTENSION],
[Auth Receipt Time - STANDARD APPROVAL],
[Auth Receipt Time - STANDARD DENIAL],
[Auth Receipt Time - STANDARD EXTENSION],
[Decision Time - EXPEDITED APPROVAL],
[Decision Time - EXPEDITED CRITERIA NOT MET],
[Decision Time - EXPEDITED DENIAL],
[Decision Time - EXPEDITED EXTENSION],
[Decision Time - STANDARD APPROVAL],
[Decision Time - STANDARD DENIAL],
[Decision Time - STANDARD EXTENSION],
[Expedited Delivery Receipt Time - EXPEDITED APPROVAL],
[Expedited Delivery Receipt Time - EXPEDITED CRITERIA NOT MET],
[Expedited Delivery Receipt Time - EXPEDITED DENIAL],
[Expedited Delivery Receipt Time - EXPEDITED EXTENSION],
[MBR Verbal Notif Time - EXPEDITED APPROVAL],
[MBR Verbal Notif Time - EXPEDITED CRITERIA NOT MET],
[MBR Verbal Notif Time - EXPEDITED DENIAL],
[MBR Verbal Notif Time - EXPEDITED EXTENSION],
[MBR Verbal Notif Time - STANDARD APPROVAL],
[MBR Verbal Notif Time - STANDARD DENIAL],
[MBR Written Notif Time - EXPEDITED APPROVAL],
[MBR Written Notif Time - EXPEDITED CRITERIA NOT MET],
[MBR Written Notif Time - EXPEDITED DENIAL],
[MBR Written Notif Time - EXPEDITED EXTENSION],
[MBR Written Notif Time - STANDARD APPROVAL],
[MBR Written Notif Time - STANDARD DENIAL],
[PROV Notif Time - EXPEDITED APPROVAL],
[PROV Notif Time - EXPEDITED CRITERIA NOT MET],
[PROV Notif Time - EXPEDITED DENIAL],
[PROV Notif Time - EXPEDITED EXTENSION],
[PROV Notif Time - STANDARD APPROVAL],
[PROV Notif Time - STANDARD DENIAL],
[PROV Notif Time - STANDARD EXTENSION],
[PROV Written Notif Time - EXPEDITED CRITERIA NOT MET],
[PROV Written Notif Time - EXPEDITED DENIAL],
[PROV Written Notif Time - EXPEDITED EXTENSION],
[PROV Written Notif Time - STANDARD DENIAL],
[PROV Verbal/ Fax Req Time - EXPEDITED NON PAR PROV MORE INFO]
)   
)AS pvt 

if OBJECT_ID('tempdb..#TextPivot') is not null drop table #TextPivot --Group Text Attributes by each authorization
SELECT distinct * into #TextPivot
FROM (
SELECT distinct a.dbname+' - '+b.referralid Auth_Key, 
rtrim(description)+' - '+rtrim(thegroup) Attr_Key, TheValue 
        from sheiladb.dbo.DARR_Text_Range a join sheiladb.dbo.DARR_Inclusion b on a.dbname = b.dbname and a.referralid = b.referralid 
        where TheGroup not in ('no group','')
) as m PIVOT (min(thevalue)
   FOR Attr_Key IN ([# of Extension Days - EXPEDITED EXTENSION],
[# of Extension Days - STANDARD EXTENSION],
[Mailed Expedited - EXPEDITED APPROVAL],
[Mailed Expedited - EXPEDITED CRITERIA NOT MET],
[Mailed Expedited - EXPEDITED DENIAL],
[Mailed Expedited - EXPEDITED EXTENSION],
[Mailed Expedited - STANDARD APPROVAL],
[Mailed Expedited - STANDARD DENIAL],
[Mailed Expedited - STANDARD EXTENSION],
[Tracking # - EXPEDITED APPROVAL],
[Tracking # - EXPEDITED CRITERIA NOT MET],
[Tracking # - EXPEDITED DENIAL],
[Tracking # - EXPEDITED EXTENSION],
[Tracking # - STANDARD APPROVAL],
[Tracking # - STANDARD DENIAL],
[Tracking # - STANDARD EXTENSION]
)) as pvt 

if OBJECT_ID('tempdb..#DARR_Attributes_For_Calc') is not null drop table #DARR_Attributes_For_Calc --Combine All Attributes and group by each authorization
select distinct  a.*, t.Auth_Key, Ext,Enp,[Extension - No Group],
[PROV Verbal/ Fax Req Date - EXPEDITED NON PAR PROV MORE INFO],[PROV Verbal/ Fax Req Time - EXPEDITED NON PAR PROV MORE INFO]
,[# of Extension Days - EXPEDITED EXTENSION]	,[# of Extension Days - STANDARD EXTENSION]	,[PROV Written Notif Time - STANDARD DENIAL]
,[MBR Written Notif Time - STANDARD APPROVAL],[MBR Written Notif Time - STANDARD DENIAL],[MBR Verbal Notif Time - STANDARD APPROVAL],[MBR Verbal Notif Time - STANDARD DENIAL]
,[Auth Receipt Date - EXPEDITED APPROVAL],[Auth Receipt Date - EXPEDITED CRITERIA NOT MET],[Auth Receipt Date - EXPEDITED DENIAL],[Auth Receipt Date - EXPEDITED EXTENSION],[Auth Receipt Date - STANDARD APPROVAL],[Auth Receipt Date - STANDARD DENIAL],[Auth Receipt Date - STANDARD EXTENSION]
,[Auth Receipt Time - EXPEDITED APPROVAL],[Auth Receipt Time - EXPEDITED CRITERIA NOT MET],[Auth Receipt Time - EXPEDITED DENIAL],[Auth Receipt Time - EXPEDITED EXTENSION],[Auth Receipt Time - STANDARD APPROVAL],[Auth Receipt Time - STANDARD DENIAL],[Auth Receipt Time - STANDARD EXTENSION]
,[Decision Date - EXPEDITED APPROVAL],[Decision Date - EXPEDITED CRITERIA NOT MET],[Decision Date - EXPEDITED DENIAL],[Decision Date - EXPEDITED EXTENSION],[Decision Date - STANDARD APPROVAL],[Decision Date - STANDARD DENIAL],[Decision Date - STANDARD EXTENSION]
,[Decision Time - EXPEDITED APPROVAL],[Decision Time - EXPEDITED CRITERIA NOT MET],[Decision Time - EXPEDITED DENIAL],[Decision Time - EXPEDITED EXTENSION],[Decision Time - STANDARD APPROVAL],[Decision Time - STANDARD DENIAL],[Decision Time - STANDARD EXTENSION]
,[Delivery Receipt Date - EXPEDITED APPROVAL],[Delivery Receipt Date - EXPEDITED CRITERIA NOT MET]		,[Delivery Receipt Date - EXPEDITED DENIAL]		,[Delivery Receipt Date - EXPEDITED EXTENSION]		,[Delivery Receipt Date - STANDARD APPROVAL]		,[Delivery Receipt Date - STANDARD DENIAL]		,[Delivery Receipt Date - STANDARD EXTENSION]		
,[Expedited Delivery Receipt Time - EXPEDITED APPROVAL]		,[Expedited Delivery Receipt Time - EXPEDITED CRITERIA NOT MET]		,[Expedited Delivery Receipt Time - EXPEDITED DENIAL]		,[Expedited Delivery Receipt Time - EXPEDITED EXTENSION]
,[Mailed Expedited - EXPEDITED APPROVAL],[Mailed Expedited - EXPEDITED CRITERIA NOT MET],[Mailed Expedited - EXPEDITED DENIAL]	,[Mailed Expedited - EXPEDITED EXTENSION]	,[Mailed Expedited - STANDARD APPROVAL]	,[Mailed Expedited - STANDARD DENIAL]	,[Mailed Expedited - STANDARD EXTENSION]
,[MBR Verbal Notif Date - EXPEDITED APPROVAL],[MBR Verbal Notif Date - EXPEDITED CRITERIA NOT MET],[MBR Verbal Notif Date - EXPEDITED DENIAL],[MBR Verbal Notif Date - EXPEDITED EXTENSION],[MBR Verbal Notif Date - STANDARD APPROVAL],[MBR Verbal Notif Date - STANDARD DENIAL],[MBR Verbal Notif Date - STANDARD EXTENSION]
,[MBR Verbal Notif Time - EXPEDITED APPROVAL],[MBR Verbal Notif Time - EXPEDITED CRITERIA NOT MET],[MBR Verbal Notif Time - EXPEDITED DENIAL],[MBR Verbal Notif Time - EXPEDITED EXTENSION]
,[MBR Written Notif Date - EXPEDITED APPROVAL],[MBR Written Notif Date - EXPEDITED CRITERIA NOT MET],[MBR Written Notif Date - EXPEDITED DENIAL],[MBR Written Notif Date - EXPEDITED EXTENSION],[MBR Written Notif Date - STANDARD APPROVAL],[MBR Written Notif Date - STANDARD DENIAL],[MBR Written Notif Date - STANDARD EXTENSION]
,[MBR Written Notif Time - EXPEDITED APPROVAL],[MBR Written Notif Time - EXPEDITED CRITERIA NOT MET],[MBR Written Notif Time - EXPEDITED DENIAL],[MBR Written Notif Time - EXPEDITED EXTENSION]
,[PROV Notif Date - EXPEDITED APPROVAL],[PROV Notif Date - EXPEDITED CRITERIA NOT MET],[PROV Notif Date - EXPEDITED DENIAL],[PROV Notif Date - EXPEDITED EXTENSION],[PROV Notif Date - STANDARD APPROVAL],[PROV Notif Date - STANDARD DENIAL],[PROV Notif Date - STANDARD EXTENSION]
,[PROV Notif Time - EXPEDITED APPROVAL],[PROV Notif Time - EXPEDITED CRITERIA NOT MET],[PROV Notif Time - EXPEDITED DENIAL],[PROV Notif Time - EXPEDITED EXTENSION],[PROV Notif Time - STANDARD APPROVAL],[PROV Notif Time - STANDARD DENIAL],[PROV Notif Time - STANDARD EXTENSION]
,[PROV Written Notif Date - EXPEDITED CRITERIA NOT MET],[PROV Written Notif Date - EXPEDITED DENIAL],[PROV Written Notif Date - EXPEDITED EXTENSION],[PROV Written Notif Date - STANDARD DENIAL],[PROV Written Notif Date - STANDARD EXTENSION],[PROV Written Notif Time - EXPEDITED CRITERIA NOT MET],[PROV Written Notif Time - EXPEDITED DENIAL],[PROV Written Notif Time - EXPEDITED EXTENSION]
,[Tracking # - EXPEDITED APPROVAL],[Tracking # - EXPEDITED CRITERIA NOT MET],[Tracking # - EXPEDITED DENIAL],[Tracking # - EXPEDITED EXTENSION],[Tracking # - STANDARD APPROVAL],[Tracking # - STANDARD DENIAL],[Tracking # - STANDARD EXTENSION]
into #DARR_Attributes_For_Calc
from sheiladb.dbo.DARR_Inclusion a
left join #DatePivot d on (a.dbname+' - '+a.referralid) = d.Auth_key
left join #TimePivot t on (a.dbname+' - '+a.referralid) = t.Auth_key
left join #TextPivot x on (a.dbname+' - '+a.referralid) = x.Auth_key
left join sheiladb.dbo.DARR_Ext ex on ex.referralid = a.referralid and ex.dbname = a.dbname

-----Align naming conventions with final report layout------
if OBJECT_ID('sheiladb.dbo.DARR_Attributes_For_Calc') is not null drop table sheiladb.dbo.DARR_Attributes_For_Calc
select distinct a.*,
case when acuity = 'urgent' and authstatus = 'approved' and [Auth Receipt Date - EXPEDITED APPROVAL] is not null and [Auth Receipt Time - EXPEDITED APPROVAL] is not null 
	then cast([Auth Receipt Date - EXPEDITED APPROVAL] as datetime) + cast([Auth Receipt Time - EXPEDITED APPROVAL] as datetime) 
	when acuity = 'urgent' and authstatus = 'denied' and [Auth Receipt Date - EXPEDITED DENIAL] is not null and [Auth Receipt Time - EXPEDITED DENIAL] is not null 
	then cast([Auth Receipt Date - EXPEDITED DENIAL] as datetime) + cast([Auth Receipt Time - EXPEDITED DENIAL] as datetime) 
	when acuity in ('elective','emergency') and authstatus = 'approved' and [Auth Receipt Date - STANDARD APPROVAL] is not null --and [Auth Receipt Time - STANDARD APPROVAL] is not null 
	then cast([Auth Receipt Date - STANDARD APPROVAL] as datetime) --+ cast([Auth Receipt Time - STANDARD APPROVAL] as datetime) 
	when acuity in ('elective','emergency') and authstatus = 'denied' and [Auth Receipt Date - STANDARD DENIAL] is not null --and [Auth Receipt Time - STANDARD DENIAL] is not null 
	then cast([Auth Receipt Date - STANDARD DENIAL] as datetime) --+ cast([Auth Receipt Time - STANDARD DENIAL] as datetime)
	end Match_Auth_Receipt,
case when acuity = 'urgent' and authstatus = 'approved' and [Decision Date - EXPEDITED APPROVAL] is not null and [Decision Time - EXPEDITED APPROVAL] is not null 
	then cast([Decision Date - EXPEDITED APPROVAL] as datetime) + cast([Decision Time - EXPEDITED APPROVAL] as datetime) 
	when acuity = 'urgent' and authstatus = 'denied' and [Auth Receipt Date - EXPEDITED DENIAL] is not null and [Decision Time - EXPEDITED DENIAL] is not null 
	then cast([Decision Date - EXPEDITED DENIAL] as datetime) + cast([Decision Time - EXPEDITED DENIAL] as datetime) 
	when acuity in ('elective','emergency') and authstatus = 'approved' and [Decision Date - STANDARD APPROVAL] is not null --and [Decision Time - STANDARD APPROVAL] is not null 
	then cast([Decision Date - STANDARD APPROVAL] as datetime) --+ cast([Decision Time - STANDARD APPROVAL] as datetime) 
	when acuity in ('elective','emergency') and authstatus = 'denied' and [Decision Date - STANDARD DENIAL] is not null --and [Decision Time - STANDARD DENIAL] is not null 
	then cast([Decision Date - STANDARD DENIAL] as datetime) --+ cast([Decision Time - STANDARD DENIAL] as datetime)
	end Match_Decision,
-----#-----/* Expedited Approval */
[Auth Receipt Date - EXPEDITED APPROVAL] Exp_Appr_Auth_Receipt_Date,
[Auth Receipt Time - EXPEDITED APPROVAL] Exp_Appr_Auth_Receipt_Time	,
case when [Auth Receipt Date - EXPEDITED APPROVAL] is not null and [Auth Receipt Time - EXPEDITED APPROVAL] is not null then 
cast([Auth Receipt Date - EXPEDITED APPROVAL]	as datetime) + cast([Auth Receipt Time - EXPEDITED APPROVAL]	as datetime) end	Exp_Appr_Auth_Receipt	,
[Decision Date - EXPEDITED APPROVAL] Exp_Appr_Decision_Date,
[Decision Time - EXPEDITED APPROVAL] Exp_Appr_Decision_Time	,
case when[Decision Date - EXPEDITED APPROVAL] is not null and [Decision Time - EXPEDITED APPROVAL] is not null then
cast([Decision Date - EXPEDITED APPROVAL] as datetime) + cast([Decision Time - EXPEDITED APPROVAL] as datetime) end	Exp_Appr_Decision	,
[MBR Verbal Notif Date - EXPEDITED APPROVAL] Exp_Appr_Mbr_Verbal_Date,
[MBR Verbal Notif Time - EXPEDITED APPROVAL] Exp_Appr_Mbr_Verbal_Time,
case when [MBR Verbal Notif Date - EXPEDITED APPROVAL] is not null and [MBR Verbal Notif Time - EXPEDITED APPROVAL] is not null then 
cast([MBR Verbal Notif Date - EXPEDITED APPROVAL]	as datetime) + cast([MBR Verbal Notif Time - EXPEDITED APPROVAL]	as datetime) end Exp_Appr_Mbr_Verbal	,
[MBR Written Notif Date - EXPEDITED APPROVAL] Exp_Appr_Mbr_Written_Date	,
[MBR Written Notif Time - EXPEDITED APPROVAL] Exp_Appr_Mbr_Written_Time	,
case when [MBR Written Notif Date - EXPEDITED APPROVAL] is not null and [MBR Written Notif Time - EXPEDITED APPROVAL] is not null then 
cast([MBR Written Notif Date - EXPEDITED APPROVAL]	as datetime) + cast([MBR Written Notif Time - EXPEDITED APPROVAL]	as datetime) end Exp_Appr_Mbr_Written_Raw	,
case when [MBR Written Notif Date - EXPEDITED APPROVAL] is null or  [MBR Written Notif Time - EXPEDITED APPROVAL] is null then null
when [Tracking # - EXPEDITED APPROVAL] like 'Cour%' 
then cast([MBR Written Notif Date - EXPEDITED APPROVAL]	as datetime) + cast([MBR Written Notif Time - EXPEDITED APPROVAL]	as datetime)
when planname = 'WI' and [MBR Written Notif Time - EXPEDITED APPROVAL] <= '14:00' then cast([MBR Written Notif Date - EXPEDITED APPROVAL]	as datetime) + cast('23:59' as datetime)
when planname = 'WI' and [MBR Written Notif Time - EXPEDITED APPROVAL] > '14:00' and datename(dw,[MBR Written Notif Date - EXPEDITED APPROVAL]) <> 'Saturday'
then cast([MBR Written Notif Date - EXPEDITED APPROVAL]	as datetime) + cast('23:59' as datetime)+1
when planname = 'WI' and [MBR Written Notif Time - EXPEDITED APPROVAL] > '14:00' and datename(dw,[MBR Written Notif Date - EXPEDITED APPROVAL]) = 'Saturday'
then cast([MBR Written Notif Date - EXPEDITED APPROVAL]	as datetime) + cast('23:59' as datetime)+2 
when planname = 'OH' and [MBR Written Notif Time - EXPEDITED APPROVAL] <= '16:00' then cast([MBR Written Notif Date - EXPEDITED APPROVAL]	as datetime) + cast('23:59' as datetime)
when planname = 'OH' and [MBR Written Notif Time - EXPEDITED APPROVAL] > '16:00' and datename(dw,[MBR Written Notif Date - EXPEDITED APPROVAL]) <> 'Saturday'
then cast([MBR Written Notif Date - EXPEDITED APPROVAL]	as datetime) + cast('23:59' as datetime)+1
when planname = 'OH' and [MBR Written Notif Time - EXPEDITED APPROVAL] > '16:00' and datename(dw,[MBR Written Notif Date - EXPEDITED APPROVAL]) = 'Saturday'
then cast([MBR Written Notif Date - EXPEDITED APPROVAL]	as datetime) + cast('23:59' as datetime)+2 
when [MBR Written Notif Time - EXPEDITED APPROVAL] <= '15:45' then cast([MBR Written Notif Date - EXPEDITED APPROVAL]	as datetime) + cast('23:59' as datetime)
when [MBR Written Notif Time - EXPEDITED APPROVAL] > '15:45' and datename(dw,[MBR Written Notif Date - EXPEDITED APPROVAL]) <> 'Saturday'
then cast([MBR Written Notif Date - EXPEDITED APPROVAL]	as datetime) + cast('23:59' as datetime)+1
when [MBR Written Notif Time - EXPEDITED APPROVAL] > '15:45' and datename(dw,[MBR Written Notif Date - EXPEDITED APPROVAL]) = 'Saturday'
then cast([MBR Written Notif Date - EXPEDITED APPROVAL]	as datetime) + cast('23:59' as datetime)+2 end Exp_Appr_Mbr_Written	,
[Mailed Expedited - EXPEDITED APPROVAL]				Mailed_Exp_Appr	,
[Tracking # - EXPEDITED APPROVAL]				Tracking_Exp_Appr	,
[Delivery Receipt Date - EXPEDITED APPROVAL]				Delivery_Date_Exp_Appr	,
[Expedited Delivery Receipt Time - EXPEDITED APPROVAL]				Exp_Delivery_Time_Appr	,
case when [Delivery Receipt Date - EXPEDITED APPROVAL] is not null and [Expedited Delivery Receipt Time - EXPEDITED APPROVAL] is not null then 
cast([Delivery Receipt Date - EXPEDITED APPROVAL] as datetime) + cast([Expedited Delivery Receipt Time - EXPEDITED APPROVAL] as datetime) end Exp_Appr_Delivery,
case when [PROV Notif Date - EXPEDITED APPROVAL] is not null and [PROV Notif Time - EXPEDITED APPROVAL] is not null then 
cast([PROV Notif Date - EXPEDITED APPROVAL]	as datetime) + cast([PROV Notif Time - EXPEDITED APPROVAL]	as datetime) end Exp_Appr_Prov	,
-----#-----/* Expedited Denial */
[Auth Receipt Date - EXPEDITED DENIAL] Exp_Deny_Auth_Receipt_Date,
[Auth Receipt Time - EXPEDITED DENIAL]Exp_Deny_Auth_Receipt_Time,
case when [Auth Receipt Date - EXPEDITED DENIAL] is not null and [Auth Receipt Time - EXPEDITED DENIAL] is not null then 
cast([Auth Receipt Date - EXPEDITED DENIAL]	as datetime) + cast([Auth Receipt Time - EXPEDITED DENIAL]	as datetime) end Exp_Deny_Auth_Receipt	,
[Decision Date - EXPEDITED DENIAL] Exp_Deny_Decision_Date,
[Decision Time - EXPEDITED DENIAL] Exp_Deny_Decision_Time,
case when[Decision Date - EXPEDITED DENIAL] is not null and [Decision Time - EXPEDITED DENIAL] is not null then
cast([Decision Date - EXPEDITED DENIAL] as datetime) + cast([Decision Time - EXPEDITED DENIAL] as datetime) end	Exp_Deny_Decision	,
[MBR Verbal Notif Date - EXPEDITED DENIAL] Exp_Deny_Mbr_Verbal_Date,
[MBR Verbal Notif Time - EXPEDITED DENIAL]Exp_Deny_Mbr_Verbal_Time,
case when [MBR Verbal Notif Date - EXPEDITED DENIAL] is not null and [MBR Verbal Notif Time - EXPEDITED DENIAL] is not null then 
cast([MBR Verbal Notif Date - EXPEDITED DENIAL]	as datetime) + cast([MBR Verbal Notif Time - EXPEDITED DENIAL]	as datetime) end Exp_Deny_Mbr_Verbal	,
[MBR Written Notif Date - EXPEDITED DENIAL] Exp_Deny_Mbr_Written_Date,
[MBR Written Notif Time - EXPEDITED DENIAL] Exp_Deny_Mbr_Written_Time	,
cast([MBR Written Notif Date - EXPEDITED DENIAL]	as datetime) + cast([MBR Written Notif Time - EXPEDITED DENIAL]	as datetime) 	Exp_Deny_Mbr_Written_Raw	,
case when [MBR Written Notif Date - EXPEDITED DENIAL] is null or  [MBR Written Notif Time - EXPEDITED DENIAL] is null then null
when [Tracking # - EXPEDITED DENIAL] like 'Cour%' then cast([MBR Written Notif Date - EXPEDITED DENIAL] as datetime) + cast([MBR Written Notif Time - EXPEDITED DENIAL] as datetime)
when planname = 'WI' and [MBR Written Notif Time - EXPEDITED DENIAL] <= '14:00' then cast([MBR Written Notif Date - EXPEDITED DENIAL]	as datetime) + cast('23:59' as datetime)
when planname = 'WI' and [MBR Written Notif Time - EXPEDITED DENIAL] > '14:00' and datename(dw,[MBR Written Notif Date - EXPEDITED DENIAL]) <> 'Saturday'
then cast([MBR Written Notif Date - EXPEDITED DENIAL]	as datetime) + cast('23:59' as datetime)+1
when planname = 'WI' and [MBR Written Notif Time - EXPEDITED DENIAL] > '14:00' and datename(dw,[MBR Written Notif Date - EXPEDITED DENIAL]) = 'Saturday'
then cast([MBR Written Notif Date - EXPEDITED DENIAL]	as datetime) + cast('23:59' as datetime)+2 
when planname = 'OH' and [MBR Written Notif Time - EXPEDITED DENIAL] <= '16:00' then cast([MBR Written Notif Date - EXPEDITED DENIAL]	as datetime) + cast('23:59' as datetime)
when planname = 'OH' and [MBR Written Notif Time - EXPEDITED DENIAL] > '16:00' and datename(dw,[MBR Written Notif Date - EXPEDITED DENIAL]) <> 'Saturday'
then cast([MBR Written Notif Date - EXPEDITED DENIAL]	as datetime) + cast('23:59' as datetime)+1
when planname = 'OH' and [MBR Written Notif Time - EXPEDITED DENIAL] > '16:00' and datename(dw,[MBR Written Notif Date - EXPEDITED DENIAL]) = 'Saturday'
then cast([MBR Written Notif Date - EXPEDITED DENIAL]	as datetime) + cast('23:59' as datetime)+2 
when [MBR Written Notif Time - EXPEDITED DENIAL] <= '15:45' then cast([MBR Written Notif Date - EXPEDITED DENIAL]	as datetime) + cast('23:59' as datetime)
when [MBR Written Notif Time - EXPEDITED DENIAL] > '15:45' and datename(dw,[MBR Written Notif Date - EXPEDITED DENIAL]) <> 'Saturday'
then cast([MBR Written Notif Date - EXPEDITED DENIAL]	as datetime) + cast('23:59' as datetime)+1
when [MBR Written Notif Time - EXPEDITED DENIAL] > '15:45' and datename(dw,[MBR Written Notif Date - EXPEDITED DENIAL]) = 'Saturday'
then cast([MBR Written Notif Date - EXPEDITED DENIAL]	as datetime) + cast('23:59' as datetime)+2 end Exp_Deny_Mbr_Written	,
[Mailed Expedited - EXPEDITED DENIAL]				Mailed_Exp_Deny	,
[Tracking # - EXPEDITED DENIAL]				Tracking_Exp_Deny	,
[Delivery Receipt Date - EXPEDITED DENIAL]				Delivery_Date_Exp_Deny	,
[Expedited Delivery Receipt Time - EXPEDITED DENIAL]				Exp_Delivery_Time_Deny	,
case when [Delivery Receipt Date - EXPEDITED DENIAL] is not null and [Expedited Delivery Receipt Time - EXPEDITED DENIAL] is not null then 
cast([Delivery Receipt Date - EXPEDITED DENIAL] as datetime) + cast([Expedited Delivery Receipt Time - EXPEDITED DENIAL] as datetime)end Exp_Deny_Delivery, 
[PROV Notif Date - EXPEDITED DENIAL] Exp_Deny_Prov_Date	,
[PROV Notif Time - EXPEDITED DENIAL] Exp_Deny_Prov_Time	,
case when [PROV Notif Date - EXPEDITED DENIAL] is not null and [PROV Notif Time - EXPEDITED DENIAL] is not null then 
cast([PROV Notif Date - EXPEDITED DENIAL]	as datetime) + cast([PROV Notif Time - EXPEDITED DENIAL]	as datetime) end Exp_Deny_Prov	,
[PROV Written Notif Date - EXPEDITED DENIAL] Exp_Deny_Prov_Written_Date,
[PROV Written Notif Time - EXPEDITED DENIAL] Exp_Deny_Prov_Written_Time,
case when [PROV Written Notif Date - EXPEDITED DENIAL] is not null and [PROV Written Notif Time - EXPEDITED DENIAL] is not null then 
cast([PROV Written Notif Date - EXPEDITED DENIAL]	as datetime) + cast([PROV Written Notif Time - EXPEDITED DENIAL]	as datetime) end Exp_Deny_Prov_Written,
-----#-----/* Ex Crit Not Met */
[Auth Receipt Date - EXPEDITED CRITERIA NOT MET] Exp_Crit_Auth_Receipt_Date	,
[Auth Receipt Time - EXPEDITED CRITERIA NOT MET] Exp_Crit_Auth_Receipt_Time	,
case when [Auth Receipt Date - EXPEDITED CRITERIA NOT MET] is not null and [Auth Receipt Time - EXPEDITED CRITERIA NOT MET] is not null then 
cast([Auth Receipt Date - EXPEDITED CRITERIA NOT MET]	as datetime) + cast([Auth Receipt Time - EXPEDITED CRITERIA NOT MET]	as datetime) end Exp_Crit_Auth_Peceipt	,
[Decision Date - EXPEDITED CRITERIA NOT MET] Exp_Crit_Decision_Date	,
[Decision Time - EXPEDITED CRITERIA NOT MET] Exp_Crit_Decision_Time	,
case when [Decision Date - EXPEDITED CRITERIA NOT MET] is not null and [Decision Time - EXPEDITED CRITERIA NOT MET] is not null then 
cast([Decision Date - EXPEDITED CRITERIA NOT MET]	as datetime) + cast([Decision Time - EXPEDITED CRITERIA NOT MET]	as datetime) end Exp_Crit_Decision	,
[MBR Verbal Notif Date - EXPEDITED CRITERIA NOT MET] Exp_Crit_Mbr_Verbal_Date,
[MBR Verbal Notif Time - EXPEDITED CRITERIA NOT MET] Exp_Crit_Mbr_Verbal_Time,
case when [MBR Verbal Notif Date - EXPEDITED CRITERIA NOT MET] is not null and [MBR Verbal Notif Time - EXPEDITED CRITERIA NOT MET] is not null then 
cast([MBR Verbal Notif Date - EXPEDITED CRITERIA NOT MET]	as datetime) + cast([MBR Verbal Notif Time - EXPEDITED CRITERIA NOT MET]	as datetime) end Exp_Crit_Mbr_Verbal,
[MBR Written Notif Date - EXPEDITED CRITERIA NOT MET] Exp_Crit_Mbr_Written_Date	,
[MBR Written Notif Time - EXPEDITED CRITERIA NOT MET] Exp_Crit_Mbr_Written_Time	,
case when [MBR Written Notif Date - EXPEDITED CRITERIA NOT MET] is not null and [MBR Written Notif Time - EXPEDITED CRITERIA NOT MET] is not null then 
cast([MBR Written Notif Date - EXPEDITED CRITERIA NOT MET]	as datetime) + cast([MBR Written Notif Time - EXPEDITED CRITERIA NOT MET]	as datetime) end	Exp_Crit_Mbr_Written_Raw	,
case when [MBR Written Notif Date - EXPEDITED CRITERIA NOT MET] is null or  [MBR Written Notif Time - EXPEDITED CRITERIA NOT MET] is null then null
when [Tracking # - EXPEDITED CRITERIA NOT MET] like 'Cour%' then cast([MBR Written Notif Date - EXPEDITED CRITERIA NOT MET] as datetime) + cast([MBR Written Notif Time - EXPEDITED CRITERIA NOT MET] as datetime)
when planname = 'WI' and [MBR Written Notif Time - EXPEDITED CRITERIA NOT MET] <= '14:00' then cast([MBR Written Notif Date - EXPEDITED CRITERIA NOT MET]	as datetime) + cast('23:59' as datetime)
when planname = 'WI' and [MBR Written Notif Time - EXPEDITED CRITERIA NOT MET] > '14:00' and datename(dw,[MBR Written Notif Date - EXPEDITED CRITERIA NOT MET]) <> 'Saturday'
then cast([MBR Written Notif Date - EXPEDITED CRITERIA NOT MET]	as datetime) + cast('23:59' as datetime)+1
when planname = 'WI' and [MBR Written Notif Time - EXPEDITED CRITERIA NOT MET] > '14:00' and datename(dw,[MBR Written Notif Date - EXPEDITED CRITERIA NOT MET]) = 'Saturday'
then cast([MBR Written Notif Date - EXPEDITED CRITERIA NOT MET]	as datetime) + cast('23:59' as datetime)+2 
when planname = 'OH' and [MBR Written Notif Time - EXPEDITED CRITERIA NOT MET] <= '16:00' then cast([MBR Written Notif Date - EXPEDITED CRITERIA NOT MET]	as datetime) + cast('23:59' as datetime)
when planname = 'OH' and [MBR Written Notif Time - EXPEDITED CRITERIA NOT MET] > '16:00' and datename(dw,[MBR Written Notif Date - EXPEDITED CRITERIA NOT MET]) <> 'Saturday'
then cast([MBR Written Notif Date - EXPEDITED CRITERIA NOT MET]	as datetime) + cast('23:59' as datetime)+1
when planname = 'OH' and [MBR Written Notif Time - EXPEDITED CRITERIA NOT MET] > '16:00' and datename(dw,[MBR Written Notif Date - EXPEDITED CRITERIA NOT MET]) = 'Saturday'
then cast([MBR Written Notif Date - EXPEDITED CRITERIA NOT MET]	as datetime) + cast('23:59' as datetime)+2 
when [MBR Written Notif Time - EXPEDITED CRITERIA NOT MET] <= '15:45' then cast([MBR Written Notif Date - EXPEDITED CRITERIA NOT MET]	as datetime) + cast('23:59' as datetime)
when [MBR Written Notif Time - EXPEDITED CRITERIA NOT MET] > '15:45' and datename(dw,[MBR Written Notif Date - EXPEDITED CRITERIA NOT MET]) <> 'Saturday'
then cast([MBR Written Notif Date - EXPEDITED CRITERIA NOT MET]	as datetime) + cast('23:59' as datetime)+1
when [MBR Written Notif Time - EXPEDITED CRITERIA NOT MET] > '15:45' and datename(dw,[MBR Written Notif Date - EXPEDITED CRITERIA NOT MET]) = 'Saturday'
then cast([MBR Written Notif Date - EXPEDITED CRITERIA NOT MET]	as datetime) + cast('23:59' as datetime)+2 
end Exp_Crit_Mbr_Written,
[Mailed Expedited - EXPEDITED CRITERIA NOT MET]				Mailed_Exp_Crit	,
[Tracking # - EXPEDITED CRITERIA NOT MET]				Tracking_Exp_Crit	,
[Delivery Receipt Date - EXPEDITED CRITERIA NOT MET]				Delivery_Date_Exp_Crit	,
[Expedited Delivery Receipt Time - EXPEDITED CRITERIA NOT MET]				Exp_Delivery_Time_Exp_Crit	,
case when [Delivery Receipt Date - EXPEDITED CRITERIA NOT MET] is null or  [Expedited Delivery Receipt Time - EXPEDITED CRITERIA NOT MET] is null then null else
cast([Delivery Receipt Date - EXPEDITED CRITERIA NOT MET] as datetime) + cast([Expedited Delivery Receipt Time - EXPEDITED CRITERIA NOT MET] as datetime) end Exp_Crit_Delivery,
[PROV Notif Date - EXPEDITED CRITERIA NOT MET] Exp_Crit_Prov_Date,
[PROV Notif Time - EXPEDITED CRITERIA NOT MET] Exp_Crit_Prov_Time,
case when [PROV Notif Date - EXPEDITED CRITERIA NOT MET] is null or  [PROV Notif Time - EXPEDITED CRITERIA NOT MET] is null then null else
cast([PROV Notif Date - EXPEDITED CRITERIA NOT MET]	as datetime) + cast([PROV Notif Time - EXPEDITED CRITERIA NOT MET]	as datetime) end Exp_Crit_Prov	,
[PROV Written Notif Date - EXPEDITED CRITERIA NOT MET] Exp_Crit_Prov_Written_Date,
[PROV Written Notif Time - EXPEDITED CRITERIA NOT MET] Exp_Crit_Prov_Written_Time,
case when [PROV Written Notif Date - EXPEDITED CRITERIA NOT MET] is null or  [PROV Written Notif Time - EXPEDITED CRITERIA NOT MET] is null then null else
cast([PROV Written Notif Date - EXPEDITED CRITERIA NOT MET]	as datetime) + cast([PROV Written Notif Time - EXPEDITED CRITERIA NOT MET]	as datetime) end Exp_Crit_Prov_Written	,
-----#-----/* Ex Ext */
[Auth Receipt Date - EXPEDITED EXTENSION] Exp_Ext_Auth_Receipt_Date	,
[Auth Receipt Time - EXPEDITED EXTENSION] Exp_Ext_Auth_Receipt_Time	,
case when [Auth Receipt Date - EXPEDITED EXTENSION] is null or  [Auth Receipt Time - EXPEDITED EXTENSION] is null then null else
cast([Auth Receipt Date - EXPEDITED EXTENSION]	as datetime) + cast([Auth Receipt Time - EXPEDITED EXTENSION]	as datetime) end Exp_Ext_Auth_Receipt	,
[Decision Date - EXPEDITED EXTENSION] Exp_Ext_Decision_Date	,
[Decision Time - EXPEDITED EXTENSION] Exp_Ext_Decision_Time	,
case when [Decision Date - EXPEDITED EXTENSION] is null or  [Decision Time - EXPEDITED EXTENSION] is null then null else
cast([Decision Date - EXPEDITED EXTENSION]	as datetime) + cast([Decision Time - EXPEDITED EXTENSION]	as datetime) end Exp_Ext_Decision	,
[# of Extension Days - EXPEDITED EXTENSION]			Exp_Ext_Days	,
[MBR Verbal Notif Date - EXPEDITED EXTENSION] Exp_Ext_Mbr_Verbal_Date	,
[MBR Verbal Notif Time - EXPEDITED EXTENSION] Exp_Ext_Mbr_Verbal_Time	,
case when [MBR Verbal Notif Date - EXPEDITED EXTENSION] is null or  [MBR Verbal Notif Time - EXPEDITED EXTENSION] is null then null else
cast([MBR Verbal Notif Date - EXPEDITED EXTENSION]	as datetime) + cast([MBR Verbal Notif Time - EXPEDITED EXTENSION]	as datetime) end Exp_Ext_Mbr_Verbal	,
[MBR Written Notif Date - EXPEDITED EXTENSION] Exp_Ext_Mbr_Written_Date,
[MBR Written Notif Time - EXPEDITED EXTENSION] Exp_Ext_Mbr_Written_Time	,
case when [MBR Written Notif Date - EXPEDITED EXTENSION] is null or  [MBR Written Notif Time - EXPEDITED EXTENSION] is null then null else
cast([MBR Written Notif Date - EXPEDITED EXTENSION]	as datetime) + cast([MBR Written Notif Time - EXPEDITED EXTENSION]	as datetime) end Exp_Ext_Mbr_Written_Raw	,
case when [MBR Written Notif Date - EXPEDITED EXTENSION] is null or  [MBR Written Notif Time - EXPEDITED EXTENSION] is null then null
when [Tracking # - EXPEDITED EXTENSION] like 'Cour%' then cast([MBR Written Notif Date - EXPEDITED EXTENSION]	as datetime) + cast([MBR Written Notif Time - EXPEDITED EXTENSION]	as datetime)
when planname = 'WI' and [MBR Written Notif Time - EXPEDITED EXTENSION] <= '14:00' then cast([MBR Written Notif Date - EXPEDITED EXTENSION]	as datetime) + cast('23:59' as datetime)
when planname = 'WI' and [MBR Written Notif Time - EXPEDITED EXTENSION] > '14:00' and datename(dw,[MBR Written Notif Date - EXPEDITED EXTENSION]) <> 'Saturday'
then cast([MBR Written Notif Date - EXPEDITED EXTENSION]	as datetime) + cast('23:59' as datetime)+1
when planname = 'WI' and [MBR Written Notif Time - EXPEDITED EXTENSION] > '14:00' and datename(dw,[MBR Written Notif Date - EXPEDITED EXTENSION]) = 'Saturday'
then cast([MBR Written Notif Date - EXPEDITED EXTENSION]	as datetime) + cast('23:59' as datetime)+2 
when planname = 'OH' and [MBR Written Notif Time - EXPEDITED EXTENSION] <= '16:00' then cast([MBR Written Notif Date - EXPEDITED EXTENSION]	as datetime) + cast('23:59' as datetime)
when planname = 'OH' and [MBR Written Notif Time - EXPEDITED EXTENSION] > '16:00' and datename(dw,[MBR Written Notif Date - EXPEDITED EXTENSION]) <> 'Saturday'
then cast([MBR Written Notif Date - EXPEDITED EXTENSION]	as datetime) + cast('23:59' as datetime)+1
when planname = 'OH' and [MBR Written Notif Time - EXPEDITED EXTENSION] > '16:00' and datename(dw,[MBR Written Notif Date - EXPEDITED EXTENSION]) = 'Saturday'
then cast([MBR Written Notif Date - EXPEDITED EXTENSION]	as datetime) + cast('23:59' as datetime)+2 
when [MBR Written Notif Time - EXPEDITED EXTENSION] <= '15:45' then cast([MBR Written Notif Date - EXPEDITED EXTENSION]	as datetime) + cast('23:59' as datetime)
when [MBR Written Notif Time - EXPEDITED EXTENSION] > '15:45' and datename(dw,[MBR Written Notif Date - EXPEDITED EXTENSION]) <> 'Saturday'
then cast([MBR Written Notif Date - EXPEDITED EXTENSION]	as datetime) + cast('23:59' as datetime)+1
when [MBR Written Notif Time - EXPEDITED EXTENSION] > '15:45' and datename(dw,[MBR Written Notif Date - EXPEDITED EXTENSION]) = 'Saturday'
then cast([MBR Written Notif Date - EXPEDITED EXTENSION]	as datetime) + cast('23:59' as datetime)+2 
end Exp_Ext_Mbr_Written	,
[Mailed Expedited - EXPEDITED EXTENSION]				Mailed_Exp_Ext	,
[Delivery Receipt Date - EXPEDITED EXTENSION]				Delivery_Date_Exp_Ext	,
Exp_Delivery_Time_Exp_Ext = [Expedited Delivery Receipt Time - EXPEDITED EXTENSION],
case when [Delivery Receipt Date - EXPEDITED EXTENSION] is null or  [Expedited Delivery Receipt Time - EXPEDITED EXTENSION] is null then null else
cast([Delivery Receipt Date - EXPEDITED EXTENSION] as datetime) + cast([Expedited Delivery Receipt Time - EXPEDITED EXTENSION] as datetime) end Exp_Ext_Delivery,
[Tracking # - EXPEDITED EXTENSION]				Tracking_Exp_Ext	,
[PROV Notif Date - EXPEDITED EXTENSION] Exp_Ext_Prov_Date	,
[PROV Notif Time - EXPEDITED EXTENSION]	Exp_Ext_Prov_Time	,
case when [PROV Notif Date - EXPEDITED EXTENSION] is null or [PROV Notif Time - EXPEDITED EXTENSION] is null then null else
cast([PROV Notif Date - EXPEDITED EXTENSION]	as datetime) + cast([PROV Notif Time - EXPEDITED EXTENSION]	as datetime) end Exp_Ext_Prov,
[PROV Written Notif Date - EXPEDITED EXTENSION] Exp_Ext_Prov_Written_Date	,
[PROV Written Notif Time - EXPEDITED EXTENSION] Exp_Ext_Prov_Written_Time	,
case when [PROV Written Notif Date - EXPEDITED EXTENSION] is null or [PROV Written Notif Time - EXPEDITED EXTENSION] is null then null else
cast([PROV Written Notif Date - EXPEDITED EXTENSION]	as datetime) + cast([PROV Written Notif Time - EXPEDITED EXTENSION]	as datetime) end Exp_Ext_Prov_Written,
-----#-----/* Ex Non Par */
[PROV Verbal/ Fax Req Date - EXPEDITED NON PAR PROV MORE INFO] Exp_NonPar_Prov_Date,
[PROV Verbal/ Fax Req Time - EXPEDITED NON PAR PROV MORE INFO] Exp_NonPar_Prov_Time,
case when [PROV Verbal/ Fax Req Date - EXPEDITED NON PAR PROV MORE INFO] is null or [PROV Verbal/ Fax Req Time - EXPEDITED NON PAR PROV MORE INFO] is null then null else
cast([PROV Verbal/ Fax Req Date - EXPEDITED NON PAR PROV MORE INFO]	as datetime) + cast([PROV Verbal/ Fax Req Time - EXPEDITED NON PAR PROV MORE INFO]	as datetime) end Exp_NonPar_Prov ,
-----#-----/* Standard Approval */
[Auth Receipt Date - STANDARD APPROVAL] Std_Appr_Auth_Receipt_Date,
[Auth Receipt Time - STANDARD APPROVAL] Std_Appr_Auth_Receipt_Time,
cast([Auth Receipt Date - STANDARD APPROVAL]	as datetime) + cast([Auth Receipt Time - STANDARD APPROVAL]	as datetime) 	Std_Appr_Auth_Receipt	,
[Decision Date - STANDARD APPROVAL] Std_Appr_Decision_Date,
[Decision Time - STANDARD APPROVAL] Std_Appr_Decision_Time,
cast([Decision Date - STANDARD APPROVAL] as datetime) + cast([Decision Time - STANDARD APPROVAL] as datetime)	Std_Appr_Decision	,
[MBR Verbal Notif Date - STANDARD APPROVAL]				Std_Appr_Mbr_Verbal	,
[MBR Verbal Notif Time - STANDARD APPROVAL]				Std_Appr_Mbr_Verbal_Time	,
cast([MBR Verbal Notif Date - STANDARD APPROVAL] as datetime) + cast([MBR Verbal Notif Time - STANDARD APPROVAL] as datetime)	Std_Appr_Mbr_Verbal_Datetime	,
[MBR Written Notif Date - STANDARD APPROVAL]				Std_Appr_Mbr_Written	,
[MBR Written Notif Time - STANDARD APPROVAL]				Std_Appr_Mbr_Written_Time	,
cast([MBR Written Notif Date - STANDARD APPROVAL] as datetime) + cast([MBR Written Notif Time - STANDARD APPROVAL] as datetime)	Std_Appr_Mbr_Written_Datetime	,
[Mailed Expedited - STANDARD APPROVAL]				Mailed_Exp_Std_Appr	,
[Delivery Receipt Date - STANDARD APPROVAL]				Delivery_Date_Std_Appr	,
[Tracking # - STANDARD APPROVAL]				Tracking_Std_Appr	,
[PROV Notif Date - STANDARD APPROVAL]				Std_Appr_Prov	,
[PROV Notif Time - STANDARD APPROVAL]				Std_Appr_Prov_Time	,
cast([PROV Notif Date - STANDARD APPROVAL] as datetime) + cast([PROV Notif Time - STANDARD APPROVAL] as datetime)	Std_Appr_Prov_Datetime	,
-----#-----/* Standard Denial */
[Auth Receipt Date - STANDARD DENIAL] Std_Deny_Auth_Receipt_Date,
[Auth Receipt Time - STANDARD DENIAL] Std_Deny_Auth_Receipt_Time,
cast([Auth Receipt Date - STANDARD DENIAL]	as datetime) + cast([Auth Receipt Time - STANDARD DENIAL]	as datetime)  Std_Deny_Auth_Receipt,
[Decision Date - STANDARD DENIAL] Std_Deny_Decision_Date,
[Decision Time - STANDARD DENIAL] Std_Deny_Decision_Time,
cast([Decision Date - STANDARD DENIAL] as datetime) + cast([Decision Time - STANDARD DENIAL] as datetime)	Std_Deny_Decision,
[MBR Verbal Notif Date - STANDARD DENIAL]				Std_Deny_Mbr_Verbal,
[MBR Verbal Notif Time - STANDARD DENIAL]				Std_Deny_Mbr_Verbal_Time,
cast([MBR Verbal Notif Date - STANDARD DENIAL] as datetime) + cast([MBR Verbal Notif Time - STANDARD DENIAL] as datetime)	Std_Deny_MBR_Verbal_Datetime,
[MBR Written Notif Date - STANDARD DENIAL]				Std_Deny_Mbr_Written,
[MBR Written Notif Time - STANDARD DENIAL]				Std_Deny_Mbr_Written_Time,
cast([MBR Written Notif Date - STANDARD DENIAL] as datetime) + cast([MBR Written Notif Time - STANDARD DENIAL] as datetime)	Std_Deny_MBR_Written_Datetime,
[Mailed Expedited - STANDARD DENIAL]				Mailed_Exp_Std_Deny,
[Delivery Receipt Date - STANDARD DENIAL]				Delivery_Date_Std_Deny,
[Tracking # - STANDARD DENIAL]				Tracking_Std_Deny,
[PROV Notif Date - STANDARD DENIAL]				Std_Deny_Prov,
[PROV Notif Time - STANDARD DENIAL]				Std_Deny_Prov_Time,
cast([PROV Notif Date - STANDARD DENIAL] as datetime) + cast([PROV Notif Time - STANDARD DENIAL] as datetime)	Std_Deny_Prov_Datetime,
[PROV Written Notif Date - STANDARD DENIAL]				Std_Deny_Prov_Written,
[PROV Written Notif Time - STANDARD DENIAL]				Std_Deny_Prov_Written_Time,
cast([PROV Written Notif Date - STANDARD DENIAL] as datetime) + cast([PROV Written Notif Time - STANDARD DENIAL] as datetime)	Std_Deny_Prov_Written_Datetime,
-----#-----/* Standard Extension */
[Auth Receipt Date - STANDARD EXTENSION] as Std_Ext_Auth_Receipt_Date,
[Auth Receipt Time - STANDARD EXTENSION] as Std_Ext_Auth_Receipt_Time,
cast([Auth Receipt Date - STANDARD EXTENSION]	as datetime) + cast([Auth Receipt Time - STANDARD EXTENSION]	as datetime)  Std_Ext_Auth_Receipt	,
[Decision Date - STANDARD EXTENSION] as Std_Ext_Decision_Date,
[Decision Time - STANDARD EXTENSION] as Std_Ext_Decision_Time,
cast([Decision Date - STANDARD EXTENSION]	as datetime) + cast([Decision Time - STANDARD EXTENSION]	as datetime)  Std_Ext_Decision	,
[# of Extension Days - STANDARD EXTENSION]			Std_Ext_Days	,
[MBR Verbal Notif Date - STANDARD EXTENSION]				Std_Ext_Mbr_Verbal	,
[MBR Written Notif Date - STANDARD EXTENSION]				Std_Ext_Mbr_Written	,
[Delivery Receipt Date - STANDARD EXTENSION]				Delivery_Date_Std_Ext	,
[Mailed Expedited - STANDARD EXTENSION]				Mailed_Exp_Std_Ext	,
[Tracking # - STANDARD EXTENSION]		Tracking_Std_Ext,	
[PROV Notif Date - STANDARD EXTENSION]				Std_Ext_Prov	,
[PROV Written Notif Date - STANDARD EXTENSION]		Std_Ext_Prov_Written
, case when acuity = 'urgent' then [# of Extension Days - EXPEDITED EXTENSION]			
when acuity = 'elective' then [# of Extension Days - STANDARD EXTENSION] end Extension_Days	
,[Extension - No Group] Extension_Date
into sheiladb.dbo.DARR_Attributes_For_Calc from #DARR_Attributes_For_Calc a

update sheiladb.dbo.DARR_Attributes_For_Calc
set [Auth Receipt Date - EXPEDITED APPROVAL]=cast(receiptdate as date),[Auth Receipt Time - EXPEDITED APPROVAL]=cast(receiptdate as time)
where dbname = 'IL' and receiptdate >= '2019-10-05' and receiptdate < '2020-05-01' and acuity = 'urgent' and (authstatus = 'APPROVED' or partial = 'Y')
update sheiladb.dbo.DARR_Attributes_For_Calc
set [Auth Receipt Date - EXPEDITED DENIAL]=cast(receiptdate as date),[Auth Receipt Time - EXPEDITED DENIAL]=cast(receiptdate as time)
where dbname = 'IL' and receiptdate >= '2019-10-05' and receiptdate < '2020-05-01' and acuity = 'urgent' and (authstatus = 'DENIED' or partial = 'Y' or Effective_Denial = 'Y')
update sheiladb.dbo.DARR_Attributes_For_Calc
set [Auth Receipt Date - STANDARD APPROVAL]=cast(receiptdate as date),[Auth Receipt Time - STANDARD APPROVAL]=cast(receiptdate as time)
where dbname = 'IL' and receiptdate >= '2019-10-05' and receiptdate < '2020-05-01' and acuity = 'elective' and (authstatus = 'APPROVED' or partial = 'Y')
update sheiladb.dbo.DARR_Attributes_For_Calc
set [Auth Receipt Date - STANDARD DENIAL]=cast(receiptdate as date),[Auth Receipt Time - STANDARD DENIAL]=cast(receiptdate as time)
where dbname = 'IL' and receiptdate >= '2019-10-05' and receiptdate < '2020-05-01' and acuity = 'elective' and (authstatus = 'DENIED' or partial = 'Y' or Effective_Denial = 'Y')
update sheiladb.dbo.DARR_Attributes_For_Calc
set [Auth Receipt Date - EXPEDITED EXTENSION]=cast(receiptdate as date),[Auth Receipt Time - EXPEDITED EXTENSION]=cast(receiptdate as time)
where dbname = 'IL' and receiptdate >= '2019-10-05' and receiptdate < '2020-05-01' and acuity = 'urgent' and ext=1
update sheiladb.dbo.DARR_Attributes_For_Calc
set [Auth Receipt Date - STANDARD EXTENSION]=cast(receiptdate as date),[Auth Receipt Time - STANDARD EXTENSION]=cast(receiptdate as time)
where dbname = 'IL' and receiptdate >= '2019-10-05' and receiptdate < '2020-05-01' and acuity = 'urgent' and ext=1
--[Auth Receipt Date - EXPEDITED CRITERIA NOT MET],[Auth Receipt Time - EXPEDITED CRITERIA NOT MET],

if object_id('sheiladb.dbo.DARR_Misc_Attr') is not null drop table sheiladb.dbo.DARR_Misc_Attr
select distinct a.referralid, a.dbname, b.date_value TOC_DC_Ord_to_PCP, c.date_value TOC_Verified_Fac, d.date_value TOC_Verified_DC_Plan_Sent,e.date_value TOC_Appr_Ed_to_Prov
, f.date_value TOC_Appr_ED_to_Mem, g.date_value TOC_Notif_Emergent_Admit,h.date_value Modified_Serv_Req, i.date_value Modified_Serv, t.thevalue Retro_Review
, hh.thevalue HH_Cont_Servs
into sheiladb.dbo.DARR_Misc_Attr from sheiladb.dbo.DARR_Inclusion a 
left join sheiladb.dbo.DARR_Date b on b.referralid = a.referralid and b.dbname = a.dbname and b.description = 'ToC – Discharge Orders or Summary sent to PCP'
left join sheiladb.dbo.DARR_Date c on c.referralid = a.referralid and c.dbname = a.dbname and c.description = 'TOC – Verified Facility notified Member of Discharge'
left join sheiladb.dbo.DARR_Date d on d.referralid = a.referralid and d.dbname = a.dbname and d.description = 'ToC – Verified Discharge Plan sent to Receiving Provider'
left join sheiladb.dbo.DARR_Date e on e.referralid = a.referralid and e.dbname = a.dbname and e.description = 'ToC - Approval, Preadmit Education faxed to Requested Prov'
left join sheiladb.dbo.DARR_Date f on f.referralid = a.referralid and f.dbname = a.dbname and f.description = 'ToC – Approval, Preadmit Education & PHR sent to Mbr'
left join sheiladb.dbo.DARR_Date g on g.referralid = a.referralid and g.dbname = a.dbname and g.description = 'ToC – Notification of Emergent Admission sent to PCP'
left join sheiladb.dbo.DARR_Date h on h.referralid = a.referralid and h.dbname = a.dbname and h.description = 'MODIFIED SERVICE REQUEST'
left join sheiladb.dbo.DARR_Date i on i.referralid = a.referralid and i.dbname = a.dbname and i.description = 'Modified Service'
left join sheiladb.dbo.DARR_Text_Range t on t.referralid = a.referralid and t.dbname = a.dbname and t.description = 'Retro Review'
left join sheiladb.dbo.DARR_Text_Range hh on hh.referralid = a.referralid and hh.dbname = a.dbname and hh.description = 'HH Continued Services'
where b.referralid is not null or c.referralid is not null or d.referralid is not null or e.referralid is not null or f.referralid is not null or g.referralid is not null
or h.referralid is not null or i.referralid is not null or t.referralid is not null or hh.referralid is not null

--calc tat IP admit decision 
if object_id('sheiladb.dbo.DARR_IPDates') is not null drop table sheiladb.dbo.DARR_IPDates
select a.dbname db, a.referralid ref_id, a.authorizationid auth_id, ir.IP_Auth_Receipt, id.IP_Decision
into sheiladb.dbo.DARR_IPDates from sheiladb.dbo.DARR_Inclusion a
left join
(select distinct b.dbname, b.referralid, b.authorizationid, case when b.date_value is not null and c.time_value is not null then cast(b.date_value as datetime) + cast(c.time_value as datetime) end IP_Auth_Receipt, b.thegroup
	from sheiladb.dbo.DARR_Inclusion a 
	join sheiladb.dbo.DARR_Date b on b.referralid = a.referralid and a.dbname = b.dbname and b.description = 'Auth Receipt Date' and b.thegroup in ('No Group','')
	join sheiladb.dbo.DARR_Time c on c.referralid = a.referralid and c.dbname = a.dbname and c.description = 'Auth Receipt Time' and c.thegroup in ('No Group','')
	where a.acuity = 'emergency') ir on ir.referralid = a.referralid and ir.dbname = a.dbname
left join
(select distinct b.dbname, b.referralid, b.authorizationid,  case when b.date_value is not null and c.time_value is not null then cast(b.date_value as datetime) + cast(c.time_value as datetime) end IP_Decision, b.thegroup
	from sheiladb.dbo.DARR_Inclusion a 
	join sheiladb.dbo.DARR_Date b on b.referralid = a.referralid and a.dbname = b.dbname and b.description = 'Decision Date'  and b.thegroup in ('No Group','')
	join sheiladb.dbo.DARR_Time c on c.referralid = a.referralid and c.dbname = a.dbname and c.description = 'Decision Time'  and c.thegroup in ('No Group','')
	where a.acuity = 'emergency') id on id.referralid = a.referralid and id.dbname = a.dbname
where a.acuity = 'emergency'

--Calculate TAT
if object_id('sheiladb.dbo.DARR_Calc') is not null drop table sheiladb.dbo.DARR_Calc  
select distinct c.*, std_app_attr, exp_app_attr, std_den_attr, exp_den_attr
, Part_B = case when ((receiptdate >= '2020-01-01' and receiptdate <> '2078-12-31') or Exp_Appr_Auth_Receipt >= '2020-01-01' or Exp_Deny_Auth_Receipt >= '2020-01-01'
or Std_Appr_Auth_Receipt >= '2020-01-01' or Std_Deny_Auth_Receipt >= '2020-01-01')
and servicecode in ('120','1022') then 'Y' else '' end
, Match_Attribute = case when Match_Auth_Receipt is null or Match_Decision is null then null
	when acuity = 'urgent' and authstatus = 'approved' then 'EXPEDITED APPROVAL' when acuity = 'urgent' and authstatus = 'denied' then 'EXPEDITED DENIAL'
	when acuity in ('elective','emergency') and authstatus = 'approved' then 'STANDARD APPROVAL' when acuity in ('elective','emergency') and authstatus = 'denied' then 'STANDARD DENIAL' 	end
,TAT_Exp_Appr_Decision_HH = case when exp_appr_decision is not null and exp_appr_auth_receipt is not null  
	then datediff(mi,exp_appr_auth_receipt,exp_appr_decision)/60.00 end
,TAT_Exp_Appr_Decision_DD = case when exp_appr_decision is not null and exp_appr_auth_receipt is not null  
	then datediff(hh,exp_appr_auth_receipt,exp_appr_decision)/24.00 end
,TAT_Exp_Deny_Decision_HH = case when exp_deny_decision is not null and exp_deny_auth_receipt is not null  
	then datediff(mi,exp_deny_auth_receipt,exp_deny_decision)/60.00 end
,TAT_Exp_Deny_Decision_DD = case when exp_deny_decision is not null and exp_deny_auth_receipt is not null  
	then datediff(hh,exp_deny_auth_receipt,exp_deny_decision)/24.00 end
,TAT_Exp_Ext_Decision_HH = case when exp_ext_decision is not null and exp_ext_auth_receipt is not null   
	then datediff(mi,exp_ext_auth_receipt,exp_ext_decision)/60.00 end
,TAT_Exp_Ext_Decision_DD = case when exp_ext_decision is not null and exp_ext_auth_receipt is not null   
	then datediff(hh,exp_ext_auth_receipt,exp_ext_decision)/24.00 end
,TAT_Std_Appr_Decision_DD = case when Std_Appr_Decision_Date is not null and Std_Appr_Auth_Receipt_Date is not null   
	then datediff(hh,Std_Appr_Auth_Receipt_Date,Std_Appr_Decision_Date)/24.00 end
,TAT_Std_Appr_Decision_HH = case when Std_Appr_Decision is not null and Std_Appr_Auth_Receipt is not null   
	then datediff(mi,Std_Appr_Auth_Receipt,Std_Appr_Decision)/60.00 end
,TAT_Std_Appr_Mbr_Verbal_DD	= case when Std_Appr_Auth_Receipt_Date is not null and Std_Appr_Mbr_Verbal is not null 
	then datediff(hh,Std_Appr_Auth_Receipt_Date,Std_Appr_Mbr_Verbal)/24.00 end
,TAT_Std_Appr_Mbr_Verbal_HH = case when Std_Appr_Mbr_Verbal_Datetime is not null and Std_Appr_Auth_Receipt is not null   
	then datediff(mi,Std_Appr_Auth_Receipt,Std_Appr_Mbr_Verbal_Datetime)/60.00 end
,TAT_Std_Appr_Mbr_Written_DD = case when Std_Appr_Auth_Receipt_Date is not null and Std_Appr_Mbr_Written is not null 
	then datediff(hh,Std_Appr_Auth_Receipt_Date,Std_Appr_Mbr_Written)/24.00 end
,TAT_Std_Appr_Mbr_Written_HH = case when Std_Appr_Mbr_Written_Datetime is not null and Std_Appr_Auth_Receipt is not null   
	then datediff(mi,Std_Appr_Auth_Receipt,Std_Appr_Mbr_Written_Datetime)/60.00 end
,TAT_Std_Appr_Prov_DD = case when Std_Appr_Auth_Receipt_Date is not null and Std_Appr_Prov is not null 
	then datediff(hh,Std_Appr_Auth_Receipt_Date,Std_Appr_Prov)/24.00 end
,TAT_Std_Appr_Prov_HH = case when Std_Appr_Prov_Datetime is not null and Std_Appr_Auth_Receipt is not null   
	then datediff(mi,Std_Appr_Auth_Receipt,Std_Appr_Prov_Datetime)/60.00 end
,TAT_Std_Deny_Decision_DD = case when Std_Deny_Decision_Date is not null and std_deny_auth_receipt_Date is not null   
	then datediff(hh,Std_Deny_Auth_Receipt_Date,Std_Deny_Decision_Date)/24.00 end
,TAT_Std_Deny_Decision_HH = case when Std_Deny_Auth_Receipt is not null and Std_Deny_Decision is not null   
	then datediff(mi,Std_Deny_Auth_Receipt,Std_Deny_Decision)/60.00 end
,TAT_Std_Deny_Mbr_Verbal_DD	= case when Std_Deny_Auth_Receipt_Date is not null and Std_Deny_Mbr_Verbal is not null 
	then datediff(hh,Std_Deny_Auth_Receipt_Date,Std_Deny_Mbr_Verbal)/24.00 end
,TAT_Std_Deny_Mbr_Verbal_HH = case when Std_Deny_Auth_Receipt is not null and Std_Deny_MBR_Verbal_Datetime is not null   
	then datediff(mi,Std_Deny_Auth_Receipt,Std_Deny_MBR_Verbal_Datetime)/60.00 end
,TAT_Std_Deny_Mbr_Written_DD = case when Std_Deny_Auth_Receipt_Date is not null and Std_Deny_Mbr_Written is not null 
	then datediff(hh,Std_Deny_Auth_Receipt_Date,Std_Deny_Mbr_Written)/24.00 end
,TAT_Std_Deny_Mbr_Written_HH = case when Std_Deny_Auth_Receipt is not null and Std_Deny_MBR_Written_Datetime is not null   
	then datediff(mi,Std_Deny_Auth_Receipt,Std_Deny_MBR_Written_Datetime)/60.00 end
,TAT_Std_Deny_Prov_DD = case when Std_Deny_Auth_Receipt_Date is not null and Std_Deny_Prov is not null 
	then datediff(hh,Std_Deny_Auth_Receipt_Date,Std_Deny_Prov)/24.00 end
,TAT_Std_Deny_Prov_HH = case when Std_Deny_Auth_Receipt is not null and Std_Deny_Prov_Datetime is not null   
	then datediff(mi,Std_Deny_Auth_Receipt,Std_Deny_Prov_Datetime)/60.00 end
,TAT_Std_Deny_Prov_Written_DD = case when Std_Deny_Auth_Receipt_Date is not null and Std_Deny_Prov_Written is not null 
	then datediff(hh,Std_Deny_Auth_Receipt_Date,Std_Deny_Prov_Written)/24.00 end
,TAT_Std_Deny_Prov_Written_HH = case when Std_Deny_Auth_Receipt is not null and Std_Deny_Prov_Written_Datetime is not null   
	then datediff(mi,Std_Deny_Auth_Receipt,Std_Deny_Prov_Written_Datetime)/60.00 end
,TAT_Std_Ext_Decision_DD = case when Std_Ext_Decision_Date is not null and std_ext_auth_receipt_Date is not null 
	then datediff(hh,Std_Ext_Auth_Receipt_Date,Std_Ext_Decision_Date)/24.00 end
,TAT_Std_Ext_Mbr_Verbal_DD	= case when Std_Ext_Auth_Receipt_Date is not null and Std_Ext_Mbr_Verbal is not null 
	then datediff(hh,Std_Ext_Auth_Receipt_Date,Std_Ext_Mbr_Verbal)/24.00 end
,TAT_Std_Ext_Mbr_Written_DD	= case when Std_Ext_Auth_Receipt_Date is not null and Std_Ext_Mbr_Written is not null 
	then datediff(hh,Std_Ext_Auth_Receipt_Date,Std_Ext_Mbr_Written)/24.00 end
,TAT_Std_Ext_Prov_DD = case when Std_Ext_Auth_Receipt_Date is not null and Std_Ext_Prov is not null 
	then datediff(hh,Std_Ext_Auth_Receipt_Date,Std_Ext_Prov)/24.00 end
,TAT_Std_Ext_Prov_Written_DD = case when Std_Ext_Auth_Receipt_Date is not null and Std_Ext_Prov_Written is not null 
	then datediff(hh,Std_Ext_Auth_Receipt_Date,Std_Ext_Prov_Written)/24.00 end
,TAT_Exp_Appr_Mbr_Verbal_HH	=	 case when exp_appr_mbr_verbal is not null and exp_appr_auth_receipt is not null  
	then datediff(mi,exp_appr_auth_receipt,exp_appr_mbr_verbal)/60.00 end,
TAT_Exp_Appr_Mbr_Verbal_DD	=	 case when exp_appr_mbr_verbal is not null and exp_appr_auth_receipt is not null  
	then datediff(hh,exp_appr_auth_receipt,exp_appr_mbr_verbal)/24.00 end,
TAT_Exp_Appr_Mbr_Written_DD	= case when exp_appr_mbr_written is not null and exp_appr_auth_receipt is not null 
	then datediff(hh,exp_appr_auth_receipt,exp_appr_mbr_written)/24.00 end,
TAT_Exp_Appr_Mbr_Written_HH	= case when exp_appr_mbr_written is not null and exp_appr_auth_receipt is not null 
	then datediff(mi,exp_appr_auth_receipt,exp_appr_mbr_written)/60.00 end,
TAT_Exp_Appr_Prov_DD = case when Exp_Appr_Auth_Receipt is not null and Exp_Appr_Prov is not null 
	then datediff(hh,Exp_Appr_Auth_Receipt,Exp_Appr_Prov)/24.00 end,
TAT_Exp_Appr_Prov_HH = case when Exp_Appr_Auth_Receipt is not null and Exp_Appr_Prov is not null 
	then datediff(mi,Exp_Appr_Auth_Receipt,Exp_Appr_Prov)/60.00 end,
TAT_Exp_Crit_Decision_DD	= case when Exp_Crit_Decision is not null and Match_Auth_Receipt is not null 
	then datediff(hh,Match_Auth_Receipt,Exp_Crit_Decision)/24.00 end,
TAT_Exp_Crit_Decision_HH	= case when Exp_Crit_Decision is not null and Match_Auth_Receipt is not null 
	then datediff(mi,Match_Auth_Receipt,Exp_Crit_Decision)/60.00 end,
TAT_Exp_Crit_Mbr_Verbal_DD	= case when Exp_Crit_Mbr_Verbal is not null and Match_Auth_Receipt is not null 
	then datediff(hh,Match_Auth_Receipt,Exp_Crit_Mbr_Verbal)/24.00 end,
TAT_Exp_Crit_Mbr_Verbal_HH	= case when Exp_Crit_Mbr_Verbal is not null and Match_Auth_Receipt is not null 
	then datediff(mi,Match_Auth_Receipt,Exp_Crit_Mbr_Verbal)/60.00 end,
TAT_Exp_Crit_Mbr_Written_DD = case when Match_Auth_Receipt is not null and Exp_Crit_Mbr_Written is not null 
	then datediff(hh,Match_Auth_Receipt,Exp_Crit_Mbr_Written)/24.00 end,
TAT_Exp_Crit_Mbr_Written_HH = case when Match_Auth_Receipt is not null and Exp_Crit_Mbr_Written is not null
	then datediff(mi,Match_Auth_Receipt,Exp_Crit_Mbr_Written)/60.00 end,
TAT_Exp_Crit_Prov_DD = case when Match_Auth_Receipt is not null and Exp_Crit_Prov is not null 
	then datediff(hh,Match_Auth_Receipt,Exp_Crit_Prov)/24.00 end,
TAT_Exp_Crit_Prov_HH = case when Match_Auth_Receipt is not null and Exp_Crit_Prov is not null 
	then datediff(mi,Match_Auth_Receipt,Exp_Crit_Prov)/60.00 end,
TAT_Exp_Crit_Prov_Written_DD = case when Match_Auth_Receipt is not null and Exp_Crit_Prov_Written is not null 
	then datediff(hh,Match_Auth_Receipt,Exp_Crit_Prov_Written)/24.00 end,
TAT_Exp_Crit_Prov_Written_HH = case when Match_Auth_Receipt is not null and Exp_Crit_Prov_Written is not null 
	then datediff(mi,Match_Auth_Receipt,Exp_Crit_Prov_Written)/60.00 end,
TAT_Exp_Deny_Mbr_Verbal_DD	= case when Exp_Deny_Auth_Receipt is not null and Exp_Deny_Mbr_Verbal is not null 
	then datediff(hh,Exp_Deny_Auth_Receipt,Exp_Deny_Mbr_Verbal)/24.00 end,
TAT_Exp_Deny_Mbr_Verbal_HH	= case when Exp_Deny_Auth_Receipt is not null and Exp_Deny_Mbr_Verbal is not null 
	then datediff(mi,Exp_Deny_Auth_Receipt,Exp_Deny_Mbr_Verbal)/60.00 end,
TAT_Exp_Deny_Mbr_Written_DD	= case when Exp_Deny_Auth_Receipt is not null and Exp_Deny_Mbr_Written is not null 
	then datediff(hh,Exp_Deny_Auth_Receipt,Exp_Deny_Mbr_Written)/24.00 end,
TAT_Exp_Deny_Mbr_Written_HH	= case when Exp_Deny_Auth_Receipt is not null and Exp_Deny_Mbr_Written is not null 
	then datediff(mi,Exp_Deny_Auth_Receipt,Exp_Deny_Mbr_Written)/60.00 end,
TAT_Exp_Deny_Prov_DD = case when Exp_Deny_Auth_Receipt is not null and Exp_Deny_Prov is not null
	then datediff(hh,Exp_Deny_Auth_Receipt,Exp_Deny_Prov)/24.00 end,
TAT_Exp_Deny_Prov_HH = case when Exp_Deny_Auth_Receipt is not null and Exp_Deny_Prov is not null
	then datediff(mi,Exp_Deny_Auth_Receipt,Exp_Deny_Prov)/60.00 end,
TAT_Exp_Deny_Prov_Written_DD = case when Exp_Deny_Auth_Receipt is not null and Exp_Deny_Prov_Written is not null
	then datediff(hh,Exp_Deny_Auth_Receipt,Exp_Deny_Prov_Written)/24.00 end,
TAT_Exp_Deny_Prov_Written_HH = case when Exp_Deny_Auth_Receipt is not null and Exp_Deny_Prov_Written is not null
	then datediff(hh,Exp_Deny_Auth_Receipt,Exp_Deny_Prov_Written)/60.00 end,
TAT_Exp_Ext_Mbr_Verbal_DD = case when Exp_Ext_Auth_Receipt is not null and Exp_Ext_Mbr_Verbal is not null
	then datediff(hh,Exp_Ext_Auth_Receipt,Exp_Ext_Mbr_Verbal)/24.00 end,
TAT_Exp_Ext_Mbr_Verbal_HH = case when Exp_Ext_Auth_Receipt is not null and Exp_Ext_Mbr_Verbal is not null
	then datediff(mi,Exp_Ext_Auth_Receipt,Exp_Ext_Mbr_Verbal)/60.00 end,
TAT_Exp_Ext_Mbr_Written_DD	= case when Exp_Ext_Auth_Receipt is not null and Exp_Ext_Mbr_Written is not null
	then datediff(hh,Exp_Ext_Auth_Receipt,Exp_Ext_Mbr_Written)/24.00 end,
TAT_Exp_Ext_Mbr_Written_HH	= case when Exp_Ext_Auth_Receipt is not null and Exp_Ext_Mbr_Written is not null 
	then datediff(mi,Exp_Ext_Auth_Receipt,Exp_Ext_Mbr_Written)/60.00 end,
TAT_Exp_Ext_Prov_DD = case when Exp_Ext_Auth_Receipt is not null and Exp_Ext_Prov is not null 
	then datediff(hh,Exp_Ext_Auth_Receipt,Exp_Ext_Prov)/60.00 end,
TAT_Exp_Ext_Prov_HH = case when Exp_Ext_Auth_Receipt is not null and Exp_Ext_Prov is not null 
	then datediff(mi,Exp_Ext_Auth_Receipt,Exp_Ext_Prov)/24.00 end,
TAT_Exp_Ext_Prov_Written_DD = case when Exp_Ext_Auth_Receipt is not null and Exp_Ext_Prov_Written is not null 
	then datediff(hh,Exp_Ext_Auth_Receipt,Exp_Ext_Prov_Written)/24.00 end,
TAT_Exp_Ext_Prov_Written_HH = case when Exp_Ext_Auth_Receipt is not null and Exp_Ext_Prov_Written is not null 
	then datediff(mi,Exp_Ext_Auth_Receipt,Exp_Ext_Prov_Written)/60.00 end,
TAT_Exp_NonPar_Prov_HH	= case when Match_Auth_Receipt is not null and Exp_NonPar_Prov is not null 
	then datediff(mi,Match_Auth_Receipt,Exp_NonPar_Prov)/60.00 end,
TAT_Exp_NonPar_Prov_DD	= case when Match_Auth_Receipt is not null and Exp_NonPar_Prov is not null 
	then datediff(hh,Match_Auth_Receipt,Exp_NonPar_Prov)/24.00 end
,IP_Auth_Receipt,IP_Decision
, floor(datediff(mi,d.IP_Auth_Receipt, d.IP_Decision)/60.0) IP_TAT_Hours, floor(datediff(hh,d.IP_Auth_Receipt,d.IP_Decision)/24.00) IP_TAT_Days
into sheiladb.dbo.DARR_Calc 
from sheiladb.dbo.DARR_Attributes_For_Calc c 
left join sheiladb.dbo.DARR_IPDates d on d.ref_id = c.referralid and d.db = c.dbname
left join (select distinct dbname db, referralid ref, effective_denial, std_app_attr, exp_app_attr, std_den_attr, exp_den_attr from sheiladb.dbo.DARR_Appeal_Mod)
	 am on am.ref = c.referralid and am.db = c.dbname
	 
update sheiladb.dbo.DARR_Calc 
set TAT_Std_Deny_Prov_Written_DD = TAT_Std_Deny_Mbr_Written_DD
, TAT_Std_Deny_Prov_Written_HH = TAT_Std_Deny_Mbr_Written_HH
,Std_Deny_Prov_Written = Std_Deny_MBR_Written
,Std_Deny_Prov_Written_Time = Std_Deny_MBR_Written_Time
,Std_Deny_Prov_Written_Datetime = Std_Deny_MBR_Written_Datetime
where Std_Deny_Prov_Written is null and std_deny_mbr_written is not null and acuity = 'elective' 
and (authstatus = 'DENIED' or partial = 'y'  or Effective_Denial = 'Y')

--Prime Field
if object_id('tempdb..#t1') is not null drop table #t1
select distinct i.authorizationid, i.referralid, i.dbname,d.thevalue thevalued,d.description descriptiond,d.thegroup thegroupd,t.thevalue thevaluet,t.description descriptiont,t.thegroup thegroupt,d.date_value,t.time_value
,Date_Time_Value = case when date_value is not null and time_value is not null then cast(date_value as datetime)+cast(time_value as datetime) when date_value is not null then cast(date_value as datetime) end
,Field = rtrim(ltrim(replace(d.description, 'date',''))) into #t1 from sheiladb.dbo.DARR_Inclusion i 
left join sheiladb.dbo.DARR_Date d on i.referralid = d.referralid and i.dbname = d.dbname
left join sheiladb.dbo.DARR_Time t on i.referralid = t.referralid and i.dbname = t.dbname and d.thegroup = t.thegroup 
	and rtrim(ltrim(replace(d.description, 'date',''))) = rtrim(ltrim(replace(t.description, 'time','')))

if Object_ID('tempdb..#t2') is not null drop table #t2 
select distinct b.authorizationid, b.ReferralID, b.DBname, a.thegroupd TheGroup,b.Field
,a.date_value auth_rec_date,a.Date_Time_Value auth_rec_datetime, dr.day_name Receipt_Weekday, dr.is_workday Receipt_Workday
,case when dr.is_workday=0 then sheiladb.dbo.fn_priorBusinessDay(a.date_value) else a.date_value end Biz_Receipt
,b.date_value Field_Date,b.Date_Time_Value RAW_Field_DateTime
, case when b.field in ('MBR Written Notif','PROV Written Notif') and cast(b.Date_Time_Value as time) > '15:45' then cast(b.date_value as datetime) + cast('23:59' as datetime) + 1 
when b.field in ('MBR Written Notif','PROV Written Notif') and cou.referralid is null then cast(b.date_value as datetime) + cast('23:59' as datetime) else b.Date_Time_Value end as Field_DateTime
, df.day_name Field_Weekday, df.is_workday Field_Workday, case when df.is_workday=0 then sheiladb.dbo.fn_priorBusinessDay(b.date_value) else b.date_value end Biz_Field
into #t2 from #t1 a join #t1 b on a.referralid = b.referralid and a.dbname = b.dbname and a.thegroupd = b.thegroupd
join sheiladb.dbo.date_reference dr on dr.calendar_date = a.date_value join sheiladb.dbo.date_reference df on df.calendar_date = b.date_value 
left join (select distinct referralid, dbname, thegroup, thevalue from sheiladb.dbo.DARR_Text_Range where description = 'Tracking #' and thevalue like '%cou%') cou on cou.referralid = a.referralid and cou.dbname = a.dbname and cou.thegroup = b.thegroupd
where a.Field = 'Auth Receipt' and b.Field <> 'Auth Receipt'
update #t2 set Field_Date = cast(field_datetime as date)

if Object_ID('tempdb..#t3') is not null drop table #t3 select * ,datediff(mi,auth_rec_datetime,Field_DateTime)/60.0 TAT_HH ,datediff(hh,auth_rec_datetime,Field_DateTime)/24.0 TAT_DD
,case when Biz_Receipt=Biz_Field then '0' else (select sum(is_workday) from sheiladb.dbo.date_reference where calendar_date > Biz_Receipt and calendar_date <= Biz_Field) end TAT_Biz into #t3 from #t2 
if object_Id('sheiladb.dbo.DARR_BizDay') is not null drop table sheiladb.dbo.DARR_BizDay
select * into sheiladb.dbo.DARR_BizDay from #t3

update sheiladb.dbo.DARR_Calc 
set TAT_Exp_Appr_Decision_DD = b.TAT_Biz from sheiladb.dbo.DARR_Calc c join sheiladb.dbo.DARR_BizDay b on c.referralid = b.referralid and c.dbname = b.dbname
where c.dbname = 'TX' and b.thegroup = 'EXPEDITED APPROVAL' and b.Field = 'Decision'
update sheiladb.dbo.DARR_Calc 
set TAT_Exp_Deny_Decision_DD = b.TAT_Biz from sheiladb.dbo.DARR_Calc c join sheiladb.dbo.DARR_BizDay b on c.referralid = b.referralid and c.dbname = b.dbname
where c.dbname = 'TX' and b.thegroup = 'EXPEDITED DENIAL' and b.Field = 'Decision'
update sheiladb.dbo.DARR_Calc 
set TAT_Exp_Ext_Decision_DD = b.TAT_Biz from sheiladb.dbo.DARR_Calc c join sheiladb.dbo.DARR_BizDay b on c.referralid = b.referralid and c.dbname = b.dbname
where c.dbname = 'TX' and b.thegroup = 'EXPEDITED EXTENSION' and b.Field = 'Decision'
update sheiladb.dbo.DARR_Calc 
set TAT_Std_Appr_Decision_DD = b.TAT_Biz from sheiladb.dbo.DARR_Calc c join sheiladb.dbo.DARR_BizDay b on c.referralid = b.referralid and c.dbname = b.dbname
where c.dbname = 'TX' and b.thegroup = 'STANDARD APPROVAL' and b.Field = 'Decision'
update sheiladb.dbo.DARR_Calc 
set TAT_Std_Deny_Decision_DD = b.TAT_Biz from sheiladb.dbo.DARR_Calc c join sheiladb.dbo.DARR_BizDay b on c.referralid = b.referralid and c.dbname = b.dbname
where c.dbname = 'TX' and b.thegroup = 'STANDARD DENIAL' and b.Field = 'Decision'
update sheiladb.dbo.DARR_Calc 
set TAT_Std_Ext_Decision_DD = b.TAT_Biz from sheiladb.dbo.DARR_Calc c join sheiladb.dbo.DARR_BizDay b on c.referralid = b.referralid and c.dbname = b.dbname
where c.dbname = 'TX' and b.thegroup = 'STANDARD EXTENSION' and b.Field = 'Decision'
update sheiladb.dbo.DARR_Calc 
set TAT_Exp_Appr_Mbr_Verbal_DD = b.TAT_Biz from sheiladb.dbo.DARR_Calc c join sheiladb.dbo.DARR_BizDay b on c.referralid = b.referralid and c.dbname = b.dbname
where c.dbname = 'TX' and b.thegroup = 'EXPEDITED APPROVAL' and b.Field = 'MBR Verbal Notif'
update sheiladb.dbo.DARR_Calc 
set TAT_Exp_Appr_Mbr_Written_DD = b.TAT_Biz from sheiladb.dbo.DARR_Calc c join sheiladb.dbo.DARR_BizDay b on c.referralid = b.referralid and c.dbname = b.dbname
where c.dbname = 'TX' and b.thegroup = 'EXPEDITED APPROVAL' and b.Field = 'MBR Written Notif'
update sheiladb.dbo.DARR_Calc 
set TAT_Exp_Appr_Prov_DD = b.TAT_Biz from sheiladb.dbo.DARR_Calc c join sheiladb.dbo.DARR_BizDay b on c.referralid = b.referralid and c.dbname = b.dbname
where c.dbname = 'TX' and b.thegroup = 'EXPEDITED APPROVAL' and b.Field = 'PROV Notif'
update sheiladb.dbo.DARR_Calc 
set TAT_Exp_Deny_Mbr_Verbal_DD = b.TAT_Biz from sheiladb.dbo.DARR_Calc c join sheiladb.dbo.DARR_BizDay b on c.referralid = b.referralid and c.dbname = b.dbname
where c.dbname = 'TX' and b.thegroup = 'EXPEDITED DENIAL' and b.Field = 'MBR Verbal Notif'
update sheiladb.dbo.DARR_Calc 
set TAT_Exp_Deny_Mbr_Written_DD = b.TAT_Biz from sheiladb.dbo.DARR_Calc c join sheiladb.dbo.DARR_BizDay b on c.referralid = b.referralid and c.dbname = b.dbname
where c.dbname = 'TX' and b.thegroup = 'EXPEDITED DENIAL' and b.Field = 'MBR Written Notif'
update sheiladb.dbo.DARR_Calc 
set TAT_Exp_Deny_Prov_DD = b.TAT_Biz from sheiladb.dbo.DARR_Calc c join sheiladb.dbo.DARR_BizDay b on c.referralid = b.referralid and c.dbname = b.dbname
where c.dbname = 'TX' and b.thegroup = 'EXPEDITED DENIAL' and b.Field = 'PROV Notif'
update sheiladb.dbo.DARR_Calc 
set TAT_Exp_Deny_Prov_Written_DD = b.TAT_Biz from sheiladb.dbo.DARR_Calc c join sheiladb.dbo.DARR_BizDay b on c.referralid = b.referralid and c.dbname = b.dbname
where c.dbname = 'TX' and b.thegroup = 'EXPEDITED DENIAL' and b.Field = 'PROV Written Notif'
update sheiladb.dbo.DARR_Calc 
set TAT_Exp_Ext_Mbr_Verbal_DD = b.TAT_Biz from sheiladb.dbo.DARR_Calc c join sheiladb.dbo.DARR_BizDay b on c.referralid = b.referralid and c.dbname = b.dbname
where c.dbname = 'TX' and b.thegroup = 'EXPEDITED EXTENSION' and b.Field = 'MBR Verbal Notif'
update sheiladb.dbo.DARR_Calc 
set TAT_Exp_Ext_Mbr_Written_DD = b.TAT_Biz from sheiladb.dbo.DARR_Calc c join sheiladb.dbo.DARR_BizDay b on c.referralid = b.referralid and c.dbname = b.dbname
where c.dbname = 'TX' and b.thegroup = 'EXPEDITED EXTENSION' and b.Field = 'MBR Written Notif'
update sheiladb.dbo.DARR_Calc 
set TAT_Exp_Ext_Prov_DD = b.TAT_Biz from sheiladb.dbo.DARR_Calc c join sheiladb.dbo.DARR_BizDay b on c.referralid = b.referralid and c.dbname = b.dbname
where c.dbname = 'TX' and b.thegroup = 'EXPEDITED EXTENSION' and b.Field = 'PROV Notif'
update sheiladb.dbo.DARR_Calc 
set TAT_Exp_Ext_Prov_Written_DD = b.TAT_Biz from sheiladb.dbo.DARR_Calc c join sheiladb.dbo.DARR_BizDay b on c.referralid = b.referralid and c.dbname = b.dbname
where c.dbname = 'TX' and b.thegroup = 'EXPEDITED EXTENSION' and b.Field = 'PROV Written Notif'
update sheiladb.dbo.DARR_Calc 
set TAT_Exp_Crit_Decision_DD = b.TAT_Biz from sheiladb.dbo.DARR_Calc c join sheiladb.dbo.DARR_BizDay b on c.referralid = b.referralid and c.dbname = b.dbname
where c.dbname = 'TX' and b.thegroup = 'EXPEDITED CRITERIA NOT MET' and b.Field = 'Decision Date'
update sheiladb.dbo.DARR_Calc 
set TAT_Exp_Crit_Mbr_Verbal_DD = b.TAT_Biz from sheiladb.dbo.DARR_Calc c join sheiladb.dbo.DARR_BizDay b on c.referralid = b.referralid and c.dbname = b.dbname
where c.dbname = 'TX' and b.thegroup = 'EXPEDITED CRITERIA NOT MET' and b.Field = 'Mbr Verbal Notif'
update sheiladb.dbo.DARR_Calc 
set TAT_Exp_Crit_Mbr_Written_DD = b.TAT_Biz from sheiladb.dbo.DARR_Calc c join sheiladb.dbo.DARR_BizDay b on c.referralid = b.referralid and c.dbname = b.dbname
where c.dbname = 'TX' and b.thegroup = 'EXPEDITED CRITERIA NOT MET' and b.Field = 'Mbr Written Notif'
update sheiladb.dbo.DARR_Calc 
set TAT_Exp_Crit_Prov_DD = b.TAT_Biz from sheiladb.dbo.DARR_Calc c join sheiladb.dbo.DARR_BizDay b on c.referralid = b.referralid and c.dbname = b.dbname
where c.dbname = 'TX' and b.thegroup = 'EXPEDITED CRITERIA NOT MET' and b.Field = 'Prov Notif'
update sheiladb.dbo.DARR_Calc 
set TAT_Exp_Crit_Prov_Written_DD = b.TAT_Biz from sheiladb.dbo.DARR_Calc c join sheiladb.dbo.DARR_BizDay b on c.referralid = b.referralid and c.dbname = b.dbname
where c.dbname = 'TX' and b.thegroup = 'EXPEDITED CRITERIA NOT MET' and b.Field = 'Prov Written Notif'
update sheiladb.dbo.DARR_Calc 
set TAT_Std_Appr_Mbr_Verbal_DD = b.TAT_Biz from sheiladb.dbo.DARR_Calc c join sheiladb.dbo.DARR_BizDay b on c.referralid = b.referralid and c.dbname = b.dbname
where c.dbname = 'TX' and b.thegroup = 'STANDARD APPROVAL' and b.Field = 'MBR Verbal Notif'
update sheiladb.dbo.DARR_Calc 
set TAT_Std_Appr_Mbr_Written_DD = b.TAT_Biz from sheiladb.dbo.DARR_Calc c join sheiladb.dbo.DARR_BizDay b on c.referralid = b.referralid and c.dbname = b.dbname
where c.dbname = 'TX' and b.thegroup = 'STANDARD APPROVAL' and b.Field = 'MBR Written Notif'
update sheiladb.dbo.DARR_Calc 
set TAT_Std_Appr_Prov_DD = b.TAT_Biz from sheiladb.dbo.DARR_Calc c join sheiladb.dbo.DARR_BizDay b on c.referralid = b.referralid and c.dbname = b.dbname
where c.dbname = 'TX' and b.thegroup = 'STANDARD APPROVAL' and b.Field = 'PROV Notif'
update sheiladb.dbo.DARR_Calc 
set TAT_Std_Deny_Mbr_Verbal_DD = b.TAT_Biz from sheiladb.dbo.DARR_Calc c join sheiladb.dbo.DARR_BizDay b on c.referralid = b.referralid and c.dbname = b.dbname
where c.dbname = 'TX' and b.thegroup = 'STANDARD DENIAL' and b.Field = 'MBR Verbal Notif'
update sheiladb.dbo.DARR_Calc 
set TAT_Std_Deny_Mbr_Written_DD = b.TAT_Biz from sheiladb.dbo.DARR_Calc c join sheiladb.dbo.DARR_BizDay b on c.referralid = b.referralid and c.dbname = b.dbname
where c.dbname = 'TX' and b.thegroup = 'STANDARD DENIAL' and b.Field = 'MBR Written Notif'
update sheiladb.dbo.DARR_Calc 
set TAT_Std_Deny_Prov_DD = b.TAT_Biz from sheiladb.dbo.DARR_Calc c join sheiladb.dbo.DARR_BizDay b on c.referralid = b.referralid and c.dbname = b.dbname
where c.dbname = 'TX' and b.thegroup = 'STANDARD DENIAL' and b.Field = 'PROV Notif'
update sheiladb.dbo.DARR_Calc 
set TAT_Std_Deny_Prov_Written_DD = b.TAT_Biz from sheiladb.dbo.DARR_Calc c join sheiladb.dbo.DARR_BizDay b on c.referralid = b.referralid and c.dbname = b.dbname
where c.dbname = 'TX' and b.thegroup = 'STANDARD DENIAL' and b.Field = 'PROV Written Notif'
--,TAT_Std_Ext_Mbr_Verbal_DD,TAT_Std_Ext_Mbr_Written_DD,TAT_Std_Ext_Prov_DD,TAT_Std_Ext_Prov_Written_DD

update sheiladb.dbo.DARR_Calc
set TAT_Exp_Deny_Mbr_Written_DD = case when Exp_Deny_Mbr_Verbal is not null and Exp_Deny_Mbr_Written is not null and Exp_Deny_Mbr_Verbal <= Exp_Deny_Mbr_Written
	then datediff(hh,Exp_Deny_Mbr_Verbal,Exp_Deny_Mbr_Written)/24.00 end
	where TAT_Exp_Deny_Mbr_Verbal_HH <= 72 and TAT_Exp_Deny_Mbr_Verbal_HH >= 0 and dbname not in ('TX','OH') and ext is null

if object_id('sheiladb.dbo.DARR_Compliance') is not null drop table sheiladb.dbo.DARR_Compliance
select distinct *
,Compliant_Exp_Appr_Decision = case when ext = '1' and TAT_Exp_Appr_Decision_DD <=17 and TAT_Exp_Appr_Decision_DD >= 0 then 'Y' 
when ext = '1' and TAT_Exp_Appr_Decision_DD >17 then 'N' when TAT_Exp_Appr_Decision_HH <=72 and TAT_Exp_Appr_Decision_HH >= 0 then 'Y' when TAT_Exp_Appr_Decision_HH >72 then 'N' end
,Compliant_Exp_Appr_Mbr_Verbal = case when ext = '1' and TAT_Exp_Appr_Mbr_Verbal_DD <=17 and TAT_Exp_Appr_Mbr_Verbal_DD >=0 then 'Y' when ext = '1' and TAT_Exp_Appr_Mbr_Verbal_DD >17 then 'N' 
when TAT_Exp_Appr_Mbr_Verbal_HH <=72 and TAT_Exp_Appr_Mbr_Verbal_HH >=0 then 'Y' when TAT_Exp_Appr_Mbr_Verbal_HH >72 then 'N' end
,Compliant_Exp_Appr_Mbr_Written = case when ext = '1' and TAT_Exp_Appr_Mbr_Written_DD <=17 and TAT_Exp_Appr_Mbr_Written_DD >=0 then 'Y' when ext = '1' and TAT_Exp_Appr_Mbr_Written_DD >17 then 'N' 
when TAT_Exp_Appr_Mbr_Written_HH <=72 and TAT_Exp_Appr_Mbr_Written_HH >=0 then 'Y' when TAT_Exp_Appr_Mbr_Written_HH >72 then 'N' end
, Compliant_Exp_Appr_Prov = case when ext = '1' and TAT_Exp_Appr_Prov_DD <=17 and TAT_Exp_Appr_Prov_DD>=0 then 'Y' when ext = '1' and TAT_Exp_Appr_Prov_DD >17 then 'N' 
when TAT_Exp_Appr_Prov_HH <=72 and TAT_Exp_Appr_Prov_HH >=0 then 'Y' when TAT_Exp_Appr_Prov_HH >72 then 'N' end
, Compliant_Exp_Deny_Decision = case when ext = '1' and TAT_Exp_Deny_Decision_DD <=17 and TAT_Exp_Deny_Decision_DD >=0 then 'Y' when ext = '1' and TAT_Exp_Deny_Decision_DD >17 then 'N' 
 when TAT_Exp_Deny_Decision_HH <=72 and TAT_Exp_Deny_Decision_HH>=0 then 'Y' when TAT_Exp_Deny_Decision_HH >72 then 'N' end
 , Compliant_Exp_Deny_Mbr_Verbal = case when ext = '1' and TAT_Exp_Deny_Mbr_Verbal_DD <=17 and TAT_Exp_Deny_Mbr_Verbal_DD >= 0 then 'Y' when ext = '1' and TAT_Exp_Deny_Mbr_Verbal_DD >17 then 'N' 
 when TAT_Exp_Deny_Mbr_Verbal_HH <=72 and TAT_Exp_Deny_Mbr_Verbal_HH>=0 then 'Y' when TAT_Exp_Deny_Mbr_Verbal_HH >72 then 'N' end
, Compliant_Exp_Deny_Mbr_Written = case when ext = '1' and TAT_Exp_Deny_Mbr_Written_DD <=17 and TAT_Exp_Deny_Mbr_Written_DD>=0 then 'Y' 
when ext = '1' and TAT_Exp_Deny_Mbr_Written_DD >17 then 'N' 
when TAT_Exp_Deny_Mbr_Verbal_HH <=72 and TAT_Exp_Deny_Mbr_Verbal_HH >=0 and TAT_Exp_Deny_Mbr_Written_DD between 0 and 3 then 'Y'
when TAT_Exp_Deny_Mbr_Verbal_HH <=72 and TAT_Exp_Deny_Mbr_Verbal_HH >=0 and TAT_Exp_Deny_Mbr_Written_DD >3 then 'N'
when TAT_Exp_Deny_Mbr_Written_HH <=72 and TAT_Exp_Deny_Mbr_Written_HH >=0 then 'Y' when TAT_Exp_Deny_Mbr_Written_HH >72 then 'N' end
,Compliant_Exp_Deny_Prov = case when ext = '1' and TAT_Exp_Deny_Prov_DD <=17 and TAT_Exp_Deny_Prov_DD>=0 then 'Y' when ext = '1' and TAT_Exp_Deny_Prov_DD >17 then 'N' 
when TAT_Exp_Deny_Prov_HH <=72 and TAT_Exp_Deny_Prov_HH>=0 then 'Y' when TAT_Exp_Deny_Prov_HH >72 then 'N' end
,Compliant_Exp_Deny_Prov_Written = case when ext = '1' and TAT_Exp_Deny_Prov_Written_DD <=17 and TAT_Exp_Deny_Prov_Written_DD>=0 then 'Y' when ext = '1' and TAT_Exp_Deny_Prov_Written_DD >17 then 'N' 
when TAT_Exp_Deny_Prov_Written_HH <=72 and TAT_Exp_Deny_Prov_Written_HH>=0 then 'Y' when TAT_Exp_Deny_Prov_Written_HH >72 then 'N' end
,Compliant_Exp_Ext_Decision = case when ext = '1' and TAT_Exp_Ext_Decision_DD <=17 and TAT_Exp_Ext_Decision_DD>=0 then 'Y' when ext = '1' and TAT_Exp_Ext_Decision_DD >17 then 'N' 
 when TAT_Exp_Ext_Decision_HH <=72 and TAT_Exp_Ext_Decision_HH>=0 then 'Y' when TAT_Exp_Ext_Decision_HH >72 then 'N' end
,Compliant_Exp_Ext_Mbr_Verbal = case when TAT_Exp_Ext_Mbr_Verbal_HH <=72 and TAT_Exp_Ext_Mbr_Verbal_HH>=0 then 'Y' when TAT_Exp_Ext_Mbr_Verbal_HH> 72 then 'N' end
,Compliant_Exp_Ext_Mbr_Written	= case when TAT_Exp_Ext_Mbr_Written_HH <=72 and TAT_Exp_Ext_Mbr_Written_HH>=0 then 'Y' when TAT_Exp_Ext_Mbr_Written_HH> 72 then 'N' end
,Compliant_Exp_Ext_Prov = case when TAT_Exp_Ext_Prov_HH <= 72 and TAT_Exp_Ext_Prov_HH>=0 then 'Y' when TAT_Exp_Ext_Prov_HH > 72 then 'N' end
,Compliant_Exp_Ext_Prov_Written = case when TAT_Exp_Ext_Prov_Written_HH <= 72 and TAT_Exp_Ext_Prov_Written_HH>=0 then 'Y' when TAT_Exp_Ext_Prov_Written_HH > 72 then 'N' end
,Compliant_Exp_Crit_Decision = case when ext = '1' and TAT_Exp_Crit_Decision_DD <=17 and TAT_Exp_Crit_Decision_DD>=0 then 'Y' when ext = '1' and TAT_Exp_Crit_Decision_DD >17 then 'N' 
 when TAT_Exp_Crit_Decision_HH <=72 and TAT_Exp_Crit_Decision_HH>=0 then 'Y' when TAT_Exp_Crit_Decision_HH >72 then 'N' end
,Compliant_Exp_Crit_Mbr_Verbal= case when ext = '1' and TAT_Exp_Crit_Mbr_Verbal_DD <=17 and TAT_Exp_Crit_Mbr_Verbal_DD>=0 then 'Y' when ext = '1' and TAT_Exp_Crit_Mbr_Verbal_DD >17 then 'N' 
 when TAT_Exp_Crit_Mbr_Verbal_HH <=72 and TAT_Exp_Crit_Mbr_Verbal_HH>=0 then 'Y' when TAT_Exp_Crit_Mbr_Verbal_HH >72 then 'N' end
,Compliant_Exp_Crit_Mbr_Written	=	case when ext = '1' and TAT_Exp_Crit_Mbr_Written_DD<=17 and TAT_Exp_Crit_Mbr_Written_DD>=0 then 'Y' when ext = '1' and TAT_Exp_Crit_Mbr_Written_DD >17 then 'N' 
 when TAT_Exp_Crit_Mbr_Written_HH <=72 and TAT_Exp_Crit_Mbr_Written_HH>=0 then 'Y' when TAT_Exp_Crit_Mbr_Written_HH >72 then 'N' end
,Compliant_Exp_Crit_Prov	=	 case when ext = '1' and TAT_Exp_Crit_Prov_DD <=17 and TAT_Exp_Crit_Prov_DD>=0 then 'Y' when ext = '1' and TAT_Exp_Crit_Prov_DD >17 then 'N' 
 when TAT_Exp_Crit_Prov_HH <=72 and TAT_Exp_Crit_Prov_HH>=0 then 'Y' when TAT_Exp_Crit_Prov_HH >72 then 'N' end
,Compliant_Exp_Crit_Prov_Written	=	  case when ext = '1' and TAT_Exp_Crit_Prov_Written_DD <=17 and TAT_Exp_Crit_Prov_Written_DD>0 then 'Y' when ext = '1' and TAT_Exp_Crit_Prov_Written_DD >17 then 'N' 
 when TAT_Exp_Crit_Prov_Written_HH <=72 and TAT_Exp_Crit_Prov_Written_HH>=0 then 'Y' when TAT_Exp_Crit_Prov_Written_HH >72 then 'N' end
,Compliant_Exp_NonPar_Prov = case when TAT_Exp_NonPar_Prov_HH <=24 and TAT_Exp_NonPar_Prov_HH>=0 then 'Y' when TAT_Exp_NonPar_Prov_HH >24 then 'N' end 
,Compliant_Std_Appr_Decision = case when ext = '1' and TAT_Std_Appr_Decision_DD <=28 and TAT_Std_Appr_Decision_DD>=0 then 'Y' when ext = '1' and TAT_Std_Appr_Decision_DD >28 then 'N' 
when TAT_Std_Appr_Decision_DD <=14 and TAT_Std_Appr_Decision_DD>=0 then 'Y' when TAT_Std_Appr_Decision_DD >14 then 'N' end
,Compliant_Std_Appr_Mbr_Verbal = case when ext = '1' and TAT_Std_Appr_Mbr_Verbal_DD <=28 and TAT_Std_Appr_Mbr_Verbal_DD >=0 then 'Y' 
when ext = '1' and TAT_Std_Appr_Mbr_Verbal_DD >28 then 'N' 
 when TAT_Std_Appr_Mbr_Verbal_DD <=14 and TAT_Std_Appr_Mbr_Verbal_DD>=0 then 'Y' when TAT_Std_Appr_Mbr_Verbal_DD >14 then 'N' end
,Compliant_Std_Appr_Mbr_Written = case when ext = '1' and TAT_Std_Appr_Mbr_Written_DD <=28 and TAT_Std_Appr_Mbr_Written_DD>=0 then 'Y' when ext = '1' and TAT_Std_Appr_Mbr_Written_DD >28 then 'N' 
 when TAT_Std_Appr_Mbr_Written_DD <=14 and TAT_Std_Appr_Mbr_Written_DD>=0 then 'Y' when TAT_Std_Appr_Mbr_Written_DD >14 then 'N' end
,Compliant_Std_Appr_Prov = case when ext = '1' and TAT_Std_Appr_Prov_DD <=28 and TAT_Std_Appr_Prov_DD>=0 then 'Y' when ext = '1' and TAT_Std_Appr_Prov_DD >28 then 'N' 
 when TAT_Std_Appr_Prov_DD <=14 and TAT_Std_Appr_Prov_DD>=0 then 'Y' when TAT_Std_Appr_Prov_DD >14 then 'N' end
,Compliant_Std_Deny_Decision = case when ext = '1' and TAT_Std_Deny_Decision_DD <=28 and TAT_Std_Deny_Decision_DD>=0 then 'Y' when ext = '1' and TAT_Std_Deny_Decision_DD >28 then 'N' 
 when TAT_Std_Deny_Decision_DD <=14 and TAT_Std_Deny_Decision_DD>=0 then 'Y' when TAT_Std_Deny_Decision_DD >14 then 'N' end
,Compliant_Std_Deny_Mbr_Verbal = case when ext = '1' and TAT_Std_Deny_Mbr_Verbal_DD <=28 and TAT_Std_Deny_Mbr_Verbal_DD >=0 then 'Y' when ext = '1' and TAT_Std_Deny_Mbr_Verbal_DD >28 then 'N' 
 when TAT_Std_Deny_Mbr_Verbal_DD <=14 and TAT_Std_Deny_Mbr_Verbal_DD >=0 then 'Y' when TAT_Std_Deny_Mbr_Verbal_DD >14 then 'N' end
,Compliant_Std_Deny_Mbr_Written = case when ext = '1' and TAT_Std_Deny_Mbr_Written_DD <=28 and TAT_Std_Deny_Mbr_Written_DD >=0 then 'Y' when ext = '1' and TAT_Std_Deny_Mbr_Written_DD >28 then 'N' 
 when TAT_Std_Deny_Mbr_Written_DD <=14 and TAT_Std_Deny_Mbr_Written_DD>=0 then 'Y' when TAT_Std_Deny_Mbr_Written_DD >14 then 'N' end
,Compliant_Std_Deny_Prov = case when ext = '1' and TAT_Std_Deny_Prov_DD <=28 and TAT_Std_Deny_Prov_DD>=0 then 'Y' when ext = '1' and TAT_Std_Deny_Prov_DD >28 then 'N' 
 when TAT_Std_Deny_Prov_DD <=14 and TAT_Std_Deny_Prov_DD>=0 then 'Y' when TAT_Std_Deny_Prov_DD >14 then 'N' end
,Compliant_Std_Deny_Prov_Written = case when ext = '1' and TAT_Std_Deny_Prov_Written_DD <=28 and TAT_Std_Deny_Prov_Written_DD >=0 then 'Y' when ext = '1' and TAT_Std_Deny_Prov_Written_DD >28 then 'N' 
 when TAT_Std_Deny_Prov_Written_DD <=14 and TAT_Std_Deny_Prov_Written_DD >=0 then 'Y' when TAT_Std_Deny_Prov_Written_DD >14 then 'N' end
,Compliant_Std_Ext_Decision = case when ext = '1' and TAT_Std_Ext_Decision_DD <=28 and TAT_Std_Ext_Decision_DD>=0 then 'Y' when ext = '1' and TAT_Std_Ext_Decision_DD >28 then 'N' 
 when TAT_Std_Ext_Decision_DD <=14 and TAT_Std_Ext_Decision_DD>=0 then 'Y' when TAT_Std_Ext_Decision_DD >14 then 'N' end
,Compliant_Std_Ext_Mbr_Verbal = case when TAT_Std_Ext_Mbr_Verbal_DD <=14 and TAT_Std_Ext_Mbr_Verbal_DD >=0 then 'Y' when TAT_Std_Ext_Mbr_Verbal_DD >14 then 'N' end
,Compliant_Std_Ext_Mbr_Written = case when TAT_Std_Ext_Mbr_Written_DD <=14 and TAT_Std_Ext_Mbr_Written_DD>=0 then 'Y' when TAT_Std_Ext_Mbr_Written_DD >14 then 'N' end
,Compliant_Std_Ext_Prov	= case when TAT_Std_Ext_Prov_DD <=14 and TAT_Std_Ext_Prov_DD>=0 then 'Y' when TAT_Std_Ext_Prov_DD >14 then 'N' end
,Compliant_Std_Ext_Prov_Written	= case when TAT_Std_Ext_Prov_Written_DD <=14 and TAT_Std_Ext_Prov_Written_DD >=0 then 'Y' when TAT_Std_Ext_Prov_Written_DD >14 then 'N' end
,IP_Compliant= case when IP_Auth_Receipt is null or IP_Decision is null or datediff(mi,IP_Auth_Receipt,IP_Decision)/60.0 < 0 then null 
	when floor(datediff(mi,IP_Auth_Receipt,IP_Decision)/60.0) < 73 then 'Y' else 'N' end 
into sheiladb.dbo.DARR_Compliance
from sheiladb.dbo.DARR_Calc

--tx mmp
update sheiladb.dbo.DARR_Compliance
set 
Compliant_Exp_Appr_Decision = case when TAT_Exp_Appr_Decision_DD is null or TAT_Exp_Appr_Decision_DD < 0 then null
when datepart(dw,exp_appr_auth_receipt)=6 and exp_appr_auth_receipt >= '2019-01-01' and TAT_Exp_Appr_Decision_HH <= 72 and TAT_Exp_Appr_Decision_HH>=0 then 'Y' 
when datepart(dw,exp_appr_auth_receipt)=6 and exp_appr_auth_receipt >= '2019-01-01' and TAT_Exp_Appr_Decision_HH > 72 then 'N' 
when TAT_Exp_Appr_Decision_DD <= 1 then 'Y' when TAT_Exp_Appr_Decision_DD > 1 then 'N' end
,Compliant_Exp_Appr_Mbr_Verbal = case when TAT_Exp_Appr_Mbr_Verbal_DD is null or TAT_Exp_Appr_Mbr_Verbal_DD < 0 then null
when datepart(dw,exp_appr_auth_receipt)=6 and exp_appr_auth_receipt >= '2019-01-01' and TAT_Exp_Appr_Mbr_Verbal_HH <= 72 and TAT_Exp_Appr_Mbr_Verbal_HH >=0 then 'Y' 
when datepart(dw,exp_appr_auth_receipt)=6 and exp_appr_auth_receipt >= '2019-01-01' and TAT_Exp_Appr_Mbr_Verbal_HH > 72 then 'N' 
when TAT_Exp_Appr_Mbr_Verbal_DD <= 1 then 'Y' when TAT_Exp_Appr_Mbr_Verbal_DD > 1 then 'N' end
,Compliant_Exp_Appr_Mbr_Written  = case when TAT_Exp_Appr_Mbr_Written_DD is null or TAT_Exp_Appr_Mbr_Written_DD < 0 then null
when datepart(dw,exp_appr_auth_receipt)=6 and exp_appr_auth_receipt >= '2019-01-01' and TAT_Exp_Appr_Mbr_Written_HH <= 72 and TAT_Exp_Appr_Mbr_Written_HH >=0 then 'Y' 
when datepart(dw,exp_appr_auth_receipt)=6 and exp_appr_auth_receipt >= '2019-01-01' and TAT_Exp_Appr_Mbr_Written_HH > 72 then 'N' 
when TAT_Exp_Appr_Mbr_Written_DD <= 1 then 'Y' when TAT_Exp_Appr_Mbr_Written_DD > 1 then 'N' end
,Compliant_Exp_Appr_Prov = case when TAT_Exp_Appr_Prov_DD is null or TAT_Exp_Appr_Prov_DD < 0 then null
when datepart(dw,exp_appr_auth_receipt)=6 and exp_appr_auth_receipt >= '2019-01-01' and TAT_Exp_Appr_Prov_HH <= 72 and TAT_Exp_Appr_Prov_HH >=0 then 'Y' 
when datepart(dw,exp_appr_auth_receipt)=6 and exp_appr_auth_receipt >= '2019-01-01' and TAT_Exp_Appr_Prov_HH > 72 then 'N' 
when TAT_Exp_Appr_Prov_DD <= 1 then 'Y' when TAT_Exp_Appr_Prov_DD > 1 then 'N' end
,Compliant_Exp_Deny_Decision = case when TAT_Exp_Deny_Decision_DD is null or TAT_Exp_Deny_Decision_DD < 0 then null
when datepart(dw,exp_Deny_auth_receipt)=6 and exp_Deny_auth_receipt >= '2019-01-01' and TAT_Exp_Deny_Decision_HH <= 72 and TAT_Exp_Deny_Decision_HH>=0 then 'Y' 
when datepart(dw,exp_Deny_auth_receipt)=6 and exp_Deny_auth_receipt >= '2019-01-01' and TAT_Exp_Deny_Decision_HH > 72 then 'N' 
when TAT_Exp_Deny_Decision_DD <= 1 then 'Y' when TAT_Exp_Deny_Decision_DD > 1 then 'N' end
,Compliant_Exp_Deny_Mbr_Verbal = case when TAT_Exp_Deny_Mbr_Verbal_DD is null or TAT_Exp_Deny_Mbr_Verbal_DD < 0 then null
when datepart(dw,Exp_Deny_Auth_Receipt)=6 and Exp_Deny_Auth_Receipt >= '2019-01-01' and TAT_Exp_Deny_Mbr_Verbal_HH <= 72 and TAT_Exp_Deny_Mbr_Verbal_HH>=0 then 'Y' 
when datepart(dw,Exp_Deny_Auth_Receipt)=6 and Exp_Deny_Auth_Receipt >= '2019-01-01' and TAT_Exp_Deny_Mbr_Verbal_HH > 72 then 'N' 
when TAT_Exp_Deny_Mbr_Verbal_DD <= 1 then 'Y' when TAT_Exp_Deny_Mbr_Verbal_DD > 1 then 'N' end
,Compliant_Exp_Deny_Mbr_Written = case when TAT_Exp_Deny_Mbr_Written_DD is null or TAT_Exp_Deny_Mbr_Written_DD < 0 then null
when datepart(dw,Exp_Deny_Auth_Receipt)=6 and Exp_Deny_Auth_Receipt >= '2019-01-01' and TAT_Exp_Deny_Mbr_Written_HH <= 72 and TAT_Exp_Deny_Mbr_Written_HH>=0 then 'Y' 
when datepart(dw,Exp_Deny_Auth_Receipt)=6 and Exp_Deny_Auth_Receipt >= '2019-01-01' and TAT_Exp_Deny_Mbr_Written_HH > 72 then 'N' 
when TAT_Exp_Deny_Mbr_Written_DD <= 1 then 'Y' when TAT_Exp_Deny_Mbr_Written_DD > 1 then 'N' end
,Compliant_Exp_Deny_Prov = case when TAT_Exp_Deny_Prov_DD is null or TAT_Exp_Deny_Prov_DD < 0 then null
when datepart(dw,Exp_Deny_Auth_Receipt)=6 and Exp_Deny_Auth_Receipt >= '2019-01-01' and TAT_Exp_Deny_Prov_HH <= 72 and TAT_Exp_Deny_Prov_HH >= 0 then 'Y' 
when datepart(dw,Exp_Deny_Auth_Receipt)=6 and Exp_Deny_Auth_Receipt >= '2019-01-01' and TAT_Exp_Deny_Prov_HH > 72 then 'N' 
when TAT_Exp_Deny_Prov_DD <= 1 then 'Y' when TAT_Exp_Deny_Prov_DD > 1 then 'N' end
,Compliant_Exp_Deny_Prov_Written = case when TAT_Exp_Deny_Prov_Written_DD is null or TAT_Exp_Deny_Prov_Written_DD < 0 then null
when datepart(dw,Exp_Deny_Auth_Receipt)=6 and Exp_Deny_Auth_Receipt >= '2019-01-01' and TAT_Exp_Deny_Prov_Written_HH <= 72 and TAT_Exp_Deny_Prov_Written_HH>=0 then 'Y' 
when datepart(dw,Exp_Deny_Auth_Receipt)=6 and Exp_Deny_Auth_Receipt >= '2019-01-01' and TAT_Exp_Deny_Prov_Written_HH > 72 then 'N' 
when TAT_Exp_Deny_Prov_Written_DD <= 1 then 'Y' when TAT_Exp_Deny_Prov_Written_DD > 1 then 'N' end
,Compliant_Exp_Ext_Decision = case when TAT_Exp_Ext_Decision_DD is null or TAT_Exp_Ext_Decision_DD < 0 then null
when datepart(dw,exp_Ext_auth_receipt)=6 and exp_Ext_auth_receipt >= '2019-01-01' and TAT_Exp_Ext_Decision_HH <= 72 and TAT_Exp_Ext_Decision_HH>=0 then 'Y' 
when datepart(dw,exp_Ext_auth_receipt)=6 and exp_Ext_auth_receipt >= '2019-01-01' and TAT_Exp_Ext_Decision_HH > 72 then 'N' 
when TAT_Exp_Ext_Decision_DD <= 1 then 'Y' when TAT_Exp_Ext_Decision_DD > 1 then 'N' end
,Compliant_Exp_Ext_Mbr_Verbal = case when TAT_Exp_Ext_Mbr_Verbal_DD is null or TAT_Exp_Ext_Mbr_Verbal_DD < 0 then null
when datepart(dw,Exp_Ext_Auth_Receipt)=6 and Exp_Ext_Auth_Receipt >= '2019-01-01' and TAT_Exp_Ext_Mbr_Verbal_HH <= 72 and TAT_Exp_Ext_Mbr_Verbal_HH >=0 then 'Y' 
when datepart(dw,Exp_Ext_Auth_Receipt)=6 and Exp_Ext_Auth_Receipt >= '2019-01-01' and TAT_Exp_Ext_Mbr_Verbal_HH > 72 then 'N' 
when TAT_Exp_Ext_Mbr_Verbal_DD <= 1 then 'Y' when TAT_Exp_Ext_Mbr_Verbal_DD > 1 then 'N' end
,Compliant_Exp_Ext_Mbr_Written = case when TAT_Exp_Ext_Mbr_Written_DD is null or TAT_Exp_Ext_Mbr_Written_DD < 0 then null
when datepart(dw,Exp_Ext_Auth_Receipt)=6 and Exp_Ext_Auth_Receipt >= '2019-01-01' and TAT_Exp_Ext_Mbr_Written_HH <= 72 and TAT_Exp_Ext_Mbr_Written_HH>=0 then 'Y' 
when datepart(dw,Exp_Ext_Auth_Receipt)=6 and Exp_Ext_Auth_Receipt >= '2019-01-01' and TAT_Exp_Ext_Mbr_Written_HH > 72 then 'N' 
when TAT_Exp_Ext_Mbr_Written_DD <= 1 then 'Y' when TAT_Exp_Ext_Mbr_Written_DD > 1 then 'N' end
,Compliant_Exp_Ext_Prov = case when TAT_Exp_Ext_Prov_DD is null or TAT_Exp_Ext_Prov_DD < 0 then null
when datepart(dw,Exp_Ext_Auth_Receipt)=6 and Exp_Ext_Auth_Receipt >= '2019-01-01' and TAT_Exp_Ext_Prov_HH <= 72 and TAT_Exp_Ext_Prov_HH>=0 then 'Y' 
when datepart(dw,Exp_Ext_Auth_Receipt)=6 and Exp_Ext_Auth_Receipt >= '2019-01-01' and TAT_Exp_Ext_Prov_HH > 72 then 'N' 
when TAT_Exp_Ext_Prov_DD <= 1 then 'Y' when TAT_Exp_Ext_Prov_DD > 1 then 'N' end
,Compliant_Exp_Ext_Prov_Written = case when TAT_Exp_Ext_Prov_Written_DD is null or TAT_Exp_Ext_Prov_Written_DD < 0 then null
when datepart(dw,Exp_Ext_Auth_Receipt)=6 and Exp_Ext_Auth_Receipt >= '2019-01-01' and TAT_Exp_Ext_Prov_Written_HH <= 72 and TAT_Exp_Ext_Prov_Written_HH>=0 then 'Y' 
when datepart(dw,Exp_Ext_Auth_Receipt)=6 and Exp_Ext_Auth_Receipt >= '2019-01-01' and TAT_Exp_Ext_Prov_Written_HH > 72 then 'N' 
when TAT_Exp_Ext_Prov_Written_DD <= 1 then 'Y' when TAT_Exp_Ext_Prov_Written_DD > 1 then 'N' end
,Compliant_Exp_NonPar_Prov = case when TAT_Exp_NonPar_Prov_DD is null or TAT_Exp_NonPar_Prov_DD < 0 then null
when datepart(dw,Match_Auth_Receipt)=6 and Match_Auth_Receipt >= '2019-01-01' and TAT_Exp_NonPar_Prov_HH <= 72 and TAT_Exp_NonPar_Prov_HH>=0 then 'Y' 
when datepart(dw,Match_Auth_Receipt)=6 and Match_Auth_Receipt >= '2019-01-01' and TAT_Exp_NonPar_Prov_HH > 72 then 'N' 
when TAT_Exp_NonPar_Prov_DD <= 1 then 'Y' when TAT_Exp_NonPar_Prov_DD > 1 then 'N' end
,Compliant_Std_Appr_Decision  = case when TAT_Std_Appr_Decision_DD is null or TAT_Std_Appr_Decision_DD < 0 then null
when TAT_Std_Appr_Decision_DD <= 3 then 'Y' when TAT_Std_Appr_Decision_DD > 3 then 'N' end
,Compliant_Std_Appr_Mbr_Verbal  = case when TAT_Std_Appr_Mbr_Verbal_DD is null or TAT_Std_Appr_Mbr_Verbal_HH < 0 then null
when TAT_Std_Appr_Mbr_Verbal_DD <= 3 then 'Y' when TAT_Std_Appr_Mbr_Verbal_DD > 3 then 'N' end
,Compliant_Std_Appr_Mbr_Written = case when TAT_Std_Appr_Mbr_Written_DD is null or TAT_Std_Appr_Mbr_Written_HH < 0 then null
when TAT_Std_Appr_Mbr_Written_DD <= 3 then 'Y' when TAT_Std_Appr_Mbr_Written_DD > 3 then 'N' end
,Compliant_Std_Appr_Prov = case when TAT_Std_Appr_Prov_DD is null or TAT_Std_Appr_Prov_DD < 0 then null
when TAT_Std_Appr_Prov_DD <= 3 then 'Y' when TAT_Std_Appr_Prov_DD > 3 then 'N' end
,Compliant_Std_Deny_Decision = case when TAT_Std_Deny_Decision_DD is null or TAT_Std_Deny_Decision_DD < 0 then null
when TAT_Std_Deny_Decision_DD <= 3 then 'Y' when TAT_Std_Deny_Decision_DD > 3 then 'N' end
,Compliant_Std_Deny_Mbr_Verbal = case when TAT_Std_Deny_Mbr_Verbal_DD is null or TAT_Std_Deny_Mbr_Verbal_DD < 0 then null
when TAT_Std_Deny_Mbr_Verbal_DD <= 3 then 'Y' when TAT_Std_Deny_Mbr_Verbal_DD > 3 then 'N' end
,Compliant_Std_Deny_Mbr_Written = case when TAT_Std_Deny_Mbr_Written_DD is null or TAT_Std_Deny_Mbr_Written_DD < 0 then null
when TAT_Std_Deny_Mbr_Written_DD <= 3 then 'Y' when TAT_Std_Deny_Mbr_Written_DD > 3 then 'N' end
,Compliant_Std_Deny_Prov = case when TAT_Std_Deny_Prov_DD is null or TAT_Std_Deny_Prov_DD < 0 then null
when TAT_Std_Deny_Prov_DD <= 3 then 'Y' when TAT_Std_Deny_Prov_DD > 3 then 'N' end
,Compliant_Std_Deny_Prov_Written = case when TAT_Std_Deny_Prov_Written_DD is null or TAT_Std_Deny_Prov_Written_DD < 0 then null
when TAT_Std_Deny_Prov_Written_DD <= 3 then 'Y' when TAT_Std_Deny_Prov_Written_DD > 3 then 'N' end
,Compliant_Std_Ext_Mbr_Verbal = case when TAT_Std_Ext_Mbr_Verbal_DD is null or TAT_Std_Ext_Mbr_Verbal_DD < 0 then null
when TAT_Std_Ext_Mbr_Verbal_DD <= 3 then 'Y' when TAT_Std_Ext_Mbr_Verbal_DD > 3 then 'N' end
,Compliant_Std_Ext_Decision = case when TAT_Std_Ext_Decision_DD is null or TAT_Std_Ext_Decision_DD < 0 then null
when TAT_Std_Ext_Decision_DD <= 3 then 'Y' when TAT_Std_Ext_Decision_DD > 3 then 'N' end
,Compliant_Std_Ext_Mbr_Written = case when TAT_Std_Ext_Mbr_Written_DD is null or TAT_Std_Ext_Mbr_Written_DD < 0 then null
when TAT_Std_Ext_Mbr_Written_DD <= 3 then 'Y' when TAT_Std_Ext_Mbr_Written_DD > 3 then 'N' end
,Compliant_Std_Ext_Prov = case when TAT_Std_Ext_Prov_DD is null or TAT_Std_Ext_Prov_DD < 0 then null
when TAT_Std_Ext_Prov_DD <= 3 then 'Y' when TAT_Std_Ext_Prov_DD > 3 then 'N' end
,Compliant_Std_Ext_Prov_Written = case when TAT_Std_Ext_Prov_Written_DD is null or TAT_Std_Ext_Prov_Written_DD < 0 then null
when TAT_Std_Ext_Prov_Written_DD <= 3 then 'Y' when TAT_Std_Ext_Prov_Written_DD > 3 then 'N' end
where dbname = 'TX'

--oh update
update sheiladb.dbo.DARR_Compliance 
set Compliant_Exp_Appr_Decision = case when TAT_Exp_Appr_Decision_HH is null or TAT_Exp_Appr_Decision_HH < 0 then null
when TAT_Exp_Appr_Decision_HH <= 48 then 'Y' when TAT_Exp_Appr_Decision_HH > 48 then 'N' end
,Compliant_Exp_Appr_Mbr_Verbal = case when TAT_Exp_Appr_Mbr_Verbal_HH is null or TAT_Exp_Appr_Mbr_Verbal_HH < 0 then null
when TAT_Exp_Appr_Mbr_Verbal_HH <= 48 then 'Y' when TAT_Exp_Appr_Mbr_Verbal_HH > 48 then 'N' end
,Compliant_Exp_Appr_Mbr_Written  = case when TAT_Exp_Appr_Mbr_Written_HH is null or TAT_Exp_Appr_Mbr_Written_HH < 0 then null
when TAT_Exp_Appr_Mbr_Written_HH <= 48 then 'Y' when TAT_Exp_Appr_Mbr_Written_HH > 48 then 'N' end
,Compliant_Exp_Appr_Prov = case when TAT_Exp_Appr_Prov_HH is null or TAT_Exp_Appr_Prov_HH < 0 then null
when TAT_Exp_Appr_Prov_HH <= 48 then 'Y' when TAT_Exp_Appr_Prov_HH > 48 then 'N' end
,Compliant_Exp_Deny_Decision = case when TAT_Exp_Deny_Decision_HH is null or TAT_Exp_Deny_Decision_HH < 0 then null
when TAT_Exp_Deny_Decision_HH <= 48 then 'Y' when TAT_Exp_Deny_Decision_HH > 48 then 'N' end
,Compliant_Exp_Deny_Mbr_Verbal = case when TAT_Exp_Deny_Mbr_Verbal_HH is null or TAT_Exp_Deny_Mbr_Verbal_HH < 0 then null
when TAT_Exp_Deny_Mbr_Verbal_HH <= 48 then 'Y' when TAT_Exp_Deny_Mbr_Verbal_HH > 48 then 'N' end
,Compliant_Exp_Deny_Mbr_Written = case when TAT_Exp_Deny_Mbr_Written_HH is null or TAT_Exp_Deny_Mbr_Written_HH < 0 then null
when TAT_Exp_Deny_Mbr_Written_HH <= 48 then 'Y' when TAT_Exp_Deny_Mbr_Written_HH > 48 then 'N' end
,Compliant_Exp_Deny_Prov = case when TAT_Exp_Deny_Prov_HH is null or TAT_Exp_Deny_Prov_HH < 0 then null
when TAT_Exp_Deny_Prov_HH <= 48 then 'Y' when TAT_Exp_Deny_Prov_HH > 48 then 'N' end
,Compliant_Exp_Deny_Prov_Written = case when TAT_Exp_Deny_Prov_Written_HH is null or TAT_Exp_Deny_Prov_Written_HH < 0 then null
when TAT_Exp_Deny_Prov_Written_HH <= 48 then 'Y' when TAT_Exp_Deny_Prov_Written_HH > 48 then 'N' end
,Compliant_Exp_Ext_Decision = case when TAT_Exp_Ext_Decision_HH is null or TAT_Exp_Ext_Decision_HH < 0 then null
when TAT_Exp_Ext_Decision_HH <= 48 then 'Y' when TAT_Exp_Ext_Decision_HH > 48 then 'N' end
,Compliant_Exp_Ext_Mbr_Verbal = case when TAT_Exp_Ext_Mbr_Verbal_DD is null or TAT_Exp_Ext_Mbr_Verbal_DD < 0 then null
when TAT_Exp_Ext_Mbr_Verbal_DD <= 14 then 'Y' when TAT_Exp_Ext_Mbr_Verbal_DD > 14 then 'N' end
,Compliant_Exp_Ext_Mbr_Written = case when TAT_Exp_Ext_Mbr_Written_DD is null or TAT_Exp_Ext_Mbr_Written_DD < 0 then null
when TAT_Exp_Ext_Mbr_Written_DD <= 14 then 'Y' when TAT_Exp_Ext_Mbr_Written_DD > 14 then 'N' end
,Compliant_Exp_Ext_Prov = case when TAT_Exp_Ext_Prov_DD is null or TAT_Exp_Ext_Prov_DD < 0 then null
when TAT_Exp_Ext_Prov_DD <= 14 then 'Y' when TAT_Exp_Ext_Prov_DD > 14 then 'N' end
,Compliant_Exp_Ext_Prov_Written = case when TAT_Exp_Ext_Prov_Written_DD is null or TAT_Exp_Ext_Prov_Written_DD < 0 then null
when TAT_Exp_Ext_Prov_Written_DD <= 14 then 'Y' when TAT_Exp_Ext_Prov_Written_DD > 14 then 'N' end
,Compliant_Exp_NonPar_Prov = case when TAT_Exp_NonPar_Prov_HH is null or TAT_Exp_NonPar_Prov_HH < 0 then null
when TAT_Exp_NonPar_Prov_HH <= 48 then 'Y' when TAT_Exp_NonPar_Prov_HH > 48 then 'N' end
,Compliant_Std_Appr_Decision  = case when TAT_Std_Appr_Decision_DD is null or TAT_Std_Appr_Decision_DD < 0 then null
when TAT_Std_Appr_Decision_DD <= 10 then 'Y' when TAT_Std_Appr_Decision_DD > 10 then 'N' end
,Compliant_Std_Appr_Mbr_Verbal  = case when TAT_Std_Appr_Mbr_Verbal_DD is null or TAT_Std_Appr_Mbr_Verbal_DD < 0 then null
when TAT_Std_Appr_Mbr_Verbal_DD <= 10 then 'Y' when TAT_Std_Appr_Mbr_Verbal_DD > 10 then 'N' end
,Compliant_Std_Appr_Mbr_Written = case when TAT_Std_Appr_Mbr_Written_DD is null or TAT_Std_Appr_Mbr_Written_DD < 0 then null
when TAT_Std_Appr_Mbr_Written_DD <= 10 then 'Y' when TAT_Std_Appr_Mbr_Written_DD > 10 then 'N' end
,Compliant_Std_Appr_Prov = case when TAT_Std_Appr_Prov_DD is null or TAT_Std_Appr_Prov_DD < 0 then null
when TAT_Std_Appr_Prov_DD <= 10 then 'Y' when TAT_Std_Appr_Prov_DD > 10 then 'N' end
,Compliant_Std_Deny_Decision  = case when TAT_Std_Deny_Decision_DD is null or TAT_Std_Deny_Decision_DD < 0 then null
when TAT_Std_Deny_Decision_DD <= 10 then 'Y' when TAT_Std_Deny_Decision_DD > 10 then 'N' end
,Compliant_Std_Deny_Mbr_Verbal = case when TAT_Std_Deny_Mbr_Verbal_DD is null or TAT_Std_Deny_Mbr_Verbal_DD < 0 then null
when TAT_Std_Deny_Mbr_Verbal_DD <= 10 then 'Y' when TAT_Std_Deny_Mbr_Verbal_DD > 10 then 'N' end
,Compliant_Std_Deny_Mbr_Written = case when TAT_Std_Deny_Mbr_Written_DD is null or TAT_Std_Deny_Mbr_Written_DD < 0 then null
when TAT_Std_Deny_Mbr_Written_DD <= 10 then 'Y' when TAT_Std_Deny_Mbr_Written_DD > 10 then 'N' end
,Compliant_Std_Deny_Prov = case when TAT_Std_Deny_Prov_DD is null or TAT_Std_Deny_Prov_DD < 0 then null
when TAT_Std_Deny_Prov_DD <= 10 then 'Y' when TAT_Std_Deny_Prov_DD > 10 then 'N' end
,Compliant_Std_Deny_Prov_Written = case when TAT_Std_Deny_Prov_Written_DD is null or TAT_Std_Deny_Prov_Written_DD < 0 then null
when TAT_Std_Deny_Prov_Written_DD <= 10 then 'Y' when TAT_Std_Deny_Prov_Written_DD > 10 then 'N' end
,Compliant_Std_Ext_Decision  = case when TAT_Std_Ext_Decision_DD is null or TAT_Std_Ext_Decision_DD < 0 then null
when TAT_Std_Ext_Decision_DD <= 10 then 'Y' when TAT_Std_Ext_Decision_DD > 10 then 'N' end
,Compliant_Std_Ext_Mbr_Verbal = case when TAT_Std_Ext_Mbr_Verbal_DD is null or TAT_Std_Ext_Mbr_Verbal_DD < 0 then null
when TAT_Std_Ext_Mbr_Verbal_DD <= 14 then 'Y' when TAT_Std_Ext_Mbr_Verbal_DD > 14 then 'N' end
,Compliant_Std_Ext_Mbr_Written = case when TAT_Std_Ext_Mbr_Written_DD is null or TAT_Std_Ext_Mbr_Written_DD < 0 then null
when TAT_Std_Ext_Mbr_Written_DD <= 14 then 'Y' when TAT_Std_Ext_Mbr_Written_DD > 14 then 'N' end
,Compliant_Std_Ext_Prov = case when TAT_Std_Ext_Prov_DD is null or TAT_Std_Ext_Prov_DD < 0 then null
when TAT_Std_Ext_Prov_DD <= 14 then 'Y' when TAT_Std_Ext_Prov_DD > 14 then 'N' end
,Compliant_Std_Ext_Prov_Written = case when TAT_Std_Ext_Prov_Written_DD is null or TAT_Std_Ext_Prov_Written_DD < 0 then null
when TAT_Std_Ext_Prov_Written_DD <= 14 then 'Y' when TAT_Std_Ext_Prov_Written_DD > 14 then 'N' end
where dbname = 'OH' and Match_Auth_Receipt >='2018-01-01'

--Part B effective 1/1/2020
update sheiladb.dbo.DARR_Compliance
set
Compliant_Std_Appr_Decision =  case when TAT_Std_Appr_Decision_HH <= 72 and TAT_Std_Appr_Decision_HH >= 0 then 'Y' when TAT_Std_Appr_Decision_HH > 72 then 'N' end
,Compliant_Std_Appr_Mbr_Verbal = case when TAT_Std_Appr_Mbr_Verbal_HH <= 72 and TAT_Std_Appr_Mbr_Verbal_HH >= 0 then 'Y' when TAT_Std_Appr_Mbr_Verbal_HH > 72 then 'N' end
,Compliant_Std_Appr_Mbr_Written = case when TAT_Std_Appr_Mbr_Written_HH <= 72 and TAT_Std_Appr_Mbr_Written_HH >= 0 then 'Y' when TAT_Std_Appr_Mbr_Written_HH > 72 then 'N' end
,Compliant_Std_Appr_Prov = case when TAT_Std_Appr_Prov_HH <= 72 and TAT_Std_Appr_Prov_HH >= 0 then 'Y' when TAT_Std_Appr_Prov_HH > 72 then 'N' end
,Compliant_Std_Deny_Decision = case when TAT_Std_Deny_Decision_HH <= 72 and TAT_Std_Deny_Decision_HH >= 0 then 'Y' when TAT_Std_Deny_Decision_HH > 72 then 'N' end
,Compliant_Std_Deny_Mbr_Verbal = case when TAT_Std_Deny_Mbr_Verbal_HH <= 72 and TAT_Std_Deny_Mbr_Verbal_HH >= 0 then 'Y' when TAT_Std_Deny_Mbr_Verbal_HH > 72 then 'N' end
,Compliant_Std_Deny_Mbr_Written = case when TAT_Std_Deny_Mbr_Written_HH <= 72 and TAT_Std_Deny_Mbr_Written_HH >= 0 then 'Y' when TAT_Std_Deny_Mbr_Written_HH > 72 then 'N' end
,Compliant_Std_Deny_Prov = case when TAT_Std_Deny_Prov_HH <= 72 and TAT_Std_Deny_Prov_HH >= 0 then 'Y' when TAT_Std_Deny_Prov_HH > 72 then 'N' end
,Compliant_Std_Deny_Prov_Written = case when TAT_Std_Deny_Prov_Written_HH <= 72 and TAT_Std_Deny_Prov_Written_HH >= 0 then 'Y' when TAT_Std_Deny_Prov_Written_HH > 72 then 'N' end
,Compliant_exp_Appr_Decision =  case when TAT_exp_Appr_Decision_HH <= 24 and TAT_exp_Appr_Decision_HH >= 0 then 'Y' when TAT_exp_Appr_Decision_HH > 24 then 'N' end
,Compliant_exp_Appr_Mbr_Verbal = case when TAT_exp_Appr_Mbr_Verbal_HH <= 24 and TAT_exp_Appr_Mbr_Verbal_HH >= 0 then 'Y' when TAT_exp_Appr_Mbr_Verbal_HH > 24 then 'N' end
,Compliant_exp_Appr_Mbr_Written = case when TAT_exp_Appr_Mbr_Written_HH <= 24 and TAT_exp_Appr_Mbr_Written_HH >= 0 then 'Y' when TAT_exp_Appr_Mbr_Written_HH > 24 then 'N' end
,Compliant_exp_Appr_Prov = case when TAT_exp_Appr_Prov_HH <= 24 and TAT_exp_Appr_Prov_HH >= 0 then 'Y' when TAT_exp_Appr_Prov_HH > 24 then 'N' end
,Compliant_exp_Deny_Decision = case when TAT_exp_Deny_Decision_HH <= 24 and TAT_exp_Deny_Decision_HH >= 0 then 'Y' when TAT_exp_Deny_Decision_HH > 24 then 'N' end
,Compliant_exp_Deny_Mbr_Verbal = case when TAT_exp_Deny_Mbr_Verbal_HH <= 24 and TAT_exp_Deny_Mbr_Verbal_HH >= 0 then 'Y' when TAT_exp_Deny_Mbr_Verbal_HH > 24 then 'N' end
,Compliant_exp_Deny_Mbr_Written = case when TAT_exp_Deny_Mbr_Written_HH <= 24 and TAT_exp_Deny_Mbr_Written_HH >= 0 then 'Y' when TAT_exp_Deny_Mbr_Written_HH > 24 then 'N' end
,Compliant_exp_Deny_Prov = case when TAT_exp_Deny_Prov_HH <= 24 and TAT_exp_Deny_Prov_HH >= 0 then 'Y' when TAT_exp_Deny_Prov_HH > 24 then 'N' end
,Compliant_exp_Deny_Prov_Written = case when TAT_exp_Deny_Prov_Written_HH <= 24 and TAT_exp_Deny_Prov_Written_HH >= 0 then 'Y' when TAT_exp_Deny_Prov_Written_HH > 24 then 'N' end
where Part_B = 'y'
-------------------->>>>>>>>>>>>>>>>>>>________________________>>>>>>>>>>>>>>>>>>>________________________>>>>>>>>>>>>>>>>>>>--------------------

if object_id('sheiladb.dbo.DARR_Timely') is not null drop table sheiladb.dbo.DARR_Timely
select distinct Timely =
case when acuity = 'Urgent' and partial = 'Y' and (compliant_exp_appr_mbr_verbal='y' or compliant_exp_appr_mbr_written='Y') 
			and (compliant_exp_deny_mbr_verbal='y' or compliant_exp_deny_mbr_written='Y') then 'Y'
	when acuity = 'Urgent' and partial = 'Y' and (compliant_exp_appr_mbr_verbal='N' or compliant_exp_appr_mbr_written='N' or 
				compliant_exp_deny_mbr_verbal='N' or compliant_exp_deny_mbr_written='N') then 'N'
	when acuity <> 'Urgent' and partial = 'Y' and (compliant_std_appr_mbr_verbal='y' or compliant_std_appr_mbr_written='Y') 
			and (compliant_std_deny_mbr_verbal='y' or compliant_std_deny_mbr_written='Y') then 'Y'
	when acuity <> 'Urgent' and partial = 'Y' and (compliant_std_appr_mbr_verbal='N' or compliant_std_appr_mbr_written='N' or
				compliant_std_deny_mbr_verbal='N' or compliant_std_deny_mbr_written='N') then 'N'
	when partial = 'Y' then null
	when acuity = 'urgent' and (authstatus = 'approved' and Effective_Denial = 'N') and (compliant_exp_appr_mbr_verbal='y' or compliant_exp_appr_mbr_written='Y') then 'Y'
	when acuity = 'urgent' and (authstatus = 'denied' or Effective_Denial = 'Y') and (compliant_exp_deny_mbr_verbal='y' or compliant_exp_deny_mbr_written='Y') then 'Y'
	when acuity = 'urgent' and (authstatus = 'approved' and Effective_Denial = 'N') and (compliant_exp_appr_mbr_verbal='n' or compliant_exp_appr_mbr_written = 'n') then 'N'
	when acuity = 'urgent' and (authstatus = 'denied' or Effective_Denial = 'Y') and (compliant_exp_deny_mbr_verbal='n' or compliant_exp_deny_mbr_written='n') then 'N'
	when acuity <> 'urgent' and (authstatus = 'approved' and Effective_Denial = 'N') and (compliant_std_appr_mbr_verbal='y' or compliant_std_appr_mbr_written='Y') then 'Y'
	when acuity <> 'urgent' and (authstatus = 'denied' or Effective_Denial = 'Y') and (compliant_std_deny_mbr_verbal='y' or compliant_std_deny_mbr_written='Y') then 'Y'
	when acuity <> 'urgent' and (authstatus = 'approved' and Effective_Denial = 'N') and (compliant_std_appr_mbr_verbal='n' or compliant_std_appr_mbr_written='n') then 'N'
	when acuity <> 'urgent' and (authstatus = 'denied' or Effective_Denial = 'Y') and (compliant_std_deny_mbr_verbal='n' or compliant_std_deny_mbr_written='n') then 'N'
	end,* into sheiladb.dbo.DARR_Timely 
	from sheiladb.dbo.DARR_Compliance a 

--DISPLAY COMPLIANCE FOR PEND AND INPROCESS SELECT CASES
update sheiladb.dbo.DARR_Timely
set Timely = case 
when acuity = 'Urgent' and partial = 'Y' and (compliant_exp_appr_mbr_verbal='y' or compliant_exp_appr_mbr_written='Y') 
			and (compliant_exp_deny_mbr_verbal='y' or compliant_exp_deny_mbr_written='Y') then 'Y'
when acuity = 'Urgent' and partial = 'Y' and (compliant_exp_appr_mbr_verbal='N' or compliant_exp_appr_mbr_written='N' or
				compliant_exp_deny_mbr_verbal='N' or compliant_exp_deny_mbr_written='N') then 'N'
when acuity <> 'Urgent' and partial = 'Y' and (compliant_std_appr_mbr_verbal='y' or compliant_std_appr_mbr_written='Y') 
			and (compliant_std_deny_mbr_verbal='y' or compliant_std_deny_mbr_written='Y') then 'Y'
when acuity <> 'Urgent' and partial = 'Y' and (compliant_std_appr_mbr_verbal='N' or compliant_std_appr_mbr_written='N' or
				compliant_std_deny_mbr_verbal='N' or compliant_std_deny_mbr_written='N') then 'N'
when partial = 'Y' then null
when acuity = 'urgent' and exp_app_attr=1 and (compliant_exp_appr_mbr_verbal='Y' or compliant_exp_appr_mbr_written='Y') then 'Y'
when acuity = 'urgent' and exp_den_attr=1 and (compliant_exp_deny_mbr_verbal='Y' or compliant_exp_deny_mbr_written='Y') then 'Y'
when acuity = 'urgent' and exp_app_attr=1 and (compliant_exp_appr_mbr_verbal='N' or compliant_exp_appr_mbr_written = 'n') then 'N'
when acuity = 'urgent' and exp_den_attr=1 and (compliant_exp_deny_mbr_verbal='N' or compliant_exp_deny_mbr_written='n') then 'N'
when acuity <> 'urgent' and std_app_attr=1 and (compliant_std_appr_mbr_verbal='Y' or compliant_std_appr_mbr_written='Y') then 'Y'
when acuity <> 'urgent' and std_den_attr=1 and (compliant_std_deny_mbr_verbal='Y' or compliant_std_deny_mbr_written='Y') then 'Y'
when acuity <> 'urgent' and std_app_attr=1 and (compliant_std_appr_mbr_verbal='N' or compliant_std_appr_mbr_written='n') then 'N'
when acuity <> 'urgent' and std_den_attr=1 and (compliant_std_deny_mbr_verbal='N' or compliant_std_deny_mbr_written='n') then 'N' end
where (rpt = 'PA' and ((servicecode in ('150','190','340','380','1188') and authstatus = 'PEND') or 
(servicecode in ('110','150','190','231','340','370','380','1038') and authstatus = 'INPROCESS')))
or (rpt = 'IP' and authstatus = 'INPROCESS')

--Include Extension Compliance into Timeliness 
update sheiladb.dbo.DARR_Timely
set timely = 'N' where ext = '1' and acuity = 'urgent' and (authstatus = 'approved' and Effective_Denial ='N') and compliant_exp_ext_mbr_written='n'
update sheiladb.dbo.DARR_Timely
set timely = 'N' where ext = '1' and acuity = 'urgent' and (authstatus = 'denied' or Effective_Denial = 'Y') and compliant_exp_ext_mbr_written='n'
update sheiladb.dbo.DARR_Timely
set timely = 'N' where ext = '1' and acuity <> 'urgent' and (authstatus = 'approved' and Effective_Denial ='N') and compliant_std_ext_mbr_written='n'
update sheiladb.dbo.DARR_Timely
set timely = 'N' where ext = '1' and acuity <> 'urgent' and (authstatus = 'denied' or Effective_Denial = 'Y') and compliant_std_ext_mbr_written='n'

--Include Expedited NonPar Provider Additional Info Compliance into Timeliness
update sheiladb.dbo.DARR_Timely 
set timely = 'N' where enp ='1' and Compliant_Exp_NonPar_Prov = 'N'
--Mark compliance blank where decision is blank
update sheiladb.dbo.DARR_Timely 
set timely = NULL where timely in ('Y','N') and
case when acty_grp = 'Standard' and (authstatus = 'approved' and effective_denial ='N') and [Decision Date - STANDARD APPROVAL] is null then 1
when acty_grp = 'Standard' and (authstatus = 'denied' or Effective_Denial = 'Y') and [Decision Date - STANDARD DENIAL] is null then 1
when acty_grp = 'Urgent' and (authstatus = 'approved' and effective_denial  ='N') and ([Decision Date - EXPEDITED APPROVAL] is null or ([Decision Time - EXPEDITED APPROVAL] is null and dbname <> 'tx'))  then 1
when acty_grp = 'Urgent' and (authstatus = 'denied' or Effective_Denial = 'Y') and ([Decision Date - EXPEDITED DENIAL] is null or ([Decision Time - EXPEDITED DENIAL] is null and dbname <> 'tx')) then 1
else 0 end = 1
--Mark compliance blank where acuity = 'Routine'
update sheiladb.dbo.DARR_Timely set timely = NULL where timely in ('Y','N') and acuity = 'routine'
--Mark compliance blank for receipt date mismatches
update sheiladb.dbo.DARR_Timely 
set timely = NULL
where (cast(receiptdate as date) <> cast(Exp_Appr_Auth_Receipt as date) and Exp_Appr_Auth_Receipt <>'')
or (cast(receiptdate as date) <> cast(Exp_Deny_Auth_Receipt as date) and Exp_Deny_Auth_Receipt <>'')
or (cast(receiptdate as date) <> cast(Std_Appr_Auth_Receipt as date) and Std_Appr_Auth_Receipt <>'')
or (cast(receiptdate as date) <> cast(Std_Deny_Auth_Receipt as date) and Std_Deny_Auth_Receipt <>'')
or (cast(Exp_Appr_Auth_Receipt as date) <> cast(Exp_Deny_Auth_Receipt as date) and Exp_Appr_Auth_Receipt <>'' and Exp_Deny_Auth_Receipt <>'')
or (cast(Std_Appr_Auth_Receipt as date) <> cast(Std_Deny_Auth_Receipt as date) and Std_Appr_Auth_Receipt <>'' and Std_Deny_Auth_Receipt <>'')
or (cast(Exp_Appr_Auth_Receipt as date) <> cast(Std_Deny_Auth_Receipt as date) and Exp_Appr_Auth_Receipt <>'' and Std_Deny_Auth_Receipt <>'')
or (cast(Std_Appr_Auth_Receipt as date) <> cast(Exp_Deny_Auth_Receipt as date) and Std_Appr_Auth_Receipt <>'' and Exp_Deny_Auth_Receipt <>'')
or (cast(Exp_Appr_Auth_Receipt as date) <> cast(Std_Appr_Auth_Receipt as date) and Exp_Appr_Auth_Receipt <>'' and Std_Appr_Auth_Receipt <>'')
or (cast(Std_Deny_Auth_Receipt as date) <> cast(Exp_Deny_Auth_Receipt as date) and Std_Deny_Auth_Receipt <>'' and Exp_Deny_Auth_Receipt <>'')

update sheiladb.dbo.DARR_Timely set timely = NULL where timely is not null and
(TAT_Std_Appr_Mbr_Verbal_DD like '%-%' or TAT_Std_Appr_Mbr_Verbal_HH like '%-%' or TAT_Std_Appr_Mbr_Written_DD like '%-%' or TAT_Std_Appr_Mbr_Written_HH like '%-%'
or TAT_Std_Appr_Prov_DD like '%-%' or TAT_Std_Appr_Prov_HH like '%-%' or TAT_Std_Deny_Decision_DD like '%-%' or TAT_Std_Deny_Decision_HH like '%-%'
or TAT_Std_Deny_Mbr_Verbal_DD like '%-%' or TAT_Std_Deny_Mbr_Verbal_HH like '%-%' or TAT_Std_Deny_Mbr_Written_DD like '%-%' or TAT_Std_Deny_Mbr_Written_HH like '%-%'
or TAT_Std_Deny_Prov_DD like '%-%' or TAT_Std_Deny_Prov_HH like '%-%' or TAT_Std_Deny_Prov_Written_DD like '%-%' or TAT_Std_Deny_Prov_Written_HH like '%-%'
or TAT_Std_Ext_Decision_DD like '%-%' or TAT_Std_Appr_Decision_DD like '%-%' or TAT_Std_Ext_Mbr_Verbal_DD like '%-%' or TAT_Std_Ext_Mbr_Written_DD like '%-%'
or TAT_Exp_Appr_Decision_HH like '%-%' or TAT_Exp_Appr_Decision_DD like '%-%' or TAT_Exp_Appr_Mbr_Verbal_DD like '%-%' or TAT_Exp_Appr_Mbr_Verbal_HH like '%-%'
or TAT_Exp_Appr_Mbr_Written_DD like '%-%' or TAT_Exp_Appr_Mbr_Written_HH like '%-%' or TAT_Exp_Appr_Prov_DD like '%-%' or TAT_Exp_Appr_Prov_HH like '%-%' 
or TAT_Exp_Deny_Decision_HH like '%-%' or TAT_Exp_Deny_Decision_DD like '%-%' or TAT_Exp_Deny_Mbr_Verbal_DD like '%-%' or TAT_Exp_Deny_Mbr_Verbal_HH like '%-%'
or TAT_Exp_Deny_Mbr_Written_DD like '%-%' or TAT_Exp_Deny_Mbr_Written_HH like '%-%' or TAT_Exp_Deny_Prov_DD like '%-%' or TAT_Exp_Deny_Prov_HH like '%-%'
or TAT_Exp_Deny_Prov_Written_DD like '%-%' or TAT_Exp_Deny_Prov_Written_HH like '%-%' or TAT_Exp_Crit_Decision_DD like '%-%' or TAT_Exp_Crit_Decision_HH like '%-%'
or TAT_Exp_Crit_Mbr_Verbal_DD like '%-%' or TAT_Exp_Crit_Mbr_Verbal_HH like '%-%' or TAT_Exp_Crit_Mbr_Written_DD like '%-%' or TAT_Exp_Crit_Mbr_Written_HH like '%-%'
or TAT_Exp_Crit_Prov_DD like '%-%' or TAT_Exp_Crit_Prov_HH like '%-%' or TAT_Exp_Ext_Decision_HH like '%-%' or TAT_Exp_Ext_Decision_DD like '%-%'
or TAT_Exp_Ext_Decision_HH like '%-%' or TAT_Exp_Ext_Decision_DD like '%-%' or TAT_Exp_Ext_Mbr_Written_HH like '%-%' or TAT_Exp_Ext_Prov_HH like '%-%'
or TAT_Exp_Ext_Prov_Written_HH like '%-%' or TAT_Exp_NonPar_Prov_HH like '%-%' or TAT_Std_Appr_Decision_DD like '%-%' or TAT_Std_Appr_Decision_HH like '%-%')

if object_id('sheiladb.dbo.DARR_Format') is not null drop table sheiladb.dbo.DARR_Format
select getdate() CreateDate,Timely Compliant, a.Partial, Pend_Service, Part_B
, MD_Review = case when MD_Review is null and (a.authstatus = 'Denied' or a.partial = 'Y') then 'N' when MD_Review is null then 'NA' else MD_Review end 
, Denial_Reason = case when Denial_Reason is null and (a.partial = 'Y' or a.authstatus = 'denied') then 'N' when Denial_Reason is null then 'NA' else Denial_Reason end
,userid,cast(servicecode as varchar) servicecode
, HH_Cont_Servs = case when z.hh_cont_servs is not null then 'Y' else '' end
,review_unit = case when rpt = 'AI' then 'Advanced Imaging' when servicecode = '231' then 'Health Plan' 
when planname in ('CA','ID','MI','OH','SC','TX','UT','WA') and servicecode in ('1038','370') then 'Health Plan' 
else 'Central Medicare Unit' end 
,Auth_Template,a.Authstatus,memid,enrollid,Acuity CareType, isnull(a.ipa,'') IPA
,case when receiptdate = '2078-12-31' then '' else left(convert(varchar,receiptdate,120),10) end ReceiptDate
,left(convert(varchar,effdate,120),10) StartDate
,left(convert(varchar,termdate,120),10) EndDate
,a.referralid,a.authorizationid,a.dbname,Self_Referred = self
,createid,Create_By,Assigned_To,Assign_CM_Fullname Care_Manager,referfrom,referto
,left(convert(varchar,createdate,120),16) Auth_CreateDate
,left(convert(varchar,referraldate,120),10) IssueDate,LOBName
,left(ltrim(rtrim(Appeal_ID)),50) Appeal_ID,Appeal, Appeal_Outcome
, case when appeal_date = '2078-12-31' then '' else left(convert(varchar,Appeal_Date,120),10) end Appeal_Date
,left(convert(varchar,isnull(Modified_Serv_Req,Modified_Serv),120),10) Modified_Service
,carriermemid,headofhouse,planid,BenefitPlan,cmscontractid, planname,Plan_No = CMSPlan_No,acty_grp,compliance_acuity
,case when Ext = 1 then 'Y' else 'N' end as  Extension,Ext, Enp,Extension_Days
,left(convert(varchar,Extension_Date,120),16) Extension_Date
,case when lob like '%MMP%' then 'MMP' else 'Medicare' end LOB,rpt , Authtype,proccat  Category
,left(convert(varchar,Anchor_Date,120),16) Anchor_Receipt_Date  
,left(convert(varchar,TOC_DC_Ord_to_PCP,120),10) TOC_DC_Ord_to_PCP
,left(convert(varchar,TOC_Notif_Emergent_Admit,120),10) TOC_Notif_Emergent_Admit
,left(convert(varchar,TOC_Appr_ED_to_Mem,120),10) TOC_Appr_ED_to_Mem
,left(convert(varchar,TOC_Appr_Ed_to_Prov,120),10) TOC_Appr_Ed_to_Prov
,left(convert(varchar,TOC_Verified_DC_Plan_Sent,120),10) TOC_Verified_DC_Plan_Sent
,left(convert(varchar,TOC_Verified_Fac,120),10) TOC_Verified_Fac
,left(convert(varchar,IP_Auth_Receipt,120),16) IP_Auth_Receipt
,left(convert(varchar,IP_Auth_Receipt,120),10) IP_Auth_Receipt_Date
,left(convert(varchar,IP_Auth_Receipt,108),10) IP_Auth_Receipt_Time
,left(convert(varchar,IP_Decision,120),16) IP_Decision
,left(convert(varchar,IP_Decision,120),10) IP_Decision_Date
,left(convert(varchar,IP_Decision,108),10) IP_Decision_Time
, IP_Compliant
,cast(floor(IP_TAT_Days) as varchar) IP_TAT_Days
,cast(cast(round(IP_TAT_Hours,2,0) as decimal(18,2)) as varchar) IP_TAT_Hours
, left(convert(varchar,Match_Auth_Receipt,120),16) Match_Auth_Receipt
, left(convert(varchar,Match_Decision,120),16) Match_Decision
, left(convert(varchar,Retro_Review,120),30) Retro_Review
,left(convert(varchar,Exp_Appr_Decision_Date,120),10) Exp_Appr_Decision_Date
,left(convert(varchar,Exp_Appr_Decision_Time,108),10) Exp_Appr_Decision_Time
,left(convert(varchar,Exp_Appr_Decision,120),16) Exp_Appr_Decision
,cast(floor(TAT_Exp_Appr_Decision_DD) as varchar) TAT_Exp_Appr_Decision_DD
,cast(cast(round(TAT_Exp_Appr_Decision_HH,2,0) as decimal(18,2)) as varchar) TAT_Exp_Appr_Decision_HH
,left(convert(varchar,Exp_Deny_Decision_Date,120),10) Exp_Deny_Decision_Date
,left(convert(varchar,Exp_Deny_Decision_Time,108),10) Exp_Deny_Decision_Time
,left(convert(varchar,Exp_Deny_Decision,120),16) Exp_Deny_Decision
,cast(floor(TAT_Exp_Deny_Decision_DD) as varchar) TAT_Exp_Deny_Decision_DD
,cast(cast(round(TAT_Exp_Deny_Decision_HH,2,0) as decimal(18,2)) as varchar) TAT_Exp_Deny_Decision_HH
,left(convert(varchar,Std_Appr_Decision_Date,120),10) Std_Appr_Decision_Date
,left(convert(varchar,Std_Appr_Decision_Time,108),10) Std_Appr_Decision_Time
,left(convert(varchar,Std_Appr_Decision_Date,120),10) Std_Appr_Decision
,left(convert(varchar,Std_Deny_Decision_Date,120),10) Std_Deny_Decision_Date
,left(convert(varchar,Std_Deny_Decision_Time,108),10) Std_Deny_Decision_Time
,left(convert(varchar,Std_Deny_Decision_Date,120),10) Std_Deny_Decision
,cast(cast(round(TAT_Exp_Ext_Decision_HH,2,0) as decimal(18,2)) as varchar) TAT_Exp_Ext_Decision_HH
,cast(floor(TAT_Exp_Ext_Decision_DD) as varchar) TAT_Exp_Ext_Decision_DD
,cast(floor(TAT_Std_Appr_Decision_DD) as varchar) TAT_Std_Appr_Decision_DD
,cast(floor(TAT_Std_Deny_Decision_DD) as varchar) TAT_Std_Deny_Decision_DD
,cast(cast(round(TAT_Std_Appr_Decision_HH,2,0) as decimal(18,2)) as varchar) TAT_Std_Appr_Decision_HH
,cast(cast(round(TAT_Std_Deny_Decision_HH,2,0) as decimal(18,2)) as varchar) TAT_Std_Deny_Decision_HH
,cast(floor(TAT_Std_Ext_Decision_DD) as varchar) TAT_Std_Ext_Decision_DD
,isnull(Compliant_Std_Appr_Decision,'') Compliant_Std_Appr_Decision
,isnull(Compliant_Std_Deny_Decision,'') Compliant_Std_Deny_Decision
,isnull(Compliant_Std_Ext_Decision,'') Compliant_Std_Ext_Decision
,isnull(Compliant_Exp_Appr_Decision,'') Compliant_Exp_Appr_Decision
,isnull(Compliant_Exp_Deny_Decision,'') Compliant_Exp_Deny_Decision
,isnull(Compliant_Exp_Ext_Decision,'') Compliant_Exp_Ext_Decision
,left(convert(varchar,Exp_Appr_Auth_Receipt_Date,120),10) Exp_Appr_Auth_Receipt_Date
,left(convert(varchar,Exp_Appr_Auth_Receipt_Time,108),10) Exp_Appr_Auth_Receipt_Time
,left(convert(varchar,Exp_Appr_Auth_Receipt,120),16) Exp_Appr_Auth_Receipt
,left(convert(varchar,Exp_Appr_Mbr_Verbal_Date,120),10) Exp_Appr_Mbr_Verbal_Date
,left(convert(varchar,Exp_Appr_Mbr_Verbal_Time,108),10) Exp_Appr_Mbr_Verbal_Time
,left(convert(varchar,Exp_Appr_Mbr_Verbal,120),16) Exp_Appr_Mbr_Verbal
,cast(cast(round(TAT_Exp_Appr_Mbr_Verbal_HH,2,0) as decimal(18,2)) as varchar) TAT_Exp_Appr_Mbr_Verbal_HH
,cast(floor(TAT_Exp_Appr_Mbr_Verbal_DD) as varchar) TAT_Exp_Appr_Mbr_Verbal_DD
,Compliant_Exp_Appr_Mbr_Verbal
,left(convert(varchar,Exp_Appr_Mbr_Written_Date,120),10) Exp_Appr_Mbr_Written_Date
,left(convert(varchar,Exp_Appr_Mbr_Written,108),10) Exp_Appr_Mbr_Written_Time
,Exp_Appr_Mbr_Written_Raw
,left(convert(varchar,Exp_Appr_Mbr_Written,120),16) Exp_Appr_Mbr_Written
,Mailed_Exp_Appr
,left(Tracking_Exp_Appr,30) Tracking_Exp_Appr
,left(convert(varchar,Delivery_Date_Exp_Appr,120),16)Delivery_Date_Exp_Appr
,Exp_Delivery_Time_Appr
,left(convert(varchar,Exp_Appr_Delivery,120),16) Exp_Appr_Delivery
,cast(floor(TAT_Exp_Appr_Mbr_Written_DD) as varchar) TAT_Exp_Appr_Mbr_Written_DD
,cast(cast(round(TAT_Exp_Appr_Mbr_Written_HH,2,0) as decimal(18,2)) as varchar) TAT_Exp_Appr_Mbr_Written_HH
,Compliant_Exp_Appr_Mbr_Written
,left(convert(varchar,Exp_Appr_Prov,120),10) Exp_Appr_Prov_Date
,left(convert(varchar,Exp_Appr_Prov,108),10) Exp_Appr_Prov_Notif_Time
,left(convert(varchar,Exp_Appr_Prov,120),16) Exp_Appr_Prov_Notif
,cast(floor(TAT_Exp_Appr_Prov_DD) as varchar) TAT_Exp_Appr_Prov_DD
,cast(cast(round(TAT_Exp_Appr_Prov_HH,2,0) as decimal(18,2)) as varchar) TAT_Exp_Appr_Prov_HH
,Compliant_Exp_Appr_Prov Compliant_Exp_Appr_Prov_Notif
,left(convert(varchar,Exp_Deny_Auth_Receipt_Date,120),10) Exp_Deny_Auth_Receipt_Date
,left(convert(varchar,Exp_Deny_Auth_Receipt_Time,108),10) Exp_Deny_Auth_Receipt_Time
,left(convert(varchar,Exp_Deny_Auth_Receipt,120),16) Exp_Deny_Auth_Receipt
,left(convert(varchar,Exp_Deny_Mbr_Verbal_Date,120),10) Exp_Deny_Mbr_Verbal_Date
,left(convert(varchar,Exp_Deny_Mbr_Verbal_Time,108),10) Exp_Deny_Mbr_Verbal_Time
,left(convert(varchar,Exp_Deny_Mbr_Verbal,120),16) Exp_Deny_Mbr_Verbal_Notif
,cast(floor(TAT_Exp_Deny_Mbr_Verbal_DD) as varchar) TAT_Exp_Deny_Mbr_Verbal_DD
,cast(cast(round(TAT_Exp_Deny_Mbr_Verbal_HH,2,0) as decimal(18,2)) as varchar) TAT_Exp_Deny_Mbr_Verbal_HH
,Compliant_Exp_Deny_Mbr_Verbal
,left(convert(varchar,Exp_Deny_Mbr_Written_Date,120),10) Exp_Deny_Mbr_Written_Date
,left(convert(varchar,Exp_Deny_Mbr_Written,108),10) Exp_Deny_Mbr_Written_Time
,Exp_Deny_Mbr_Written_Raw
,left(convert(varchar,Exp_Deny_Mbr_Written,120),16) Exp_Deny_Mbr_Written_Notif
,Mailed_Exp_Deny
,left(Tracking_Exp_Deny,30) Tracking_Exp_Deny
,Delivery_Date_Exp_Deny,Exp_Delivery_Time_Deny
,left(convert(varchar,Exp_Deny_Delivery,120),16) Exp_Deny_Delivery_Date
,cast(floor(TAT_Exp_Deny_Mbr_Written_DD) as varchar) TAT_Exp_Deny_Mbr_Written_DD
,cast(cast(round(TAT_Exp_Deny_Mbr_Written_HH,2,0) as decimal(18,2)) as varchar) TAT_Exp_Deny_Mbr_Written_HH
,Compliant_Exp_Deny_Mbr_Written
,left(convert(varchar,Exp_Deny_Prov_Date,120),10) Exp_Deny_Prov_Date
,left(convert(varchar,Exp_Deny_Prov_Time,108),10) Exp_Deny_Prov_Time
,left(convert(varchar,Exp_Deny_Prov,120),16) Exp_Deny_Prov_Notif
,cast(floor(TAT_Exp_Deny_Prov_DD) as varchar) TAT_Exp_Deny_Prov_DD
,cast(cast(round(TAT_Exp_Deny_Prov_HH,2,0) as decimal(18,2)) as varchar) TAT_Exp_Deny_Prov_HH
,Compliant_Exp_Deny_Prov
,left(convert(varchar,Exp_Deny_Prov_Written_Date,120),10) Exp_Deny_Prov_Written_Date
,left(convert(varchar,Exp_Deny_Prov_Written_Time,108),10) Exp_Deny_Prov_Written_Time
,left(convert(varchar,Exp_Deny_Prov_Written,120),16) Exp_Deny_Prov_Written_Notif
,cast(floor(TAT_Exp_Deny_Prov_Written_DD) as varchar) TAT_Exp_Deny_Prov_Written_DD
,cast(cast(round(TAT_Exp_Deny_Prov_Written_HH,2,0) as decimal(18,2)) as varchar) TAT_Exp_Deny_Prov_Written_HH
,Compliant_Exp_Deny_Prov_Written
,left(convert(varchar,Exp_Crit_Auth_Receipt_Date,120),10) Exp_Crit_Auth_Receipt_Date
,left(convert(varchar,Exp_Crit_Auth_Receipt_Time,108),10) Exp_Crit_Auth_Receipt_Time
,left(convert(varchar,Exp_Crit_Auth_Peceipt,120),16) Exp_Crit_Auth_Receipt
,left(convert(varchar,Exp_Crit_Decision_Date,120),10) Exp_Crit_Decision_Date
,left(convert(varchar,Exp_Crit_Decision_Time,108),10) Exp_Crit_Decision_Time
,left(convert(varchar,Exp_Crit_Decision,120),16) Exp_Crit_Decision
,cast(floor(TAT_Exp_Crit_Decision_DD) as varchar) TAT_Exp_Crit_Decision_DD
,cast(cast(round(TAT_Exp_Crit_Decision_HH,2,0) as decimal(18,2)) as varchar) TAT_Exp_Crit_Decision_HH
,Compliant_Exp_Crit_Decision
,left(convert(varchar,Exp_Crit_Mbr_Verbal_Date,120),10) Exp_Crit_Mbr_Verbal_Date
,left(convert(varchar,Exp_Crit_Mbr_Verbal_Time,108),10) Exp_Crit_Mbr_Verbal_Time
,left(convert(varchar,Exp_Crit_Mbr_Verbal,120),16) Exp_Crit_Mbr_Verbal_Notif
,cast(floor(TAT_Exp_Crit_Mbr_Verbal_DD) as varchar) TAT_Exp_Crit_Mbr_Verbal_DD
,cast(cast(round(TAT_Exp_Crit_Mbr_Verbal_HH,2,0) as decimal(18,2)) as varchar) TAT_Exp_Crit_Mbr_Verbal_HH
,Compliant_Exp_Crit_Mbr_Verbal
,left(convert(varchar,Exp_Crit_Mbr_Written_Date,120),10) Exp_Crit_Mbr_Written_Date
,Exp_Crit_Mbr_Written_Raw
,left(convert(varchar,Exp_Crit_Mbr_Written,108),10) Exp_Crit_Mbr_Written_Time
,left(convert(varchar,Exp_Crit_Mbr_Written,120),16) Exp_Crit_Mbr_Written_Notif
,Mailed_Exp_Crit
,left(Tracking_Exp_Crit,30)Tracking_Exp_Crit 
,Delivery_Date_Exp_Crit,Exp_Delivery_Time_Exp_Crit
,left(convert(varchar,Exp_Crit_Delivery,120),16) Exp_Crit_Delivery
,cast(floor(TAT_Exp_Crit_Mbr_Written_DD) as varchar) TAT_Exp_Crit_Mbr_Written_DD
,cast(cast(round(TAT_Exp_Crit_Mbr_Written_HH,2,0) as decimal(18,2)) as varchar) TAT_Exp_Crit_Mbr_Written_HH
,Compliant_Exp_Crit_Mbr_Written
,left(convert(varchar,Exp_Crit_Prov_Date,120),10) Exp_Crit_Prov_Date
,left(convert(varchar,Exp_Crit_Prov_Time,108),10) Exp_Crit_Prov_Time
,left(convert(varchar,Exp_Crit_Prov,120),16) Exp_Crit_Prov_Notif
,cast(floor(TAT_Exp_Crit_Prov_DD) as varchar) TAT_Exp_Crit_Prov_DD
,cast(cast(round(TAT_Exp_Crit_Prov_HH,2,0) as decimal(18,2)) as varchar) TAT_Exp_Crit_Prov_HH
,Compliant_Exp_Crit_Prov
,left(convert(varchar,Exp_Crit_Prov_Written_Date,120),10) Exp_Crit_Prov_Written_Date
,left(convert(varchar,Exp_Crit_Prov_Written_Time,108),10) Exp_Crit_Prov_Written_Time
,left(convert(varchar,Exp_Crit_Prov_Written,120),16) Exp_Crit_Prov_Written_Notif
,cast(floor(TAT_Exp_Crit_Prov_Written_DD) as varchar) TAT_Exp_Crit_Prov_Written_DD
,cast(cast(round(TAT_Exp_Crit_Prov_Written_HH,2,0) as decimal(18,2)) as varchar) TAT_Exp_Crit_Prov_Written_HH
,Compliant_Exp_Crit_Prov_Written
,left(convert(varchar,Exp_Ext_Auth_Receipt_Date,120),10) Exp_Ext_Auth_Receipt_Date
,left(convert(varchar,Exp_Ext_Auth_Receipt_Time,108),10) Exp_Ext_Auth_Receipt_Time
,left(convert(varchar,Exp_Ext_Auth_Receipt,120),16) Exp_Ext_Auth_Receipt
,left(convert(varchar,Exp_Ext_Decision,120),10) Exp_Ext_Decision_Date
,left(convert(varchar,Exp_Ext_Decision_Time,108),10) Exp_Ext_Decision_Time
,left(convert(varchar,Exp_Ext_Decision,120),16) Exp_Ext_Decision
,Exp_Ext_Days
,left(convert(varchar,Exp_Ext_Mbr_Verbal_Date,120),10) Exp_Ext_Mbr_Verbal_Date
,left(convert(varchar,Exp_Ext_Mbr_Verbal_Time,108),10) Exp_Ext_Mbr_Verbal_Time
,left(convert(varchar,Exp_Ext_Mbr_Verbal,120),16) Exp_Ext_Mbr_Verbal_Notif
,cast(floor(TAT_Exp_Ext_Mbr_Verbal_DD) as varchar) TAT_Exp_Ext_Mbr_Verbal_DD
,cast(cast(round(TAT_Exp_Ext_Mbr_Verbal_HH,2,0) as decimal(18,2)) as varchar) TAT_Exp_Ext_Mbr_Verbal_HH
,Compliant_Exp_Ext_Mbr_Verbal Compliant_Exp_Ext_Mbr_Verbal_Notif
,left(convert(varchar,Exp_Ext_Mbr_Written_Date,120),10) Exp_Ext_Mbr_Written_Date
,left(convert(varchar,Exp_Ext_Mbr_Written,108),10) Exp_Ext_Mbr_Written_Time
,Exp_Ext_Mbr_Written_Raw
,left(convert(varchar,Exp_Ext_Mbr_Written,120),16) Exp_Ext_Mbr_Written_Notif
,Mailed_Exp_Ext,Delivery_Date_Exp_Ext,Exp_Delivery_Time_Exp_Ext
,left(convert(varchar,Exp_Ext_Delivery,120),16)  Exp_Ext_Delivery
,left(Tracking_Exp_Ext,30)Tracking_Exp_Ext
,cast(floor(TAT_Exp_Ext_Mbr_Written_DD) as varchar) TAT_Exp_Ext_Mbr_Written_DD
,cast(cast(round(TAT_Exp_Ext_Mbr_Written_HH,2,0) as decimal(18,2)) as varchar) TAT_Exp_Ext_Mbr_Written_HH
,Compliant_Exp_Ext_Mbr_Written
,left(convert(varchar,Exp_Ext_Prov_Date,120),10) Exp_Ext_Prov_Date
,left(convert(varchar,Exp_Ext_Prov_Time,108),10) Exp_Ext_Prov_Time
,left(convert(varchar,Exp_Ext_Prov,120),16) Exp_Ext_Prov_Notif
,cast(floor(TAT_Exp_Ext_Prov_DD) as varchar) TAT_Exp_Ext_Prov_DD
,cast(cast(round(TAT_Exp_Ext_Prov_HH,2,0) as decimal(18,2)) as varchar) TAT_Exp_Ext_Prov_HH
,Compliant_Exp_Ext_Prov
,left(convert(varchar,Exp_Ext_Prov_Written_Date,120),10) Exp_Ext_Prov_Written_Date
,left(convert(varchar,Exp_Ext_Prov_Written_Time,108),10) Exp_Ext_Prov_Written_Time
,left(convert(varchar,Exp_Ext_Prov_Written,120),16) Exp_Ext_Prov_Written_Notif
,cast(floor(TAT_Exp_Ext_Prov_Written_DD) as varchar) TAT_Exp_Ext_Prov_Written_DD
,cast(cast(round(TAT_Exp_Ext_Prov_Written_HH,2,0) as decimal(18,2)) as varchar) TAT_Exp_Ext_Prov_Written_HH
,Compliant_Exp_Ext_Prov_Written
,left(convert(varchar,Exp_NonPar_Prov_Date,120),10) Exp_NonPar_Prov_Date
,left(convert(varchar,Exp_NonPar_Prov_Time,108),10) Exp_NonPar_Prov_Time
,left(convert(varchar,Exp_NonPar_Prov,120),16) Exp_NonPar_Prov_Notif
,cast(cast(round(TAT_Exp_NonPar_Prov_HH,2,0) as decimal(18,2)) as varchar) TAT_Exp_NonPar_Prov_HH
,Compliant_Exp_NonPar_Prov
,left(convert(varchar,Std_Appr_Auth_Receipt_Date,120),10) Std_Appr_Auth_Receipt_Date
,left(convert(varchar,Std_Appr_Auth_Receipt_Time,108),10) Std_Appr_Auth_Receipt_Time
,left(convert(varchar,Std_Appr_Auth_Receipt_Date,120),10) Std_Appr_Auth_Receipt
,left(convert(varchar,Std_Appr_Mbr_Verbal,120),10) Std_Appr_Mbr_Verbal_Date
,left(convert(varchar,Std_Appr_Mbr_Verbal_Time,108),10) Std_Appr_Mbr_Verbal_Time
,left(convert(varchar,Std_Appr_Mbr_Verbal,120),10) Std_Appr_Mbr_Verbal
,cast(floor(TAT_Std_Appr_Mbr_Verbal_DD) as varchar) TAT_Std_Appr_Mbr_Verbal
,cast(cast(round(TAT_Std_Appr_Mbr_Verbal_HH,2,0) as decimal(18,2)) as varchar) TAT_Std_Appr_Mbr_Verbal_HH
,Compliant_Std_Appr_Mbr_Verbal
,left(convert(varchar,Std_Appr_Mbr_Written,120),10) Std_Appr_Mbr_Written_Date
,left(convert(varchar,Std_Appr_Mbr_Written_Time,108),10) Std_Appr_Mbr_Written_Time
,left(convert(varchar,Std_Appr_Mbr_Written,120),16) Std_Appr_Mbr_Written
,Mailed_Exp_Std_Appr
,left(convert(varchar,Delivery_Date_Std_Appr,120),16) Delivery_Date_Std_Appr
,left(Tracking_Std_Appr,30)Tracking_Std_Appr
,cast(floor(TAT_Std_Appr_Mbr_Written_DD) as varchar) TAT_Std_Appr_Mbr_Written
,cast(cast(round(TAT_Std_Appr_Mbr_Written_HH,2,0) as decimal(18,2)) as varchar) TAT_Std_Appr_Mbr_Written_HH
,Compliant_Std_Appr_Mbr_Written
,left(convert(varchar,Std_Appr_Prov,120),10) Std_Appr_Prov_Notif_Date
,left(convert(varchar,Std_Appr_Prov_Time,108),10) Std_Appr_Prov_Notif_Time
,left(convert(varchar,Std_Appr_Prov,120),16) Std_Appr_Prov_Notif
,cast(floor(TAT_Std_Appr_Prov_DD) as varchar) TAT_Std_Appr_Prov
,cast(cast(round(TAT_Std_Appr_Prov_HH,2,0) as decimal(18,2)) as varchar) TAT_Std_Appr_Prov_HH
,Compliant_Std_Appr_Prov
,left(convert(varchar,Std_Deny_Auth_Receipt_Date,120),10) Std_Deny_Auth_Receipt_Date
,left(convert(varchar,Std_Deny_Auth_Receipt_Time,108),10) Std_Deny_Auth_Receipt_Time
,left(convert(varchar,Std_Deny_Auth_Receipt_Date,120),10) Std_Deny_Auth_Receipt
,left(convert(varchar,Std_Deny_Mbr_Verbal,120),10) Std_Deny_Mbr_Verbal_Date
,left(convert(varchar,Std_Deny_Mbr_Verbal_Time,108),10) Std_Deny_Mbr_Verbal_Time
,left(convert(varchar,Std_Deny_Mbr_Verbal,120),16) Std_Deny_Mbr_Verbal
,cast(floor(TAT_Std_Deny_Mbr_Verbal_DD)  as varchar) TAT_Std_Deny_Mbr_Verbal
,cast(cast(round(TAT_Std_Deny_Mbr_Verbal_HH,2,0) as decimal(18,2)) as varchar) TAT_Std_Deny_Mbr_Verbal_HH
,Compliant_Std_Deny_Mbr_Verbal
,left(convert(varchar,Std_Deny_Mbr_Written,120),10) Std_Deny_Mbr_Written_Date
,left(convert(varchar,Std_Deny_Mbr_Written_Time,108),10) Std_Deny_Mbr_Written_Time
,left(convert(varchar,Std_Deny_Mbr_Written,120),16) Std_Deny_Mbr_Written
,Mailed_Exp_Std_Deny
,left(convert(varchar,Delivery_Date_Std_Deny,120),16) Delivery_Date_Std_Deny
,left(Tracking_Std_Deny,30) Tracking_Std_Deny
,cast(floor(TAT_Std_Deny_Mbr_Written_DD) as varchar) TAT_Std_Deny_Mbr_Written
,cast(cast(round(TAT_Std_Deny_Mbr_Written_HH,2,0) as decimal(18,2)) as varchar) TAT_Std_Deny_Mbr_Written_HH
,Compliant_Std_Deny_Mbr_Written
,left(convert(varchar,Std_Deny_Prov,120),10) Std_Deny_Prov_Notif_Date
,left(convert(varchar,Std_Deny_Prov_Time,108),10) Std_Deny_Prov_Notif_Time
,left(convert(varchar,Std_Deny_Prov,120),16) Std_Deny_Prov_Notif
,cast(floor(TAT_Std_Deny_Prov_DD) as varchar) TAT_Std_Deny_Prov_Notif
,cast(cast(round(TAT_Std_Deny_Prov_HH,2,0) as decimal(18,2)) as varchar) TAT_Std_Deny_Prov_Notif_HH
,Compliant_Std_Deny_Prov
,left(convert(varchar,Std_Deny_Prov_Written,120),10) Std_Deny_Prov_Written_Date
,left(convert(varchar,Std_Deny_Prov_Written_Time,108),10) Std_Deny_Prov_Written_Time
,left(convert(varchar,Std_Deny_Prov_Written,120),16) Std_Deny_Prov_Written
,cast(floor(TAT_Std_Deny_Prov_Written_DD) as varchar) TAT_Std_Deny_Prov_Written
,cast(cast(round(TAT_Std_Deny_Prov_Written_HH,2,0) as decimal(18,2)) as varchar) TAT_Std_Deny_Prov_Written_HH
,Compliant_Std_Deny_Prov_Written
,Std_Ext_Auth_Receipt_Date,Std_Ext_Auth_Receipt_Time
,left(convert(varchar,isnull(Std_Ext_Auth_Receipt,Std_Ext_Auth_Receipt_Date),120),16) Std_Ext_Auth_Receipt
,Std_Ext_Decision_Date,Std_Ext_Decision_Time
,left(convert(varchar,isnull(Std_Ext_Decision,Std_Ext_Decision_Date),120),16) Std_Ext_Decision
,Std_Ext_Days
,left(convert(varchar,Std_Ext_Mbr_Verbal,120),16) Std_Ext_Mbr_Verbal
,cast(floor(TAT_Std_Ext_Mbr_Verbal_DD) as varchar) TAT_Std_Ext_Mbr_Verbal
,Compliant_Std_Ext_Mbr_Verbal
,left(convert(varchar,Std_Ext_Mbr_Written,120),16) Std_Ext_Mbr_Written
,left(convert(varchar,Delivery_Date_Std_Ext,120),16) Delivery_Date_Std_Ext
,Mailed_Exp_Std_Ext
,left(Tracking_Std_Ext,30) Tracking_Std_Ext
,cast(floor(TAT_Std_Ext_Mbr_Written_DD) as varchar) TAT_Std_Ext_Mbr_Written
,Compliant_Std_Ext_Mbr_Written
,left(convert(varchar,Std_Ext_Prov,120),16) Std_Ext_Prov_Notif
,cast(floor(TAT_Std_Ext_Prov_DD) as varchar) TAT_Std_Ext_Prov
,Compliant_Std_Ext_Prov Compliant_Std_Ext_Prov_Notif
,left(convert(varchar,Std_Ext_Prov_Written,120),16) Std_Ext_Prov_Written
,cast(floor(TAT_Std_Ext_Prov_Written_DD) as varchar) TAT_Std_Ext_Prov_Written
,Compliant_Std_Ext_Prov_Written
, Auth_Count = 1
, Compliant_Count = case when timely in ('Y') then 1 else 0 end
, Rpt_Count = case when acty_grp in ('Standard','Expedited','Emergency') then 1 else 0 end
,case when proccat in ('278 - INPATIENT','278 - OUTPATIENT') then 2 else 1 end ord
,Exp_Appr_Mbr_Written_Calc =''
,Exp_Crit_Mbr_Written_Calc=''
,Exp_Deny_mbr_Written_Calc=''
into sheiladb.dbo.DARR_Format
from sheiladb.dbo.DARR_Timely a 
left join sheiladb.dbo.DARR_Misc_Attr z on z.dbname = a.dbname and z.referralid = a.referralid 
left join sheiladb.dbo.HCS_Appeals ap on ap.referralid = a.referralid and ap.dbname = a.dbname
left join sheiladb.dbo.DARR_Denials dn on dn.referralid = a.referralid and dn.dbname = a.dbname
where LOBname in ('Medicare','MMP Medicare','MMP Medicaid')

if object_id('sheiladb.dbo.DARR_Final') is not null drop table sheiladb.dbo.DARR_Final 
create table sheiladb.dbo.DARR_Final
   (CreateDate datetime not null,
DBname varchar(2) not null,
Review_Unit varchar(25) not null,
HeadofHouse varchar(15) not null,
ord int not null,
ReferralID varchar(18) not null,
RPT varchar(5) not null,
PlanName varchar(2) not null,
LOB varchar(50) not null,
LOBname varchar(12) not null,
CMScontractid varchar(6) not null,
Plan_No varchar(3) not null,
createid varchar(40) not null,
Create_By varchar(60) not null,
Assigned_To varchar(50) not null,
IPA varchar(50) not null,
AuthorizationID varchar(20) not null,
ReceiptDate varchar(16) not null,
IssueDate varchar(16) not null,
AuthStatus varchar(10) not null,
Denial_Reason varchar(100) not null,
Appeal_ID varchar(100) not null,
Appeal varchar(2) not null,
Appeal_Outcome varchar(50) not null,
Appeal_Date varchar(10) not null,
StartDate varchar(16) not null,
EndDate varchar(16) not null,
CareType varchar(10) not null,
Auth_Template varchar(60) not null,
Care_Manager varchar(40) not null,
Modified_Service varchar(10) not null,
Self_Referred varchar(1) not null,
Partial varchar(1) not null,
Pend_Service varchar(1) not null,
MD_Review varchar(2) not null,
HH_Cont_Servs varchar(1) not null,
Extension_Days varchar(2) not null,
Extension varchar(1) not null,
Extension_Date varchar(16) not null,
Compliant varchar(1) not null,
IP_Auth_Receipt varchar(16) not null,
IP_Auth_Receipt_Date varchar(10) not null,
IP_Auth_Receipt_Time varchar(10) not null,
IP_Decision varchar(16) not null,
IP_Decision_Date varchar(10) not null,
IP_Decision_Time varchar(10) not null,
IP_Compliant varchar(1) not null,
IP_TAT_Hours varchar(10) not null,
IP_TAT_Days varchar(6) not null,
Match_Auth_Receipt varchar(16) not null,
Match_Decision varchar(16) not null,
Retro_Review varchar(30) not null,
Std_Appr_Auth_Receipt varchar(16) not null,
Std_Appr_Auth_Receipt_Time varchar(10) not null,
Std_Appr_Decision varchar(16) not null,
Std_Appr_Decision_Time varchar(10) not null,
TAT_Std_Appr_Decision_DD varchar(6) not null,
TAT_Std_Appr_Decision_HH varchar(10) not null,
Compliant_Std_Appr_Decision varchar(1) not null,
Std_Appr_Mbr_Verbal varchar(16) not null,
Std_Appr_Mbr_Verbal_Time varchar(10) not null,
TAT_Std_Appr_Mbr_Verbal varchar(6) not null,
TAT_Std_Appr_Mbr_Verbal_HH varchar(10) not null,
Compliant_Std_Appr_Mbr_Verbal varchar(1) not null,
Std_Appr_Mbr_Written varchar(16) not null,
Std_Appr_Mbr_Written_Time varchar(10) not null,
TAT_Std_Appr_Mbr_Written varchar(6) not null,
TAT_Std_Appr_Mbr_Written_HH varchar(10) not null,
Compliant_Std_Appr_Mbr_Written varchar(1) not null,
Std_Appr_Prov_Notif varchar(16) not null,
Std_Appr_Prov_Notif_Time varchar(10) not null,
TAT_Std_Appr_Prov varchar(6) not null,
TAT_Std_Appr_Prov_HH varchar(10) not null,
Std_Deny_Auth_Receipt varchar(16) not null,
Std_Deny_Auth_Receipt_Time varchar(10) not null,
Std_Deny_Decision varchar(16) not null,
Std_Deny_Decision_Time varchar(10) not null,
TAT_Std_Deny_Decision_DD varchar(6) not null,
TAT_Std_Deny_Decision_HH varchar(10) not null,
Compliant_Std_Deny_Decision varchar(2) not null,
Std_Deny_Mbr_Verbal varchar(16) not null,
Std_Deny_Mbr_Verbal_Time varchar(10) not null,
TAT_Std_Deny_Mbr_Verbal varchar(6) not null,
TAT_Std_Deny_Mbr_Verbal_HH varchar(10) not null,
Compliant_Std_Deny_Mbr_Verbal varchar(1) not null,
Std_Deny_Mbr_Written varchar(16) not null,
Std_Deny_Mbr_Written_Time varchar(10) not null,
TAT_Std_Deny_Mbr_Written varchar(6) not null,
TAT_Std_Deny_Mbr_Written_HH varchar(10) not null,
Compliant_Std_Deny_Mbr_Written varchar(1) not null,
Std_Deny_Prov_Notif varchar(16) not null,
Std_Deny_Prov_Notif_Time varchar(10) not null,
TAT_Std_Deny_Prov_Notif varchar(6) not null,
TAT_Std_Deny_Prov_Notif_HH varchar(10) not null,
Std_Deny_Prov_Written varchar(16) not null,
Std_Deny_Prov_Written_Time varchar(10) not null,
TAT_Std_Deny_Prov_Written varchar(6) not null,
TAT_Std_Deny_Prov_Written_HH varchar(10) not null,
Std_Ext_Auth_Receipt varchar(16) not null,
Std_Ext_Decision varchar(16) not null,
TAT_Std_Ext_Decision_DD varchar(6) not null,
Compliant_Std_Ext_Decision varchar(2) not null,
Std_Ext_Mbr_Verbal varchar(16) not null,
TAT_Std_Ext_Mbr_Verbal varchar(6) not null,
Compliant_Std_Ext_Mbr_Verbal varchar(1) not null,
Std_Ext_Mbr_Written varchar(16) not null,
TAT_Std_Ext_Mbr_Written varchar(6) not null,
Compliant_Std_Ext_Mbr_Written varchar(1) not null,
Std_Ext_Prov_Notif varchar(16) not null,
TAT_Std_Ext_Prov varchar(6) not null,
Std_Ext_Prov_Written varchar(16) not null,
TAT_Std_Ext_Prov_Written varchar(6) not null,
Exp_Appr_Auth_Receipt varchar(16) not null,
Exp_Appr_Auth_Receipt_Date varchar(10) not null,
Exp_Appr_Auth_Receipt_Time varchar(10) not null,
Exp_Appr_Decision varchar(16) not null,
Exp_Appr_Decision_Date varchar(10) not null,
Exp_Appr_Decision_Time varchar(10) not null,
TAT_Exp_Appr_Decision_HH varchar(10) not null,
TAT_Exp_Appr_Decision_DD varchar(6) not null,
Compliant_Exp_Appr_Decision varchar(1) not null,
Exp_Appr_Mbr_Verbal varchar(16) not null,
Exp_Appr_Mbr_Verbal_Date varchar(10) not null,
Exp_Appr_Mbr_Verbal_Time varchar(10) not null,
TAT_Exp_Appr_Mbr_Verbal_DD varchar(6) not null,
TAT_Exp_Appr_Mbr_Verbal_HH varchar(10) not null,
Compliant_Exp_Appr_Mbr_Verbal varchar(1) not null,
Exp_Appr_Mbr_Written varchar(16) not null,
Exp_Appr_Mbr_Written_Date varchar(10) not null,
Exp_Appr_Mbr_Written_Time varchar(10) not null,
Mailed_Exp_Std_Appr varchar(3) not null,
Mailed_Exp_Appr varchar(3) not null,
Tracking_Exp_Appr varchar(30) not null,
Delivery_Date_Exp_Appr varchar(16) not null,
Exp_Appr_Delivery varchar(16) not null,
TAT_Exp_Appr_Mbr_Written_DD varchar(6) not null,
TAT_Exp_Appr_Mbr_Written_HH varchar(10) not null,
Compliant_Exp_Appr_Mbr_Written varchar(1) not null,
Exp_Appr_Prov_Notif varchar(16) not null,
Exp_Appr_Prov_Notif_Date varchar(10) not null,
Exp_Appr_Prov_Notif_Time varchar(10) not null,
TAT_Exp_Appr_Prov_DD varchar(6) not null,
TAT_Exp_Appr_Prov_HH varchar(10) not null,
Compliant_Exp_Appr_Prov_Notif varchar(1) not null,
Exp_Deny_Auth_Receipt varchar(16) not null,
Exp_Deny_Auth_Receipt_Date varchar(10) not null,
Exp_Deny_Auth_Receipt_Time varchar(10) not null,
Exp_Deny_Decision varchar(16) not null,
Exp_Deny_Decision_Date varchar(10) not null,
Exp_Deny_Decision_Time varchar(10) not null,
TAT_Exp_Deny_Decision_HH varchar(10) not null,
TAT_Exp_Deny_Decision_DD varchar(6) not null,
Compliant_Exp_Deny_Decision varchar(1) not null,
Exp_Deny_Mbr_Verbal_Notif varchar(16) not null,
Exp_Deny_Mbr_Verbal_Date varchar(10) not null,
Exp_Deny_Mbr_Verbal_Time varchar(10) not null,
Mailed_Exp_Std_Deny varchar(3) not null,
TAT_Exp_Deny_Mbr_Verbal_DD varchar(6) not null,
TAT_Exp_Deny_Mbr_Verbal_HH varchar(10) not null,
Compliant_Exp_Deny_Mbr_Verbal varchar(1) not null,
Exp_Deny_Mbr_Written_Notif varchar(16) not null,
Exp_Deny_Mbr_Written_Date varchar(10) not null,
Exp_Deny_Mbr_Written_Time varchar(10) not null,
Mailed_Exp_Deny varchar(3) not null,
Tracking_Exp_Deny varchar(30) not null,
Delivery_Date_Exp_Deny varchar(16) not null,
Exp_Deny_Delivery_Date varchar(16) not null,
TAT_Exp_Deny_Mbr_Written_DD varchar(6) not null,
TAT_Exp_Deny_Mbr_Written_HH varchar(10) not null,
Compliant_Exp_Deny_Mbr_Written varchar(1) not null,
Exp_Deny_Prov_Notif varchar(16) not null,
Exp_Deny_Prov_Date varchar(10) not null,
Exp_Deny_Prov_Time varchar(10) not null,
TAT_Exp_Deny_Prov_DD varchar(6) not null,
TAT_Exp_Deny_Prov_HH varchar(10) not null,
Compliant_Exp_Deny_Prov varchar(1) not null,
Exp_Deny_Prov_Written_Notif varchar(16) not null,
Exp_Deny_Prov_Written_Date varchar(10) not null,
Exp_Deny_Prov_Written_Time varchar(10) not null,
TAT_Exp_Deny_Prov_Written_DD varchar(6) not null,
TAT_Exp_Deny_Prov_Written_HH varchar(10) not null,
Compliant_Exp_Deny_Prov_Written varchar(1) not null,
Mailed_Exp_Std_Ext varchar(3) not null,
Exp_Crit_Auth_Receipt varchar(16) not null,
Exp_Crit_Auth_Receipt_Date varchar(10) not null,
Exp_Crit_Auth_Receipt_Time varchar(10) not null,
Exp_Crit_Decision varchar(16) not null,
Exp_Crit_Decision_Date varchar(10) not null,
Exp_Crit_Decision_Time varchar(10) not null,
TAT_Exp_Crit_Decision_DD varchar(6) not null,
TAT_Exp_Crit_Decision_HH varchar(10) not null,
Compliant_Exp_Crit_Decision varchar(1) not null,
Exp_Crit_Mbr_Verbal varchar(16) not null,
Exp_Crit_Mbr_Verbal_Date varchar(10) not null,
Exp_Crit_Mbr_Verbal_Time varchar(10) not null,
TAT_Exp_Crit_Mbr_Verbal_DD varchar(6) not null,
TAT_Exp_Crit_Mbr_Verbal_HH varchar(10) not null,
Compliant_Exp_Crit_Mbr_Verbal varchar(1) not null,
Exp_Crit_Mbr_Written_Date varchar(16) not null,
Exp_Crit_Mbr_Written_Time varchar(10) not null,
TAT_Exp_Crit_Mbr_Written_DD varchar(6) not null,
TAT_Exp_Crit_Mbr_Written_HH varchar(10) not null,
Compliant_Exp_Crit_Mbr_Written varchar(1) not null,
Exp_Crit_Prov_Date varchar(16) not null,
Exp_Crit_Prov_Time varchar(10) not null,
TAT_Exp_Crit_Prov_DD varchar(6) not null,
TAT_Exp_Crit_Prov_HH varchar(10) not null,
Compliant_Exp_Crit_Prov varchar(1) not null,
Exp_Crit_Prov_Written_Date varchar(16) not null,
Exp_Crit_Prov_Written_Time varchar(10) not null,
TAT_Exp_Crit_Prov_Written_DD varchar(6) not null,
TAT_Exp_Crit_Prov_Written_HH varchar(10) not null,
Compliant_Exp_Crit_Prov_Written varchar(1) not null,
Exp_Ext_Auth_Receipt varchar(16) not null,
Exp_Ext_Auth_Receipt_Date varchar(10) not null,
Exp_Ext_Auth_Receipt_Time varchar(10) not null,
Exp_Ext_Decision varchar(16) not null,
Exp_Ext_Decision_Date varchar(10) not null,
Exp_Ext_Decision_Time varchar(10) not null,
TAT_Exp_Ext_Decision_HH varchar(10) not null,
TAT_Exp_Ext_Decision_DD varchar(6) not null,
Compliant_Exp_Ext_Decision varchar(1) not null,
Exp_Ext_Days varchar(3) not null,
Exp_Ext_Mbr_Verbal_Notif varchar(16) not null,
Exp_Ext_Mbr_Verbal_Date varchar(10) not null,
Exp_Ext_Mbr_Verbal_Time varchar(10) not null,
TAT_Exp_Ext_Mbr_Verbal_HH varchar(10) not null,
Compliant_Exp_Ext_Mbr_Verbal_Notif varchar(1) not null,
Exp_Ext_Mbr_Written_Notif varchar(16) not null,
Exp_Ext_Mbr_Written_Date varchar(10) not null,
Exp_Ext_Mbr_Written_Time varchar(10) not null,
Mailed_Exp_Ext varchar(3) not null,
Tracking_Exp_Ext varchar(30) not null,
TAT_Exp_Ext_Mbr_Written_DD varchar(6) not null,
TAT_Exp_Ext_Mbr_Written_HH varchar(10) not null,
Compliant_Exp_Ext_Mbr_Written varchar(1) not null,
Exp_Ext_Prov_Notif varchar(16) not null,
Exp_Ext_Prov_Date varchar(10) not null,
Exp_Ext_Prov_Time varchar(10) not null,
TAT_Exp_Ext_Prov_HH varchar(10) not null,
Compliant_Exp_Ext_Prov varchar(1) not null,
Exp_Ext_Prov_Written_Notif varchar(16) not null,
Exp_Ext_Prov_Written_Date varchar(10) not null,
Exp_Ext_Prov_Written_Time varchar(10) not null,
TAT_Exp_Ext_Prov_Written_HH varchar(10) not null,
Compliant_Exp_Ext_Prov_Written varchar(1) not null,
Exp_NonPar_Prov_Notif varchar(16) not null,
Exp_NonPar_Prov_Date varchar(10) not null,
Exp_NonPar_Prov_Time varchar(10) not null,
TAT_Exp_NonPar_Prov_HH varchar(10) not null,
Compliant_Exp_NonPar_Prov varchar(1) not null,
Exp_Appr_Mbr_Written_Calc varchar(16) not null,
Exp_Deny_Mbr_Written_Calc varchar(16) not null,
Mailed_Exp_Crit varchar(3) not null,
TAT_Exp_Crit_Mbr_Written varchar(6) not null,
Tracking_Exp_Crit varchar(30) not null,
Acty_Grp varchar(10) not null,
Anchor_Receipt_Date varchar(16) not null,
Auth_Count int not null,
Auth_CreateDate datetime not null,
AuthType varchar(15) not null,
BenefitPlan varchar(50) not null,
CarrierMemID varchar(20) not null,
Category varchar(35) not null,
Compliance_Acuity varchar(1) not null,
Compliant_Count int not null,
Compliant_Std_Appr_Prov varchar(1) not null,
Compliant_Std_Deny_Prov varchar(1) not null,
Compliant_Std_Deny_Prov_Written varchar(1) not null,
Compliant_Std_Ext_Prov_Notif varchar(1) not null,
Compliant_Std_Ext_Prov_Written varchar(1) not null,
Delivery_Date_Std_Appr varchar(16) not null,
Delivery_Date_Std_Deny varchar(16) not null,
Delivery_Date_Std_Ext varchar(16) not null,
TOC_DC_Ord_to_PCP varchar(10) not null,
Enp varchar(1) not null,
EnrollID varchar(20) not null,
Ext varchar(1) not null,
MemID varchar(20) not null,
TOC_Notif_Emergent_Admit varchar(10) not null,
PlanID varchar(10) not null,
TOC_Appr_ED_to_Mem varchar(10) not null,
Rpt_Count varchar(1) not null,
ServiceCode varchar(6) not null,
Std_Ext_Days varchar(3) not null,
TOC_Appr_Ed_to_Prov varchar(10) not null,
Tracking_Std_Appr varchar(30) not null,
Tracking_Std_Deny varchar(30) not null,
Tracking_Std_Ext varchar(30) not null,
TOC_Verified_DC_Plan_Sent varchar(10) not null,
TOC_Verified_Fac varchar(10) not null
)

insert sheiladb.dbo.DARR_Final
select CreateDate,
isnull(ltrim(rtrim(DBname)),'') DBname,
isnull(ltrim(rtrim(Review_Unit)),'') Review_Unit,
isnull(HeadofHouse,'') HeadofHouse,
isnull(ord,'') ord,
isnull(ReferralID,'') ReferralID,
isnull(ltrim(rtrim(RPT)),'') RPT,
isnull(PlanName,'') PlanName,
isnull(LOB,'') LOB,
isnull(lobname,'') LOBname,
isnull(CMScontractid,'') CMScontractid,
isnull(Plan_No,'') Plan_No,
isnull(createid,'') CreateID,
isnull(Create_By,'') Create_By,
isnull(Assigned_To,'') Assigned_To,
isnull(left(IPA,50),'') IPA,
isnull(AuthorizationID,'') AuthorizationID,
isnull(ReceiptDate,'') ReceiptDate,
isnull(IssueDate,'') IssueDate,
isnull(AuthStatus,'') AuthStatus,
isnull(Denial_Reason,'')Denial_Reason,
isnull(Appeal_ID,'')Appeal_ID,
isnull(Appeal,'')Appeal,
isnull(Appeal_Outcome,'')Appeal_Outcome,
isnull(Appeal_Date,'')Appeal_Date,
isnull(StartDate,'') StartDate,
isnull(EndDate,'') EndDate,
isnull(CareType,'') CareType,
isnull(Auth_Template,'') Auth_Template,
isnull(Care_Manager,'') Care_Manager,
isnull(Modified_Service,'') Modified_Service,
isnull(Self_Referred,'') Self_Referred,
isnull(Partial,'') Partial,
isnull(Pend_Service,'') Pend_Service,
isnull(MD_Review,'') MD_Review,
isnull(HH_Cont_Servs,'') HH_Cont_Servs,
isnull(Extension_Days,'') Extension_Days,
isnull(Extension,'') Extension,
isnull(Extension_Date,'') Extension_Date,
isnull(Compliant,'') Compliant,
isnull(IP_Auth_Receipt, '') IP_Auth_Receipt,
isnull(IP_Auth_Receipt_Date, '') IP_Auth_Receipt_Date,
isnull(IP_Auth_Receipt_Time, '') IP_Auth_Receipt_Time,
isnull(IP_Decision, '') IP_Decision,
isnull(IP_Decision_Date, '') IP_Decision_Date,
isnull(IP_Decision_Time, '') IP_Decision_Time,
isnull(IP_Compliant, '') IP_Compliant,
isnull(IP_TAT_Hours, '') IP_TAT_Hours,
isnull(IP_TAT_Days, '') IP_TAT_Days,
isnull(Match_Auth_Receipt,'')  Match_Auth_Receipt,
isnull(Match_Decision,'') Match_Decision,
isnull(Retro_Review,'') Retro_Review,
isnull(Std_Appr_Auth_Receipt,'') Std_Appr_Auth_Receipt,
isnull(Std_Appr_Auth_Receipt_Time,'') Std_Appr_Auth_Receipt_Time,
isnull(Std_Appr_Decision,'') Std_Appr_Decision,
isnull(Std_Appr_Decision_Time,'') Std_Appr_Decision_Time,
isnull(TAT_Std_Appr_Decision_DD,'') TAT_Std_Appr_Decision_DD,
isnull(TAT_Std_Appr_Decision_HH,'') TAT_Std_Appr_Decision_HH,
isnull(Compliant_Std_Appr_Decision,'') Compliant_Std_Appr_Decision,
isnull(Std_Appr_Mbr_Verbal,'') Std_Appr_Mbr_Verbal,
isnull(Std_Appr_Mbr_Verbal_Time,'') Std_Appr_Mbr_Verbal_Time,
isnull(TAT_Std_Appr_Mbr_Verbal,'') TAT_Std_Appr_Mbr_Verbal,
isnull(TAT_Std_Appr_Mbr_Verbal_HH,'') TAT_Std_Appr_Mbr_Verbal_HH,
isnull(Compliant_Std_Appr_Mbr_Verbal,'') Compliant_Std_Appr_Mbr_Verbal,
isnull(Std_Appr_Mbr_Written,'') Std_Appr_Mbr_Written,
isnull(Std_Appr_Mbr_Written_Time,'') Std_Appr_Mbr_Written_Time,
isnull(TAT_Std_Appr_Mbr_Written,'') TAT_Std_Appr_Mbr_Written,
isnull(TAT_Std_Appr_Mbr_Written_HH,'') TAT_Std_Appr_Mbr_Written_HH,
isnull(Compliant_Std_Appr_Mbr_Written,'') Compliant_Std_Appr_Mbr_Written,
isnull(Std_Appr_Prov_Notif,'') Std_Appr_Prov_Notif,
isnull(Std_Appr_Prov_Notif_Time,'') Std_Appr_Prov_Notif_Time,
isnull(TAT_Std_Appr_Prov,'') TAT_Std_Appr_Prov,
isnull(TAT_Std_Appr_Prov_HH,'') TAT_Std_Appr_Prov_HH,
isnull(Std_Deny_Auth_Receipt,'') Std_Deny_Auth_Receipt,
isnull(Std_Deny_Auth_Receipt_Time,'') Std_Deny_Auth_Receipt_Time,
isnull(Std_Deny_Decision,'') Std_Deny_Decision,
isnull(Std_Deny_Decision_Time,'') Std_Deny_Decision_Time,
isnull(TAT_Std_Deny_Decision_DD,'') TAT_Std_Deny_Decision_DD,
isnull(TAT_Std_Deny_Decision_HH,'') TAT_Std_Deny_Decision_HH,
isnull(Compliant_Std_Deny_Decision,'') Compliant_Std_Deny_Decision,
isnull(Std_Deny_Mbr_Verbal,'') Std_Deny_Mbr_Verbal,
isnull(Std_Deny_Mbr_Verbal_Time,'') Std_Deny_Mbr_Verbal_Time,
isnull(TAT_Std_Deny_Mbr_Verbal,'') TAT_Std_Deny_Mbr_Verbal,
isnull(TAT_Std_Deny_Mbr_Verbal_HH,'') TAT_Std_Deny_Mbr_Verbal_HH,
isnull(Compliant_Std_Deny_Mbr_Verbal,'') Compliant_Std_Deny_Mbr_Verbal,
isnull(Std_Deny_Mbr_Written,'') Std_Deny_Mbr_Written,
isnull(Std_Deny_Mbr_Written_Time,'') Std_Deny_Mbr_Written_Time,
isnull(TAT_Std_Deny_Mbr_Written,'') TAT_Std_Deny_Mbr_Written,
isnull(TAT_Std_Deny_Mbr_Written_HH,'') TAT_Std_Deny_Mbr_Written_HH,
isnull(Compliant_Std_Deny_Mbr_Written,'') Compliant_Std_Deny_Mbr_Written,
isnull(Std_Deny_Prov_Notif,'') Std_Deny_Prov_Notif,
isnull(Std_Deny_Prov_Notif_Time,'') Std_Deny_Prov_Notif_Time,
isnull(TAT_Std_Deny_Prov_Notif,'') TAT_Std_Deny_Prov_Notif,
isnull(TAT_Std_Deny_Prov_Notif_HH,'') TAT_Std_Deny_Prov_Notif_HH,
isnull(Std_Deny_Prov_Written,'') Std_Deny_Prov_Written,
isnull(Std_Deny_Prov_Written_Time,'') Std_Deny_Prov_Written_Time,
isnull(TAT_Std_Deny_Prov_Written,'') TAT_Std_Deny_Prov_Written,
isnull(TAT_Std_Deny_Prov_Written_HH,'') TAT_Std_Deny_Prov_Written_HH,
isnull(Std_Ext_Auth_Receipt,'') Std_Ext_Auth_Receipt,
isnull(Std_Ext_Decision,'') Std_Ext_Decision,
isnull(TAT_Std_Ext_Decision_DD,'') TAT_Std_Ext_Decision_DD,
isnull(Compliant_Std_Ext_Decision,'') Compliant_Std_Ext_Decision,
isnull(Std_Ext_Mbr_Verbal,'') Std_Ext_Mbr_Verbal,
isnull(TAT_Std_Ext_Mbr_Verbal,'') TAT_Std_Ext_Mbr_Verbal,
isnull(Compliant_Std_Ext_Mbr_Verbal,'') Compliant_Std_Ext_Mbr_Verbal,
isnull(Std_Ext_Mbr_Written,'') Std_Ext_Mbr_Written,
isnull(TAT_Std_Ext_Mbr_Written,'') TAT_Std_Ext_Mbr_Written,
isnull(Compliant_Std_Ext_Mbr_Written,'') Compliant_Std_Ext_Mbr_Written,
isnull(Std_Ext_Prov_Notif,'') Std_Ext_Prov_Notif,
isnull(TAT_Std_Ext_Prov,'') TAT_Std_Ext_Prov,
isnull(Std_Ext_Prov_Written,'') Std_Ext_Prov_Written,
isnull(TAT_Std_Ext_Prov_Written,'') TAT_Std_Ext_Prov_Written,
isnull(Exp_Appr_Auth_Receipt,'') Exp_Appr_Auth_Receipt,
isnull(Exp_Appr_Auth_Receipt_Date,'') Exp_Appr_Auth_Receipt_Date,
isnull(Exp_Appr_Auth_Receipt_Time,'') Exp_Appr_Auth_Receipt_Time,
isnull(Exp_Appr_Decision,'') Exp_Appr_Decision,
isnull(Exp_Appr_Decision_date,'') Exp_Appr_Decision_date,
isnull(Exp_Appr_Decision_Time,'') Exp_Appr_Decision_Time,
isnull(TAT_Exp_Appr_Decision_HH,'') TAT_Exp_Appr_Decision_HH,
isnull(TAT_Exp_Appr_Decision_DD,'') TAT_Exp_Appr_Decision_DD,
isnull(Compliant_Exp_Appr_Decision,'') Compliant_Exp_Appr_Decision,
isnull(Exp_Appr_Mbr_Verbal,'') Exp_Appr_Mbr_Verbal,
isnull(Exp_Appr_Mbr_Verbal_Date,'') Exp_Appr_Mbr_Verbal_Date,
isnull(Exp_Appr_Mbr_Verbal_Time,'') Exp_Appr_Mbr_Verbal_Time,
isnull(TAT_Exp_Appr_Mbr_Verbal_DD,'') TAT_Exp_Appr_Mbr_Verbal_DD,
isnull(TAT_Exp_Appr_Mbr_Verbal_HH,'') TAT_Exp_Appr_Mbr_Verbal_HH,
isnull(Compliant_Exp_Appr_Mbr_Verbal,'') Compliant_Exp_Appr_Mbr_Verbal,
isnull(Exp_Appr_Mbr_Written,'') Exp_Appr_Mbr_Written,
isnull(Exp_Appr_Mbr_Written_Date,'') Exp_Appr_Mbr_Written_Date,
isnull(Exp_Appr_Mbr_Written_Time,'') Exp_Appr_Mbr_Written_Time,
isnull(Mailed_Exp_Std_Appr,'') Mailed_Exp_Std_Appr,
isnull(Mailed_Exp_Appr,'') Mailed_Exp_Appr,
isnull(Tracking_Exp_Appr,'') Tracking_Exp_Appr,
isnull(Delivery_Date_Exp_Appr,'') Delivery_Date_Exp_Appr,
isnull(Exp_Appr_Delivery,'') Exp_Appr_Delivery,
isnull(TAT_Exp_Appr_Mbr_Written_DD,'') TAT_Exp_Appr_Mbr_Written_DD,
isnull(TAT_Exp_Appr_Mbr_Written_HH,'') TAT_Exp_Appr_Mbr_Written_HH,
isnull(Compliant_Exp_Appr_Mbr_Written,'') Compliant_Exp_Appr_Mbr_Written,
isnull(Exp_Appr_Prov_Notif,'') Exp_Appr_Prov_Notif,
isnull(Exp_Appr_Prov_Date,'') Exp_Appr_Prov_Date,
isnull(Exp_Appr_Prov_Notif_Time,'') Exp_Appr_Prov_Notif_Time,
isnull(TAT_Exp_Appr_Prov_DD,'') TAT_Exp_Appr_Prov_DD,
isnull(TAT_Exp_Appr_Prov_HH,'') TAT_Exp_Appr_Prov_HH,
isnull(Compliant_Exp_Appr_Prov_Notif,'') Compliant_Exp_Appr_Prov_Notif,
isnull(Exp_Deny_Auth_Receipt,'') Exp_Deny_Auth_Receipt,
isnull(Exp_Deny_Auth_Receipt_Date,'') Exp_Deny_Auth_Receipt_Date,
isnull(Exp_Deny_Auth_Receipt_Time,'') Exp_Deny_Auth_Receipt_Time,
isnull(Exp_Deny_Decision,'') Exp_Deny_Decision,
isnull(Exp_Deny_Decision_Date,'') Exp_Deny_Decision_Date,
isnull(Exp_Deny_Decision_Time,'') Exp_Deny_Decision_Time,
isnull(TAT_Exp_Deny_Decision_HH,'') TAT_Exp_Deny_Decision_HH,
isnull(TAT_Exp_Deny_Decision_DD,'') TAT_Exp_Deny_Decision_DD,
isnull(Compliant_Exp_Deny_Decision,'') Compliant_Exp_Deny_Decision,
isnull(Exp_Deny_Mbr_Verbal_Notif,'') Exp_Deny_Mbr_Verbal_Notif,
isnull(Exp_Deny_Mbr_Verbal_Date,'') Exp_Deny_Mbr_Verbal_Date,
isnull(Exp_Deny_Mbr_Verbal_Time,'') Exp_Deny_Mbr_Verbal_Time,
isnull(Mailed_Exp_Std_Deny,'') Mailed_Exp_Std_Deny,
isnull(TAT_Exp_Deny_Mbr_Verbal_DD,'') TAT_Exp_Deny_Mbr_Verbal_DD,
isnull(TAT_Exp_Deny_Mbr_Verbal_HH,'') TAT_Exp_Deny_Mbr_Verbal_HH,
isnull(Compliant_Exp_Deny_Mbr_Verbal,'') Compliant_Exp_Deny_Mbr_Verbal,
isnull(Exp_Deny_Mbr_Written_Notif,'') Exp_Deny_Mbr_Written_Notif,
isnull(Exp_Deny_Mbr_Written_Date,'') Exp_Deny_Mbr_Written_Date,
isnull(Exp_Deny_Mbr_Written_Time,'') Exp_Deny_Mbr_Written_Time,
isnull(Mailed_Exp_Deny,'') Mailed_Exp_Deny,
isnull(Tracking_Exp_Deny,'') Tracking_Exp_Deny,
isnull(Delivery_Date_Exp_Deny,'') Delivery_Date_Exp_Deny,
isnull(Exp_Deny_Delivery_Date,'') Exp_Deny_Delivery_Date,
isnull(TAT_Exp_Deny_Mbr_Written_DD,'') TAT_Exp_Deny_Mbr_Written_DD,
isnull(TAT_Exp_Deny_Mbr_Written_HH,'') TAT_Exp_Deny_Mbr_Written_HH,
isnull(Compliant_Exp_Deny_Mbr_Written,'') Compliant_Exp_Deny_Mbr_Written,
isnull(Exp_Deny_Prov_Notif,'') Exp_Deny_Prov_Notif,
isnull(Exp_Deny_Prov_Date,'') Exp_Deny_Prov_Date,
isnull(Exp_Deny_Prov_Time,'') Exp_Deny_Prov_Time,
isnull(TAT_Exp_Deny_Prov_DD,'') TAT_Exp_Deny_Prov_DD,
isnull(TAT_Exp_Deny_Prov_HH,'') TAT_Exp_Deny_Prov_HH,
isnull(Compliant_Exp_Deny_Prov,'') Compliant_Exp_Deny_Prov,
isnull(Exp_Deny_Prov_Written_Notif,'') Exp_Deny_Prov_Written_Notif,
isnull(Exp_Deny_Prov_Written_Date,'') Exp_Deny_Prov_Written_Date,
isnull(Exp_Deny_Prov_Written_Time,'') Exp_Deny_Prov_Written_Time,
isnull(TAT_Exp_Deny_Prov_Written_DD,'') TAT_Exp_Deny_Prov_Written_DD,
isnull(TAT_Exp_Deny_Prov_Written_HH,'') TAT_Exp_Deny_Prov_Written_HH,
isnull(Compliant_Exp_Deny_Prov_Written,'') Compliant_Exp_Deny_Prov_Written,
isnull(Mailed_Exp_Std_Ext,'') Mailed_Exp_Std_Ext,
isnull(Exp_Crit_Auth_Receipt,'') Exp_Crit_Auth_Receipt,
isnull(Exp_Crit_Auth_Receipt_Date,'') Exp_Crit_Auth_Receipt_Date,
isnull(Exp_Crit_Auth_Receipt_Time,'') Exp_Crit_Auth_Receipt_Time,
isnull(Exp_Crit_Decision,'') Exp_Crit_Decision,
isnull(Exp_Crit_Decision_Date,'') Exp_Crit_Decision_Date,
isnull(Exp_Crit_Decision_Time ,'') Exp_Crit_Decision_Time,
isnull(TAT_Exp_Crit_Decision_DD ,'') TAT_Exp_Crit_Decision_DD,
isnull(TAT_Exp_Crit_Decision_HH ,'') TAT_Exp_Crit_Decision_HH,
isnull(Compliant_Exp_Crit_Decision ,'') Compliant_Exp_Crit_Decision,
isnull(Exp_Crit_Mbr_Verbal_Date,'') Exp_Crit_Mbr_Verbal,
isnull(Exp_Crit_Mbr_Verbal_Date,'')Exp_Crit_Mbr_Verbal_Date,
isnull(Exp_Crit_Mbr_Verbal_Time,'') Exp_Crit_Mbr_Verbal_Time,
isnull(TAT_Exp_Crit_Mbr_Verbal_DD,'') TAT_Exp_Crit_Mbr_Verbal_DD,
isnull(TAT_Exp_Crit_Mbr_Verbal_HH ,'') TAT_Exp_Crit_Mbr_Verbal_HH,
isnull(Compliant_Exp_Crit_Mbr_Verbal,'') Compliant_Exp_Crit_Mbr_Verbal,
isnull(Exp_Crit_Mbr_Written_Date,'') Exp_Crit_Mbr_Written_Date,
isnull(Exp_Crit_Mbr_Written_Time,'') Exp_Crit_Mbr_Written_Time,
isnull(TAT_Exp_Crit_Mbr_Written_DD,'') TAT_Exp_Crit_Mbr_Written_DD,
isnull(TAT_Exp_Crit_Mbr_Written_HH,'') TAT_Exp_Crit_Mbr_Written_HH,
isnull(Compliant_Exp_Crit_Mbr_Written,'') Compliant_Exp_Crit_Mbr_Written,
isnull(Exp_Crit_Prov_Date,'') Exp_Crit_Prov_Date,
isnull(Exp_Crit_Prov_Time,'') Exp_Crit_Prov_Time,
isnull(TAT_Exp_Crit_Prov_DD,'') TAT_Exp_Crit_Prov_DD,
isnull(TAT_Exp_Crit_Prov_HH,'') TAT_Exp_Crit_Prov_HH,
isnull(Compliant_Exp_Crit_Prov,'') Compliant_Exp_Crit_Prov,
isnull(Exp_Crit_Prov_Written_Date,'') Exp_Crit_Prov_Written_Date,
isnull(Exp_Crit_Prov_Written_Time,'') Exp_Crit_Prov_Written_Time,
isnull(TAT_Exp_Crit_Prov_Written_DD,'') TAT_Exp_Crit_Prov_Written_DD,
isnull(TAT_Exp_Crit_Prov_Written_HH,'') TAT_Exp_Crit_Prov_Written_HH,
isnull(Compliant_Exp_Crit_Prov_Written,'') Compliant_Exp_Crit_Prov_Written,
isnull(Exp_Ext_Auth_Receipt,'') Exp_Ext_Auth_Receipt,
isnull(Exp_Ext_Auth_Receipt_Date,'') Exp_Ext_Auth_Receipt_Date,
isnull(Exp_Ext_Auth_Receipt_Time,'') Exp_Ext_Auth_Receipt_Time,
isnull(Exp_Ext_Decision,'') Exp_Ext_Decision,
isnull(Exp_Ext_Decision_Date,'') Exp_Ext_Decision_Date,
isnull(Exp_Ext_Decision_Time,'') Exp_Ext_Decision_Time,
isnull(TAT_Exp_Ext_Decision_HH,'') TAT_Exp_Ext_Decision_HH,
isnull(TAT_Exp_Ext_Decision_DD,'') TAT_Exp_Ext_Decision_DD,
isnull(Compliant_Exp_Ext_Decision,'') Compliant_Exp_Ext_Decision,
isnull(Exp_Ext_Days,'') Exp_Ext_Days,
isnull(Exp_Ext_Mbr_Verbal_Notif,'') Exp_Ext_Mbr_Verbal_Notif,
isnull(Exp_Ext_Mbr_Verbal_Date,'') Exp_Ext_Mbr_Verbal_Date,
isnull(Exp_Ext_Mbr_Verbal_Time,'') Exp_Ext_Mbr_Verbal_Time,
isnull(TAT_Exp_Ext_Mbr_Verbal_HH,'') TAT_Exp_Ext_Mbr_Verbal_HH,
isnull(Compliant_Exp_Ext_Mbr_Verbal_Notif,'') Compliant_Exp_Ext_Mbr_Verbal_Notif,
isnull(Exp_Ext_Mbr_Written_Notif,'') Exp_Ext_Mbr_Written_Notif,
isnull(Exp_Ext_Mbr_Written_Date,'') Exp_Ext_Mbr_Written_Date,
isnull(Exp_Ext_Mbr_Written_Time,'') Exp_Ext_Mbr_Written_Time,
isnull(Mailed_Exp_Ext,'') Mailed_Exp_Ext,
isnull(Tracking_Exp_Ext,'') Tracking_Exp_Ext,
isnull(TAT_Exp_Ext_Mbr_Written_DD,'') TAT_Exp_Ext_Mbr_Written_DD,
isnull(TAT_Exp_Ext_Mbr_Written_HH,'') TAT_Exp_Ext_Mbr_Written_HH,
isnull(Compliant_Exp_Ext_Mbr_Written,'') Compliant_Exp_Ext_Mbr_Written,
isnull(Exp_Ext_Prov_Notif,'') Exp_Ext_Prov_Notif,
isnull(Exp_Ext_Prov_Date,'') Exp_Ext_Prov_Date,
isnull(Exp_Ext_Prov_Time,'') Exp_Ext_Prov_Time,
isnull(TAT_Exp_Ext_Prov_HH,'') TAT_Exp_Ext_Prov_HH,
isnull(Compliant_Exp_Ext_Prov,'') Compliant_Exp_Ext_Prov,
isnull(Exp_Ext_Prov_Written_Notif,'') Exp_Ext_Prov_Written_Notif,
isnull(Exp_Ext_Prov_Written_Date,'') Exp_Ext_Prov_Written_Date,
isnull(Exp_Ext_Prov_Written_Time,'') Exp_Ext_Prov_Written_Time,
isnull(TAT_Exp_Ext_Prov_Written_HH,'') TAT_Exp_Ext_Prov_Written_HH,
isnull(Compliant_Exp_Ext_Prov_Written,'') Compliant_Exp_Ext_Prov_Written,
isnull(Exp_NonPar_Prov_Notif,'') Exp_NonPar_Prov_Notif,
isnull(Exp_NonPar_Prov_Date,'') Exp_NonPar_Prov_Date,
isnull(Exp_NonPar_Prov_Time,'') Exp_NonPar_Prov_Time,
isnull(TAT_Exp_NonPar_Prov_HH,'') TAT_Exp_NonPar_Prov_HH,
isnull(Compliant_Exp_NonPar_Prov,'') Compliant_Exp_NonPar_Prov,
isnull(Exp_Appr_Mbr_Written_Calc,'') Exp_Appr_Mbr_Written_Calc,
isnull(Exp_Deny_Mbr_Written_Calc,'') Exp_Deny_Mbr_Written_Calc,
isnull(Mailed_Exp_Crit,'') Mailed_Exp_Crit,
isnull(TAT_Exp_Crit_Mbr_Written_HH,'') TAT_Exp_Crit_Mbr_Written_HH,
isnull(Tracking_Exp_Crit,'') Tracking_Exp_Crit,
isnull(Acty_Grp,'') Acty_Grp,
isnull(Anchor_Receipt_Date,'') Anchor_Receipt_Date,
isnull(Auth_Count,'') Auth_Count,
isnull(Auth_CreateDate,'') Auth_CreateDate,
isnull(rtrim(ltrim(AuthType)),'') AuthType,
isnull(BenefitPlan,'') BenefitPlan,
isnull(CarrierMemID,'') CarrierMemID,
isnull(rtrim(ltrim(Category)),'') Category,
isnull(Compliance_Acuity,'') Compliance_Acuity,
isnull(Compliant_Count,'') Compliant_Count,
isnull(Compliant_Std_Appr_Prov,'') Compliant_Std_Appr_Prov,
isnull(Compliant_Std_Deny_Prov,'') Compliant_Std_Deny_Prov,
isnull(Compliant_Std_Deny_Prov_Written,'') Compliant_Std_Deny_Prov_Written,
isnull(Compliant_Std_Ext_Prov_Notif,'') Compliant_Std_Ext_Prov_Notif,
isnull(Compliant_Std_Ext_Prov_Written,'') Compliant_Std_Ext_Prov_Written,
isnull(Delivery_Date_Std_Appr,'') Delivery_Date_Std_Appr,
isnull(Delivery_Date_Std_Deny,'') Delivery_Date_Std_Deny,
isnull(Delivery_Date_Std_Ext,'') Delivery_Date_Std_Ext,
isnull(TOC_DC_Ord_to_PCP,'') TOC_DC_Ord_to_PCP,
isnull(Enp,'') Enp,
isnull(EnrollID,'') EnrollID,
isnull(Ext,'') Ext,
isnull(MemID,'') MemID,
isnull(TOC_Notif_Emergent_Admit,'') TOC_Notif_Emergent_Admit,
isnull(PlanID,'') PlanID,
isnull(TOC_Appr_ED_to_Mem,'') TOC_Appr_ED_to_Mem,
isnull(Rpt_Count,'') Rpt_Count,
isnull(rtrim(ltrim(ServiceCode)),'') ServiceCode,
isnull(Std_Ext_Days,'') Std_Ext_Days,
isnull(TOC_Appr_Ed_to_Prov,'') TOC_Appr_Ed_to_Prov,
isnull(Tracking_Std_Appr,'') Tracking_Std_Appr,
isnull(Tracking_Std_Deny,'') Tracking_Std_Deny,
isnull(Tracking_Std_Ext,'') Tracking_Std_Ext,
isnull(TOC_Verified_DC_Plan_Sent,'') TOC_Verified_DC_Plan_Sent,
isnull(TOC_Verified_Fac,'') TOC_Verified_Fac
from sheiladb.dbo.darr_format 

--Blank out irrelevant TAT based on hours/days
update sheiladb.dbo.darr_final
set TAT_Exp_Appr_Decision_HH=case when ext='1' or (DBname = 'TX' and datepart(dw,Exp_Appr_Auth_Receipt)=6 and Match_Auth_Receipt >= '2019-01-01') then '' else TAT_Exp_Appr_Decision_HH end 
,TAT_Exp_Appr_Decision_DD=case when ext='1' or (DBname = 'TX' and datepart(dw,Exp_Appr_Auth_Receipt)=6 and Match_Auth_Receipt >= '2019-01-01') then TAT_Exp_Appr_Decision_DD else '' end
,TAT_Exp_Appr_Mbr_Verbal_DD=case when ext='1' or (DBname = 'TX' and datepart(dw,Exp_Appr_Auth_Receipt)=6 and Match_Auth_Receipt >= '2019-01-01') then TAT_Exp_Appr_Mbr_Verbal_DD else '' end 
,TAT_Exp_Appr_Mbr_Verbal_HH=case when ext='1' or (DBname = 'TX' and datepart(dw,Exp_Appr_Auth_Receipt)=6 and Match_Auth_Receipt >= '2019-01-01') then '' else TAT_Exp_Appr_Mbr_Verbal_HH end 
,TAT_Exp_Appr_Mbr_Written_DD=case when ext='1' or (DBname = 'TX' and datepart(dw,Exp_Appr_Auth_Receipt)=6 and Match_Auth_Receipt >= '2019-01-01') then TAT_Exp_Appr_Mbr_Written_DD else '' end 
,TAT_Exp_Appr_Mbr_Written_HH=case when ext='1' or (DBname = 'TX' and datepart(dw,Exp_Appr_Auth_Receipt)=6 and Match_Auth_Receipt >= '2019-01-01') then '' else TAT_Exp_Appr_Mbr_Written_HH end 
,TAT_Exp_Appr_Prov_DD=case when ext='1' or (DBname = 'TX' and datepart(dw,Exp_Appr_Auth_Receipt)=6 and Match_Auth_Receipt >= '2019-01-01') then TAT_Exp_Appr_Prov_DD else '' end 
,TAT_Exp_Appr_Prov_HH=case when ext='1' or (DBname = 'TX' and datepart(dw,Exp_Appr_Auth_Receipt)=6 and Match_Auth_Receipt >= '2019-01-01') then '' else TAT_Exp_Appr_Prov_HH end 
,TAT_Exp_Deny_Decision_HH=case when ext='1' or (DBname = 'TX' and datepart(dw,Exp_Deny_Auth_Receipt)=6 and Exp_Deny_Auth_Receipt >= '2019-01-01') then '' else TAT_Exp_Deny_Decision_HH end 
,TAT_Exp_Deny_Decision_DD=case when ext='1' or (DBname = 'TX' and datepart(dw,Exp_Deny_Auth_Receipt)=6 and Exp_Deny_Auth_Receipt >= '2019-01-01') then TAT_Exp_Deny_Decision_DD else '' end
,TAT_Exp_Deny_Mbr_Verbal_DD=case when ext='1' or (DBname = 'TX' and datepart(dw,Exp_Deny_Auth_Receipt)=6 and Exp_Deny_Auth_Receipt >= '2019-01-01') then TAT_Exp_Deny_Mbr_Verbal_DD else '' end 
,TAT_Exp_Deny_Mbr_Verbal_HH=case when ext='1' or (DBname = 'TX' and datepart(dw,Exp_Deny_Auth_Receipt)=6 and Exp_Deny_Auth_Receipt >= '2019-01-01') then '' else TAT_Exp_Deny_Mbr_Verbal_HH end 
,TAT_Exp_Deny_Mbr_Written_DD=case when ext='1' or (DBname = 'TX' and datepart(dw,Exp_Deny_Auth_Receipt)=6 and Exp_Deny_Auth_Receipt >= '2019-01-01') then TAT_Exp_Deny_Mbr_Written_DD else '' end 
,TAT_Exp_Deny_Mbr_Written_HH=case when ext='1' or (DBname = 'TX' and datepart(dw,Exp_Deny_Auth_Receipt)=6 and Exp_Deny_Auth_Receipt >= '2019-01-01')  then '' else TAT_Exp_Deny_Mbr_Written_HH end 
,TAT_Exp_Deny_Prov_DD=case when ext='1' or (DBname = 'TX' and datepart(dw,Exp_Deny_Auth_Receipt)=6 and Exp_Deny_Auth_Receipt >= '2019-01-01') then TAT_Exp_Deny_Prov_DD else '' end 
,TAT_Exp_Deny_Prov_HH=case when ext='1' or (DBname = 'TX' and datepart(dw,Exp_Deny_Auth_Receipt)=6 and Exp_Deny_Auth_Receipt >= '2019-01-01') then '' else TAT_Exp_Deny_Prov_HH end 
,TAT_Exp_Deny_Prov_Written_DD=case when ext='1' or (DBname = 'TX' and datepart(dw,Exp_Deny_Auth_Receipt)=6 and Exp_Deny_Auth_Receipt >= '2019-01-01') then TAT_Exp_Deny_Prov_Written_DD else '' end 
,TAT_Exp_Deny_Prov_Written_HH=case when ext='1' or (DBname = 'TX' and datepart(dw,Exp_Deny_Auth_Receipt)=6 and Exp_Deny_Auth_Receipt >= '2019-01-01') then '' else TAT_Exp_Deny_Prov_Written_HH end 


if object_id('sheiladb.dbo.DARR_SFinal') is not null drop table sheiladb.dbo.DARR_SFinal
select Acty_Grp,Anchor_Receipt_Date,Auth_Count,Auth_CreateDate,Auth_Template,a.AuthorizationID,AuthStatus
,AuthType,CareType,Category,Compliance_Acuity,Compliant_Count,a.DBname,Enp,Ext,Extension,LOB,LOBname,ord,PlanName,RPT	
,case when Compliant = 'Y' then '1' when Compliant = 'N' then '0' else '' end Compliant, Partial
,case when Compliant_Exp_Appr_Mbr_Verbal = 'Y' then '1' when Compliant_Exp_Appr_Mbr_Verbal = 'N' then '0' else '' end as Compliant_Exp_Appr_Mbr_Verbal
,case when Compliant_Exp_Appr_Mbr_Written = 'Y' then '1' when Compliant_Exp_Appr_Mbr_Written = 'N' then '0' else '' end as Compliant_Exp_Appr_Mbr_Written
,case when Compliant_Exp_Appr_Prov_Notif = 'Y' then '1' when Compliant_Exp_Appr_Prov_Notif = 'N' then '0' else '' end as Compliant_Exp_Appr_Prov_Notif
,case when Compliant_Exp_Deny_Mbr_Verbal = 'Y' then '1' when Compliant_Exp_Deny_Mbr_Verbal = 'N' then '0' else '' end as Compliant_Exp_Deny_Mbr_Verbal
,case when Compliant_Exp_Deny_Mbr_Written = 'Y' then '1' when Compliant_Exp_Deny_Mbr_Written = 'N' then '0' else '' end as Compliant_Exp_Deny_Mbr_Written
,case when Compliant_Exp_Deny_Prov = 'Y' then '1' when Compliant_Exp_Deny_Prov = 'N' then '0' else '' end as Compliant_Exp_Deny_Prov
,case when Compliant_Exp_Deny_Prov_Written = 'Y' then '1' when Compliant_Exp_Deny_Prov_Written = 'N' then '0' else '' end as Compliant_Exp_Deny_Prov_Written
,case when Compliant_Exp_Ext_Mbr_Verbal_Notif = 'Y' then '1' when Compliant_Exp_Ext_Mbr_Verbal_Notif = 'N' then '0' else '' end as Compliant_Exp_Ext_Mbr_Verbal_Notif
,case when Compliant_Exp_Ext_Mbr_Written = 'Y' then '1' when Compliant_Exp_Ext_Mbr_Written = 'N' then '0' else '' end as Compliant_Exp_Ext_Mbr_Written
,case when Compliant_Exp_Ext_Prov = 'Y' then '1' when Compliant_Exp_Ext_Prov = 'N' then '0' else '' end as Compliant_Exp_Ext_Prov
,case when Compliant_Exp_Ext_Prov_Written = 'Y' then '1' when Compliant_Exp_Ext_Prov_Written = 'N' then '0' else '' end as Compliant_Exp_Ext_Prov_Written
,case when Compliant_Exp_NonPar_Prov = 'Y' then '1' when Compliant_Exp_NonPar_Prov = 'N' then '0' else '' end as Compliant_Exp_NonPar_Prov
,case when Compliant_Std_Appr_Mbr_Verbal = 'Y' then '1' when Compliant_Std_Appr_Mbr_Verbal = 'N' then '0' else '' end as Compliant_Std_Appr_Mbr_Verbal
,case when Compliant_Std_Appr_Mbr_Written = 'Y' then '1' when Compliant_Std_Appr_Mbr_Written = 'N' then '0' else '' end as Compliant_Std_Appr_Mbr_Written
,case when Compliant_Std_Appr_Prov = 'Y' then '1' when Compliant_Std_Appr_Prov = 'N' then '0' else '' end as Compliant_Std_Appr_Prov
,case when Compliant_Std_Deny_Mbr_Verbal = 'Y' then '1' when Compliant_Std_Deny_Mbr_Verbal = 'N' then '0' else '' end as Compliant_Std_Deny_Mbr_Verbal
,case when Compliant_Std_Deny_Mbr_Written = 'Y' then '1' when Compliant_Std_Deny_Mbr_Written = 'N' then '0' else '' end as Compliant_Std_Deny_Mbr_Written
,case when Compliant_Std_Deny_Prov = 'Y' then '1' when Compliant_Std_Deny_Prov = 'N' then '0' else '' end as Compliant_Std_Deny_Prov
,case when Compliant_Std_Deny_Prov_Written = 'Y' then '1' when Compliant_Std_Deny_Prov_Written = 'N' then '0' else '' end as Compliant_Std_Deny_Prov_Written
,case when Compliant_Std_Ext_Mbr_Verbal = 'Y' then '1' when Compliant_Std_Ext_Mbr_Verbal = 'N' then '0' else '' end as Compliant_Std_Ext_Mbr_Verbal
,case when Compliant_Std_Ext_Mbr_Written = 'Y' then '1' when Compliant_Std_Ext_Mbr_Written = 'N' then '0' else '' end as Compliant_Std_Ext_Mbr_Written
,case when Compliant_Std_Ext_Prov_Notif = 'Y' then '1' when Compliant_Std_Ext_Prov_Notif = 'N' then '0' else '' end as Compliant_Std_Ext_Prov_Notif
,case when Compliant_Std_Ext_Prov_Written = 'Y' then '1' when Compliant_Std_Ext_Prov_Written = 'N' then '0' else '' end as Compliant_Std_Ext_Prov_Written
into sheiladb.dbo.DARR_SFinal from sheiladb.dbo.DARR_Final a where rpt_count = 1

if object_id('sheiladb.dbo.DARR_Summary_ExEVS') is not null drop table sheiladb.dbo.DARR_Summary_ExEVS
select * into sheiladb.dbo.DARR_Summary_ExEVS from sheiladb.dbo.DARR_SFinal where rpt='EV' and caretype = 'urgent'
if object_id('sheiladb.dbo.DARR_Detail_ExEVD') is not null drop table sheiladb.dbo.DARR_Detail_ExEVD
select * into sheiladb.dbo.DARR_Detail_ExEVD from sheiladb.dbo.DARR_Final where rpt='EV' and caretype = 'urgent'
if object_id('sheiladb.dbo.DARR_Summary_StEVS') is not null drop table sheiladb.dbo.DARR_Summary_StEVS
select * into sheiladb.dbo.DARR_Summary_StEVS from sheiladb.dbo.DARR_SFinal where rpt='EV' and caretype = 'elective'
if object_id('sheiladb.dbo.DARR_Detail_StEVD') is not null drop table sheiladb.dbo.DARR_Detail_StEVD
select * into sheiladb.dbo.DARR_Detail_StEVD from sheiladb.dbo.DARR_Final where rpt='EV' and caretype = 'elective'

if object_id('sheiladb.dbo.DARR_Summary_ExAIS') is not null drop table sheiladb.dbo.DARR_Summary_ExAIS
select * into sheiladb.dbo.DARR_Summary_ExAIS from sheiladb.dbo.DARR_SFinal where rpt='AI' and caretype = 'urgent'
if object_id('sheiladb.dbo.DARR_Detail_ExAID') is not null drop table sheiladb.dbo.DARR_Detail_ExAID
select * into sheiladb.dbo.DARR_Detail_ExAID from sheiladb.dbo.DARR_Final where rpt='AI' and caretype = 'urgent'
if object_id('sheiladb.dbo.DARR_Summary_ExPAS') is not null drop table sheiladb.dbo.DARR_Summary_ExPAS
select * into sheiladb.dbo.DARR_Summary_ExPAS from sheiladb.dbo.DARR_SFinal where rpt = 'PA' and caretype = 'urgent'
if object_id('sheiladb.dbo.DARR_Detail_ExPAD') is not null drop table sheiladb.dbo.DARR_Detail_ExPAD
select * into sheiladb.dbo.DARR_Detail_ExPAD from sheiladb.dbo.DARR_Final where rpt = 'PA' and caretype = 'urgent'
if object_id('sheiladb.dbo.DARR_Summary_ExAPS') is not null drop table sheiladb.dbo.DARR_Summary_ExAPS
select * into sheiladb.dbo.DARR_Summary_ExAPS from sheiladb.dbo.DARR_SFinal where rpt in ('AI','PA') and caretype = 'urgent'
if object_id('sheiladb.dbo.DARR_Detail_ExAPD') is not null drop table sheiladb.dbo.DARR_Detail_ExAPD
select * into sheiladb.dbo.DARR_Detail_ExAPD from sheiladb.dbo.DARR_Final where rpt in ('AI','PA') and caretype = 'urgent'
if object_id('sheiladb.dbo.DARR_Summary_StAIS') is not null drop table sheiladb.dbo.DARR_Summary_StAIS
select * into sheiladb.dbo.DARR_Summary_StAIS from sheiladb.dbo.DARR_SFinal where rpt = 'AI' and caretype in ('routine','elective')
if object_id('sheiladb.dbo.DARR_Detail_StAID') is not null drop table sheiladb.dbo.DARR_Detail_StAID
select * into sheiladb.dbo.DARR_Detail_StAID from sheiladb.dbo.DARR_Final where rpt = 'AI' and caretype in ('routine','elective')
if object_id('sheiladb.dbo.DARR_Summary_StPAS') is not null drop table sheiladb.dbo.DARR_Summary_StPAS
select * into sheiladb.dbo.DARR_Summary_StPAS from sheiladb.dbo.DARR_SFinal where rpt = 'PA' and caretype in ('routine','elective')
if object_id('sheiladb.dbo.DARR_Detail_StPAD') is not null drop table sheiladb.dbo.DARR_Detail_StPAD
select * into sheiladb.dbo.DARR_Detail_StPAD from sheiladb.dbo.DARR_Final where rpt = 'PA' and caretype in ('routine','elective')
if object_id('sheiladb.dbo.DARR_Summary_StAPS') is not null drop table sheiladb.dbo.DARR_Summary_StAPS
select * into sheiladb.dbo.DARR_Summary_StAPS from sheiladb.dbo.DARR_SFinal where rpt in ('AI','PA') and caretype in ('routine','elective')
if object_id('sheiladb.dbo.DARR_Detail_StAPD') is not null drop table sheiladb.dbo.DARR_Detail_StAPD
select * into sheiladb.dbo.DARR_Detail_StAPD from sheiladb.dbo.DARR_Final where rpt in ('AI','PA') and caretype in ('routine','elective')
if object_id('sheiladb.dbo.DARR_Summary_IPS') is not null drop table sheiladb.dbo.DARR_Summary_IPS
select * into sheiladb.dbo.DARR_Summary_IPS from sheiladb.dbo.DARR_SFinal where rpt = 'IP' and caretype in ('emergency')
if object_id('sheiladb.dbo.DARR_Detail_IPD') is not null drop table sheiladb.dbo.DARR_Detail_IPD
select * into sheiladb.dbo.DARR_Detail_IPD from sheiladb.dbo.DARR_Final where rpt = 'IP' and caretype in ('emergency')
if object_id('sheiladb.dbo.DARR_Summary_RRS') is not null drop table sheiladb.dbo.DARR_Summary_RRS
select * into sheiladb.dbo.DARR_Summary_RRS from sheiladb.dbo.DARR_SFinal where rpt = 'RR'
if object_id('sheiladb.dbo.DARR_Detail_RRD') is not null drop table sheiladb.dbo.DARR_Detail_RRD
select * into sheiladb.dbo.DARR_Detail_RRD from sheiladb.dbo.DARR_Final where rpt = 'RR' 

-----copy to reportsdb....----....----
if object_id('reports.dbo.DARR_Final') is not null drop table reports.dbo.DARR_Final
select * into reports.dbo.DARR_Final from sheiladb.dbo.DARR_Final
if object_id('reports.dbo.DARR_SFinal') is not null drop table reports.dbo.DARR_SFinal
select * into reports.dbo.DARR_SFinal from sheiladb.dbo.DARR_SFinal

if object_id('reports.dbo.DARR_Summary_ExEVS') is not null drop table reports.dbo.DARR_Summary_ExEVS
select * into reports.dbo.DARR_Summary_ExEVS from sheiladb.dbo.DARR_Summary_ExEVS 
if object_id('reports.dbo.DARR_Detail_ExEVD') is not null drop table reports.dbo.DARR_Detail_ExEVD
select * into reports.dbo.DARR_Detail_ExEVD from sheiladb.dbo.DARR_Detail_ExEVD 
if object_id('reports.dbo.DARR_Summary_StEVS') is not null drop table reports.dbo.DARR_Summary_StEVS
select * into reports.dbo.DARR_Summary_StEVS from sheiladb.dbo.DARR_Summary_StEVS 
if object_id('reports.dbo.DARR_Detail_StEVD') is not null drop table reports.dbo.DARR_Detail_StEVD
select * into reports.dbo.DARR_Detail_StEVD from sheiladb.dbo.DARR_Detail_StEVD

if object_id('reports.dbo.DARR_Summary_ExAIS') is not null drop table reports.dbo.DARR_Summary_ExAIS
select * into reports.dbo.DARR_Summary_ExAIS from sheiladb.dbo.DARR_Summary_ExAIS
if object_id('reports.dbo.DARR_Detail_ExAID') is not null drop table reports.dbo.DARR_Detail_ExAID
select * into reports.dbo.DARR_Detail_ExAID from sheiladb.dbo.DARR_Detail_ExAID
if object_id('reports.dbo.DARR_Summary_ExPAS') is not null drop table reports.dbo.DARR_Summary_ExPAS
select * into reports.dbo.DARR_Summary_ExPAS from sheiladb.dbo.DARR_Summary_ExPAS 
if object_id('reports.dbo.DARR_Detail_ExPAD') is not null drop table reports.dbo.DARR_Detail_ExPAD
select * into reports.dbo.DARR_Detail_ExPAD from sheiladb.dbo.DARR_Detail_ExPAD 
if object_id('reports.dbo.DARR_Summary_ExAPS') is not null drop table reports.dbo.DARR_Summary_ExAPS
select * into reports.dbo.DARR_Summary_ExAPS from sheiladb.dbo.DARR_Summary_ExAPS 
if object_id('reports.dbo.DARR_Detail_ExAPD') is not null drop table reports.dbo.DARR_Detail_ExAPD
select * into reports.dbo.DARR_Detail_ExAPD from sheiladb.dbo.DARR_Detail_ExAPD
if object_id('reports.dbo.DARR_Summary_StAIS') is not null drop table reports.dbo.DARR_Summary_StAIS
select * into reports.dbo.DARR_Summary_StAIS from sheiladb.dbo.DARR_Summary_StAIS
if object_id('reports.dbo.DARR_Detail_StAID') is not null drop table reports.dbo.DARR_Detail_StAID
select * into reports.dbo.DARR_Detail_StAID from sheiladb.dbo.DARR_Detail_StAID
if object_id('reports.dbo.DARR_Summary_StPAS') is not null drop table reports.dbo.DARR_Summary_StPAS
select * into reports.dbo.DARR_Summary_StPAS from sheiladb.dbo.DARR_Summary_StPAS
if object_id('reports.dbo.DARR_Detail_StPAD') is not null drop table reports.dbo.DARR_Detail_StPAD
select * into reports.dbo.DARR_Detail_StPAD from sheiladb.dbo.DARR_Detail_StPAD
if object_id('reports.dbo.DARR_Summary_StAPS') is not null drop table reports.dbo.DARR_Summary_StAPS
select * into reports.dbo.DARR_Summary_StAPS from sheiladb.dbo.DARR_Summary_StAPS
if object_id('reports.dbo.DARR_Detail_StAPD') is not null drop table reports.dbo.DARR_Detail_StAPD
select * into reports.dbo.DARR_Detail_StAPD from sheiladb.dbo.DARR_Detail_StAPD
if object_id('reports.dbo.DARR_Summary_IPS') is not null drop table reports.dbo.DARR_Summary_IPS
select * into reports.dbo.DARR_Summary_IPS from sheiladb.dbo.DARR_Summary_IPS
if object_id('reports.dbo.DARR_Detail_IPD') is not null drop table reports.dbo.DARR_Detail_IPD
select * into reports.dbo.DARR_Detail_IPD from sheiladb.dbo.DARR_Detail_IPD
if object_id('reports.dbo.DARR_Summary_RRS') is not null drop table reports.dbo.DARR_Summary_RRS
select * into reports.dbo.DARR_Summary_RRS from sheiladb.dbo.DARR_Summary_RRS
if object_id('reports.dbo.DARR_Detail_RRD') is not null drop table reports.dbo.DARR_Detail_RRD
select * into reports.dbo.DARR_Detail_RRD from sheiladb.dbo.DARR_Detail_RRD

--TPL
if object_id('Reports.dbo.TPL') is not null drop table Reports.dbo.TPL
create table Reports.dbo.TPL 
(planname varchar(2) not null,dbname varchar(2) not null,LOB varchar(80) not null
,Member_Name varchar(60) not null, DOB varchar(10) not null
,Member_ID varchar(20) not null,Member_Address varchar(150) not null
,Member_Phone varchar(15) not null,Auth_ID varchar(20) not null,Auth_Template varchar(80) not null
,Care_Type varchar(9) not null,Member_Referred_To varchar(80) not null,Auth_Eff_Date varchar(10) not null
,Auth_Term_Date varchar(10) not null,Auth_Status varchar(9) not null,Admit_Date varchar(10) not null
,Discharge_Date varchar(10) not null,Dx_Code varchar(14) not null,Diagnosis varchar(100) not null
,Third_Party_Liability varchar(1) not null,Anchor_Date smalldatetime not null)

insert Reports.dbo.TPL
select distinct planname = isnull(case when mp.dbname is not null then mp.planname when r.dbname='UN' and bp.description like '%MHNY%' then 'NY'
when r.dbname='UN' and bp.description like '%MHID%' then 'ID' when r.dbname='UN' and bp.description like '%MHMS%' then 'MS' 
else r.dbname end,'')
,isnull(r.dbname,'')
,LOB = isnull(rtrim(bp.description),'')
,Member_Name = isnull(rtrim(ent.firstname) + ' ' + rtrim(ent.lastname),'')
,DOB = isnull(left(convert(varchar,m.dob,120),10),'')
,Member_ID = isnull( case when r.dbname = 'MA' then rtrim(m.headofhouse) else rtrim(ek.carriermemid) end,'')
,Member_Address = isnull(rtrim(ent.addr1) + ' ' + rtrim(ent.addr2) + ' ' + rtrim(ent.city) + ', ' + rtrim(ent.state) + ', ' + rtrim(ent.zip),'')
,Member_Phone = isnull(rtrim(ent.phone),'')
,Auth_ID = isnull(r.authorizationid,'')
,Auth_Template = isnull(rtrim(ac.description),'')
,Care_Type = isnull(r.acuity,'')
,Member_Referred_To = isnull(rtrim(p.fullname),'')
,Auth_Eff_Date = isnull(left(convert(varchar,r.effdate,120),10),'') 
,Auth_Term_Date = isnull(left(convert(varchar,r.termdate,120),10),'')
,Auth_Status = isnull(r.authstatus,'')
,Admit_Date = isnull(left(convert(varchar,r.admitdate,120),10),'')
,Discharge_Date = isnull(left(convert(varchar,r.admitdate,120),10),'')
,Dx_Code = isnull(ad.diagcode,'')
,Diagnosis = isnull(rtrim(dc.description),'')
,isnull(r.reinsurance,'') Third_Party_Liability
,Anchor_Date = cast(case when r.receiptdate = '2078-12-31' then r.createdate else r.receiptdate end as date)
from stage.dbo.referral r join stage.dbo.authcode ac on ac.codeid = r.servicecode and ac.dbname = r.dbname
join stage.dbo.enrollkeys ek on ek.enrollid = r.enrollid and r.dbname = ek.dbname and
	ek.segtype = 'int' and ek.effdate<ek.termdate
join stage.dbo.member m on m.memid = r.memid and m.dbname = r.dbname join stage.dbo.benefitplan bp on bp.planid = ek.planid and bp.dbname = r.dbname
join stage.dbo.authdiag ad on ad.referralid = r.referralid and ad.diagqualifier = 'PRINCIPAL' and ad.dbname = r.dbname
join stage.dbo.diagcode dc on ad.diagcode = dc.codeid and dc.dbname = r.dbname
join stage.dbo.entity ent on ent.entid = m.entityid and ent.dbname = r.dbname join stage.dbo.provider p on r.referto = p.provid and p.dbname = r.dbname
left join sheiladb.dbo.medicareplans mp on mp.dbname = r.dbname and mp.planid = ek.planid
where r.authstatus <> 'closed' and r.reinsurance = '1'

if object_id('SheilaDB.dbo.TPL') is not null drop table sheiladb.dbo.TPL
select * into sheiladb.dbo.TPL from reports.dbo.TPL

--CA IPR
if object_id('tempdb..#CA_IP1') is not null drop table #CA_IP1 --select distinct servicecode from #CA_IP1 where auth_category = ''
select distinct LOBName
,Auth_Category = case when c.proccat is not null and ac.authtype in ('Outpatient','Ancillary') then c.proccat else isnull(d.proccat,'') end
,a.servicecode, rtrim(ac.description) Auth_Template
,a.AuthorizationID,Auth_Status = authhstatus	,Create_By = rtrim(q1.firstname) + ' ' + rtrim(q1.lastname)
,Assigned_To = rtrim(q1.firstname) + ' ' + rtrim(q1.lastname),Care_Type = a.acuity2,a.referralid,a.dbname
,a.receiptdate,a.referraldate
into #CA_IP1 from stage.dbo.authdata a join stage.dbo.authcode ac on ac.codeid = a.servicecode and ac.dbname = a.dbname
left join stage.dbo.quser q1 on q1.userid = a.userid left join stage.dbo.quser q2 on q2.loginid = a.createid
left join (select distinct ra.referralid, ra.dbname from stage.dbo.referralattribute ra 
	join stage.dbo.qattribute q on q.attributeid = ra.attributeid and q.dbname = ra.dbname
	where description in ('Medical Claims Review','Provider Appeal','Claim Workflow','A&D Appeal','Pharmacy Team','CIRT SUCCESSFULL? Yes/No') and ra.dbname = 'ca')
	ra on ra.referralid = a.referralid and ra.dbname = a.dbname
left join (select row_number()over (partition by referralid, dbname order by sequence asc) rw, * from 
				(select distinct r.referralid, r.authorizationid, r.dbname, ProcCat, aus.sequence from stage.dbo.referral r 
				join stage.dbo.enrollkeys ek on ek.enrollid = r.enrollid and ek.dbname = r.dbname and ek.segtype = 'int' and ek.effdate < ek.termdate
				join sheiladb.dbo.medicareplans mp on mp.planid = ek.planid and mp.dbname = ek.dbname
				join stage.dbo.authservice aus on r.referralid = aus.referralid and r.dbname = aus.dbname join stage.dbo.authcode ac on ac.codeid = r.servicecode and ac.dbname = r.dbname
				join sheiladb.dbo.authtat_ai_category c on c.codeid = aus.codeid collate database_default and ac.authtype in ('Ancillary','Outpatient') and r.servicecode = '210' and mp.planname <>'FL'
				union select distinct r.referralid, r.authorizationid, r.dbname, category, aus.sequence from stage.dbo.referral r 
				join stage.dbo.enrollkeys ek on ek.enrollid = r.enrollid and ek.dbname = r.dbname and ek.segtype = 'int' and ek.effdate < ek.termdate
				join sheiladb.dbo.medicareplans mp on mp.planid = ek.planid and mp.dbname = ek.dbname
				join stage.dbo.authservice aus on r.referralid = aus.referralid and r.dbname = aus.dbname join stage.dbo.authcode ac on ac.codeid = r.servicecode and ac.dbname = r.dbname
				join sheiladb.dbo.ai_serv_groups c on c.catid = aus.catid collate DATABASE_default 
					and c.subcatid = aus.subcatid collate DATABASE_default and c.svcgroupid = aus.svcgroupid collate DATABASE_default and aus.codeid = '' and r.servicecode = '210' and mp.planname <>'FL') x)
				c on c.referralid = a.referralid and c.dbname = a.dbname and c.rw = '1'
left join sheiladb.dbo.Auth_Cat d on a.dbname = d.dbname and a.servicecode=d.codeid collate database_default
	and ac.authtype=d.authtype collate database_default	and ac.authcategory=d.authcategory collate database_default					
where a.dbname = 'CA' and a.authhstatus not in ('Closed','Void') and a.authdstatus not in ('closed','void') and a.LOBName <>'' and a.acuity2 = 'Emergency' 
and a.createid not like '%auth%' and a.createid not like '%auto%' and a.authorizationid not like '%APL' and ra.referralid is null
and (year(a.receiptdate) >= year(getdate())-1 or year(a.referraldate) >= year(getdate())-1)

if object_id('tempdb..#CA_IPdate1') is not null drop table #CA_IPdate1
select distinct a.authorizationid, thevalue, a.referralid, a.dbname, description, thegroup into #CA_IPdate1 from #CA_IP1 a 
left join (select ra.dbname, thevalue, description, thegroup, referralid from stage.dbo.referralattribute ra join stage.dbo.qattribute q on  q.attributeid = ra.attributeid and ra.dbname = q.dbname
			where description in ('Decision Date','Auth Receipt Date','Extension') ) ra on a.dbname = ra.dbname and a.referralid = ra.referralid
delete from #CA_IPdate1 where thevalue = ''  or thevalue='MM/DD/YYY' or thevalue like '%.%' or thevalue like '%:%' or thevalue like '%,%' or sheiladb.dbo.fn_IsDate(thevalue)=0
if object_id ('tempdb..#CA_IPtime1') is not null drop table #CA_IPtime1
select distinct a.DBname, case when len(ltrim(rtrim(thevalue))) =3 then '0' + CAST(ltrim(rtrim(thevalue)) as varchar) else ltrim(rtrim(thevalue)) end TheValue,a.referralid,a.authorizationid, description, thegroup 
into #CA_IPtime1 from stage.dbo.referralattribute ra join stage.dbo.qattribute q on q.attributeid = ra.attributeid and q.dbname = ra.dbname 
join #CA_IP1 a on a.dbname = ra.dbname and a.referralid = ra.referralid
			where q.description in ('Decision Time','Auth Receipt Time','Extension Time')and thevalue>'' and len(thevalue)=4 
			and thevalue not like '%:%' and thevalue not like '%.%' and thevalue not like '%/%' and thevalue not like '%,%'and ISNUMERIC(thevalue)=1 
if object_id ('tempdb..#CA_IPtime2') is not null drop table #CA_IPtime2 
select distinct DBname,ReferralID,authorizationid,TheValue,Description,TheGroup into #CA_IPtime2 from #CA_IPtime1 where left(TheValue,2) between 0 and 23 and right(thevalue,2) between 0 and 59

if object_id('tempdb..#CA_IPDatetime1') is not null drop table #CA_IPDatetime1
select distinct a.referralid, a.authorizationid,a.receiptdate,a.referraldate
, Auth_Receipt_Date = case when c.thevalue is null and a.receiptdate <> '2078-12-31' then cast(a.receiptdate as date)
when c.thevalue is null and a.receiptdate = '2078-12-31' then cast(a.referraldate as date) else cast(c.thevalue as date) end
, Auth_Receipt_Time = cast(left(f.thevalue,2)+':'+right(f.thevalue,2) as time)
, Decision_Date = cast(b.thevalue as date)
, Decision_Time = cast(left(e.thevalue,2)+':'+right(e.thevalue,2) as time), Extension_Date = cast(d.thevalue as date)
into #CA_IPDatetime1 from #CA_IP1 a left join #CA_IPdate1 b on a.referralid = b.referralid and a.authorizationid = b.authorizationid and b.description = 'Decision Date'
left join #CA_IPdate1 c on a.referralid = c.referralid and a.authorizationid = c.authorizationid and c.description = 'Auth Receipt Date'
left join #CA_IPdate1 d on a.referralid = d.referralid and a.authorizationid = d.authorizationid and d.description = 'Extension Date'
left join #CA_IPtime2 e on a.referralid = e.referralid and a.authorizationid = e.authorizationid and e.description = 'Decision Time'
left join #CA_IPtime2 f on a.referralid = f.referralid and a.authorizationid = f.authorizationid and f.description = 'Auth Receipt Time'

if object_id('tempdb..#CA_IPDatetime2') is not null drop table #CA_IPDatetime2
select referralid, authorizationid
, Auth_Receipt_Date= isnull(convert(varchar,min(Auth_Receipt_Date),120),'')
, Auth_Receipt_Time = isnull(convert(varchar,min(Auth_Receipt_Time),120),'')
, Decision_Date = isnull(convert(varchar,min(Decision_Date),120),'')
, Decision_Time = isnull(convert(varchar,min(Decision_Time),120),'')
, Extension_Date = isnull(convert(varchar,min(Extension_Date),120),'')
into #CA_IPDatetime2 from #CA_IPDatetime1 group by referralid, authorizationid

if object_id('sheiladb.dbo.CA_IPR_Final') is not null drop table sheiladb.dbo.CA_IPR_Final
	select a.*
	,b.Auth_Receipt_Date,b.Auth_Receipt_Time,b.Decision_Date,b.Decision_Time,b.Extension_Date
	,Anchor_Date = cast(c.Auth_Receipt_Date as datetime)
	,Createdate = getdate()
	into sheiladb.dbo.CA_IPR_Final
	from #CA_IP1 a 
	left join #CA_IPDatetime2 b on b.referralid = a.referralid
	left join #CA_IPDatetime1 c on c.referralid = a.referralid

if object_id('reports.dbo.CA_IPR_Final') is not null drop table reports.dbo.CA_IPR_Final
	select *
	into reports.dbo.CA_IPR_Final
	from sheiladb.dbo.CA_IPR_Final

